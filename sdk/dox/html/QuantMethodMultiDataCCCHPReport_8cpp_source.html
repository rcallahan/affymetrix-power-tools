<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Affymetrix Power Tools: chipstream/QuantMethodMultiDataCCCHPReport.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_f48957cb46a44244b1a86c58bd157ee8.html">chipstream</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>QuantMethodMultiDataCCCHPReport.cpp</h1>  </div>
</div>
<div class="contents">
<a href="QuantMethodMultiDataCCCHPReport_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">////////////////////////////////////////////////////////////////</span>
<a name="l00002"></a>00002 <span class="comment"></span><span class="comment">//</span>
<a name="l00003"></a>00003 <span class="comment">// Copyright (C) 2005 Affymetrix, Inc.</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">// This program is free software; you can redistribute it and/or modify </span>
<a name="l00006"></a>00006 <span class="comment">// it under the terms of the GNU General Public License (version 2) as </span>
<a name="l00007"></a>00007 <span class="comment">// published by the Free Software Foundation.</span>
<a name="l00008"></a>00008 <span class="comment">// </span>
<a name="l00009"></a>00009 <span class="comment">// This program is distributed in the hope that it will be useful, </span>
<a name="l00010"></a>00010 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of </span>
<a name="l00011"></a>00011 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU </span>
<a name="l00012"></a>00012 <span class="comment">// General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment">// </span>
<a name="l00014"></a>00014 <span class="comment">// You should have received a copy of the GNU General Public License </span>
<a name="l00015"></a>00015 <span class="comment">// along with this program;if not, write to the </span>
<a name="l00016"></a>00016 <span class="comment">// </span>
<a name="l00017"></a>00017 <span class="comment">// Free Software Foundation, Inc., </span>
<a name="l00018"></a>00018 <span class="comment">// 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00019"></a>00019 <span class="comment">//</span><span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">////////////////////////////////////////////////////////////////</span>
<a name="l00021"></a>00021 <span class="comment"></span><span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">/**</span>
<a name="l00023"></a>00023 <span class="comment"> * @file   QuantMethodMultiDataCCCHPReport.cpp</span>
<a name="l00024"></a>00024 <span class="comment"> * @author David Le</span>
<a name="l00025"></a>00025 <span class="comment"> * @date   Wed Mar 15 23:01:47 2006</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * @brief Reporter for genotyping probe sets that outputs CC CHP files. There is</span>
<a name="l00028"></a>00028 <span class="comment"> * one CC CHP file produced for each cel file and the order of the CC CHP file is</span>
<a name="l00029"></a>00029 <span class="comment"> * guaranteed to be the same as the cdf file. It is very important that the</span>
<a name="l00030"></a>00030 <span class="comment"> * number and order of the probeset results is the exact same as the CDF</span>
<a name="l00031"></a>00031 <span class="comment"> * file. There have been a number of high impact bugs on this front and it is</span>
<a name="l00032"></a>00032 <span class="comment"> * important to be very careful.</span>
<a name="l00033"></a>00033 <span class="comment"> */</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">//</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="QuantMethodMultiDataCCCHPReport_8h.html" title="Reporter for genotyping probe sets that outputs chp files. There is one CC CHP file produced for each...">chipstream/QuantMethodMultiDataCCCHPReport.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="comment">//</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="BioTypes_8h.html" title="Central location enumerations and other types that aren&amp;#39;t particular to a single class or applica...">chipstream/BioTypes.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;chipstream/ProbeListFactory.h&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="QuantBRLMM_8h.html">chipstream/QuantBRLMM.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="comment">//</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;calvin_files/data/src/CHPMultiDataData.h&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="FusionCELData_8h.html">calvin_files/fusion/src/FusionCELData.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="CHPMultiDataFileReader_8h.html">calvin_files/parsers/src/CHPMultiDataFileReader.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="GenericFileReader_8h.html">calvin_files/parsers/src/GenericFileReader.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="StringUtils_8h.html">calvin_files/utils/src/StringUtils.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="GenericDataHeaderUpdater_8h.html">calvin_files/writers/src/GenericDataHeaderUpdater.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="CHPFileData_8h.html">file/CHPFileData.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="affy-base-types_8h.html">portability/affy-base-types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="Fs_8h.html" title="///">util/Fs.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="Util_8h.html" title="General Utilities.">util/Util.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="comment">//</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;ctime&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="keyword">using namespace </span>std;
<a name="l00059"></a>00059 <span class="keyword">using namespace </span>affymetrix_calvin_data;
<a name="l00060"></a>00060 <span class="keyword">using namespace </span>affymetrix_calvin_io;
<a name="l00061"></a>00061 <span class="keyword">using namespace </span>affymetrix_fusion_io;
<a name="l00062"></a>00062 <span class="keyword">using namespace </span>affx;
<a name="l00063"></a>00063 <span class="comment"></span>
<a name="l00064"></a>00064 <span class="comment">/** Swap out the .cel for .chp */</span>
<a name="l00065"></a>00065 <span class="keywordtype">void</span> QuantMethodMultiDataCCCHPReport::setupFileNames(<span class="keyword">const</span> <a class="code" href="classIntensityMart.html" title="IntensityMart.">IntensityMart</a> &amp;iMart)
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067     m_CELFileNames = iMart.<a class="code" href="classIntensityMart.html#af0011c4c9839f7fc00afd415b55175a1" title="Get the names (cel files) for the various data that has been seen.">getCelFileNames</a>();
<a name="l00068"></a>00068     <span class="keywordflow">if</span> (m_CHPFileNames.size() == 0) {
<a name="l00069"></a>00069         m_CHPFileNames = <a class="code" href="classFs.html#a2d8dfd711dab201b56411373d7d91f65" title="replace the dir and ext for all these filenames /// For example a vector of chip files for output...">Fs::changeDirAndExt</a>(m_Prefix,m_CELFileNames,<span class="stringliteral">&quot;.&quot;</span>+m_Info.m_AlgName+<span class="stringliteral">&quot;.chp&quot;</span>);
<a name="l00070"></a>00070     }
<a name="l00071"></a>00071     <span class="keywordflow">if</span> (m_CHPFileNames.size() != iMart.<a class="code" href="classIntensityMart.html#af0011c4c9839f7fc00afd415b55175a1" title="Get the names (cel files) for the various data that has been seen.">getCelFileNames</a>().size()) 
<a name="l00072"></a>00072         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Must be same number of output CHP files (&quot;</span> + 
<a name="l00073"></a>00073                       <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(m_CHPFileNames.size()) + <span class="stringliteral">&quot;) as input CEL files (&quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(iMart.<a class="code" href="classIntensityMart.html#af0011c4c9839f7fc00afd415b55175a1" title="Get the names (cel files) for the various data that has been seen.">getCelFileNames</a>().size()));
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="keywordtype">void</span> QuantMethodMultiDataCCCHPReport::removeTmpChps() {
<a name="l00077"></a>00077     <span class="comment">// Remove any existing TMP CHP file</span>
<a name="l00078"></a>00078     std::vector&lt;std::string&gt; filesToRemove;
<a name="l00079"></a>00079     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> chip=0; chip&lt;m_CHPFileNames.size(); chip++) {
<a name="l00080"></a>00080         std::string tmpChpName = m_CHPFileNames[chip] + <span class="stringliteral">&quot;.tmp&quot;</span>;
<a name="l00081"></a>00081         filesToRemove.push_back(tmpChpName);
<a name="l00082"></a>00082     }
<a name="l00083"></a>00083     
<a name="l00084"></a>00084     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i &lt; filesToRemove.size();  i++ ) { 
<a name="l00085"></a>00085         <a class="code" href="classFs.html#a6b8f232817f933a42c21edde6ea55a3a" title="An error if it doesnt exist.">Fs::rm</a>(filesToRemove[i], <span class="keyword">false</span>);
<a name="l00086"></a>00086     }
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="keywordtype">void</span> QuantMethodMultiDataCCCHPReport::removeAllChps() {
<a name="l00090"></a>00090     <span class="comment">// Remove any existing CHP file</span>
<a name="l00091"></a>00091     std::vector&lt;std::string&gt; filesToRemove;
<a name="l00092"></a>00092     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> chip=0; chip&lt;m_CHPFileNames.size(); chip++) {
<a name="l00093"></a>00093         std::string chpName = m_CHPFileNames[chip];
<a name="l00094"></a>00094         filesToRemove.push_back(chpName);
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i &lt; filesToRemove.size();  i++ ) { 
<a name="l00097"></a>00097         <a class="code" href="classFs.html#a6b8f232817f933a42c21edde6ea55a3a" title="An error if it doesnt exist.">Fs::rm</a>(filesToRemove[i], <span class="keyword">false</span>);
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099     removeTmpChps();
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 <span class="comment"></span>
<a name="l00102"></a>00102 <span class="comment">/**</span>
<a name="l00103"></a>00103 <span class="comment"> * Get set up for a run of reporting probesets. Often used to open file</span>
<a name="l00104"></a>00104 <span class="comment"> * streams and print headers to files etc.</span>
<a name="l00105"></a>00105 <span class="comment"> *</span>
<a name="l00106"></a>00106 <span class="comment"> * @param qMethod - Quantification method to be used.</span>
<a name="l00107"></a>00107 <span class="comment"> *</span>
<a name="l00108"></a>00108 <span class="comment"> * @return true if success, false otherwise.</span>
<a name="l00109"></a>00109 <span class="comment"> */</span>
<a name="l00110"></a><a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a28d1771713f9359a7df91bf0ead41522">00110</a> <span class="keywordtype">bool</span> <a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a28d1771713f9359a7df91bf0ead41522" title="Get set up for a run of reporting probesets.">QuantMethodMultiDataCCCHPReport::prepare</a>(<a class="code" href="classQuantMethod.html" title="QuantMethod - Interface for computing quantification summaries from PM intensities grouped into probe...">QuantMethod</a> &amp;qMethod, <span class="keyword">const</span> <a class="code" href="classIntensityMart.html" title="IntensityMart.">IntensityMart</a> &amp;iMart)
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112     setupFileNames(iMart);
<a name="l00113"></a>00113     <span class="keywordtype">size_t</span> nfiles = m_CHPFileNames.size();
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="comment">// Make sure our output directory exists.</span>
<a name="l00116"></a>00116     <span class="keywordflow">if</span> (!Fs::isWriteableDir(m_Prefix.c_str()) &amp;&amp;
<a name="l00117"></a>00117         (<a class="code" href="classFs.html#aea474e8df7665f070c5334fa322bd283" title="make all path of directories ///">Fs::mkdirPath</a>(m_Prefix, <span class="keyword">false</span>) != APT_OK))  {
<a name="l00118"></a>00118         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Can&#39;t make or write to directory: &quot;</span> + m_Prefix);
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     removeAllChps();
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <span class="comment">// Get CEL file GUIDs</span>
<a name="l00124"></a>00124     m_celGuids.resize(nfiles);
<a name="l00125"></a>00125     std::string tmp_unc_name;
<a name="l00126"></a>00126     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> chip=0; chip&lt;nfiles; chip++) {
<a name="l00127"></a>00127         <a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html">FusionCELData</a> cel;
<a name="l00128"></a>00128         <span class="keywordflow">try</span> {
<a name="l00129"></a>00129             tmp_unc_name=Fs::convertToUncPath(m_CELFileNames[chip]);
<a name="l00130"></a>00130             cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#af43c5c7a95f9f535883c1ddda0bea057">SetFileName</a>(tmp_unc_name.c_str());
<a name="l00131"></a>00131             <span class="keywordflow">if</span> (!cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#aca791993ba594e5a424ece9cd0bfc54e">ReadHeader</a>()) {
<a name="l00132"></a>00132               <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to read CEL file: &quot;</span>+<a class="code" href="Fs_8h.html#a030c4dbb5947e49f3d303e8de0c63e17" title="Adds quotes to the path.">FS_QUOTE_PATH</a>(tmp_unc_name));
<a name="l00133"></a>00133             }
<a name="l00134"></a>00134             <a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html">GenericData</a> *gdata = cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a5fa95da46ae88e9ab8a85e69a73f198d">GetGenericData</a>();
<a name="l00135"></a>00135             <span class="keywordflow">if</span> (gdata != NULL)
<a name="l00136"></a>00136             {
<a name="l00137"></a>00137                 m_celGuids[chip] = gdata-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html#aa4dde02ef7050992a36bcd7c2c231c29">Header</a>().GetGenericDataHdr()-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html#a11f21dee83156bb33470bc9475ef78c0">GetFileId</a>();
<a name="l00138"></a>00138             }
<a name="l00139"></a>00139             cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#ae5e091bf0e0549f45f45ba55221fea31">Close</a>();
<a name="l00140"></a>00140         }
<a name="l00141"></a>00141         <span class="keywordflow">catch</span> (...)
<a name="l00142"></a>00142         {
<a name="l00143"></a>00143           <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to read CEL file: &quot;</span>+<a class="code" href="Fs_8h.html#a030c4dbb5947e49f3d303e8de0c63e17" title="Adds quotes to the path.">FS_QUOTE_PATH</a>(tmp_unc_name));
<a name="l00144"></a>00144         }
<a name="l00145"></a>00145     }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     <span class="keywordtype">int</span> maxProbeSetNameLength = m_Info.<a class="code" href="classAnalysisInfo.html#af50a44fcfb27fcf4aedbb5664857ff24" title="Length of the longest probeset name.">m_MaxPsNameLength</a>;
<a name="l00148"></a>00148     <a class="code" href="classProbeListPacked.html">ProbeListPacked</a> plp;
<a name="l00149"></a>00149     <span class="keywordflow">if</span> (genoTypeOnly == <span class="keyword">true</span>) {
<a name="l00150"></a>00150         nExpression = 0;
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;m_Info.<a class="code" href="classAnalysisInfo.html#a21ab2fbfe201742b20f48ac42a12a07e" title="Vector of probeset names and groups as they should appear in the chp file. /// this memory is owned e...">m_ProbesetNames</a>.size(); i++) {
<a name="l00153"></a>00153         maxProbeSetNameLength = <a class="code" href="affy-base-types_8h.html#a4886a8f966a69949cefc46a6a3468006">Max</a>(maxProbeSetNameLength,(<span class="keywordtype">int</span>)strlen(m_Info.<a class="code" href="classAnalysisInfo.html#a21ab2fbfe201742b20f48ac42a12a07e" title="Vector of probeset names and groups as they should appear in the chp file. /// this memory is owned e...">m_ProbesetNames</a>.at(i)));
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156         <span class="comment">//If cdf says expression OR cdf says genotyping but probeset has only one block</span>
<a name="l00157"></a>00157         <span class="comment">//&gt;             Analyze as expression</span>
<a name="l00158"></a>00158         <span class="comment">//&gt; Else if cdf says one of many genotyping types</span>
<a name="l00159"></a>00159         <span class="comment">//&gt;             Analyze as genotyping</span>
<a name="l00160"></a>00160         <span class="comment">//&gt; Else ignore</span>
<a name="l00161"></a>00161 <span class="comment"></span>
<a name="l00162"></a>00162 <span class="comment">        ///@todo find a better way to get probeset type and allele</span>
<a name="l00163"></a>00163 <span class="comment">        ///count than to directly access ProbeListPacked object in</span>
<a name="l00164"></a>00164 <span class="comment">        ///ChipLayout</span>
<a name="l00165"></a>00165 <span class="comment"></span>        <span class="comment">// plp = layout.m_PlFactory.getProbeListByName(m_Info.m_ProbesetNames.at(i));</span>
<a name="l00166"></a>00166 <span class="comment">//         if (plp.isNull()) {</span>
<a name="l00167"></a>00167 <span class="comment">//             APT_ERR_ABORT(&quot;psIndex: &#39;&quot;+ ToStr(i) +&quot;&#39; into ProbeListPacked list is out of range.&quot;);</span>
<a name="l00168"></a>00168 <span class="comment">//         }</span>
<a name="l00169"></a>00169 <span class="comment">//         int block_count = plp.block_cnt();        </span>
<a name="l00170"></a>00170 <span class="comment">//         ProbeSet::ProbeSetType ps_type=(ProbeSet::ProbeSetType)plp.get_type();</span>
<a name="l00171"></a>00171 <span class="comment">//         if (genoTypeOnly == false &amp;&amp; </span>
<a name="l00172"></a>00172 <span class="comment">//             (ps_type == ProbeSet::Expression ||</span>
<a name="l00173"></a>00173 <span class="comment">//              (ps_type == ProbeSet::GenoType &amp;&amp; block_count != 2 &amp;&amp; block_count != 4)</span>
<a name="l00174"></a>00174 <span class="comment">//              )</span>
<a name="l00175"></a>00175 <span class="comment">//             ) {</span>
<a name="l00176"></a>00176 <span class="comment">//             ++nExpression;</span>
<a name="l00177"></a>00177 <span class="comment">//         }</span>
<a name="l00178"></a>00178 <span class="comment">//         else if (block_count &gt; 1) {</span>
<a name="l00179"></a>00179 <span class="comment">//             int first_allele = plp.get_blockAllele(0);</span>
<a name="l00180"></a>00180 <span class="comment">//             bool more_than_one_allele = false;</span>
<a name="l00181"></a>00181 <span class="comment">//             for (int i = 1; i &lt; block_count; i++) {</span>
<a name="l00182"></a>00182 <span class="comment">//                 if (plp.get_blockAllele(i) != first_allele) {</span>
<a name="l00183"></a>00183 <span class="comment">//                     more_than_one_allele = true;</span>
<a name="l00184"></a>00184 <span class="comment">//                     break;</span>
<a name="l00185"></a>00185 <span class="comment">//                 }</span>
<a name="l00186"></a>00186 <span class="comment">//             }</span>
<a name="l00187"></a>00187 <span class="comment">//             if (more_than_one_allele &amp;&amp; </span>
<a name="l00188"></a>00188 <span class="comment">//                 (ps_type == ProbeSet::GenoType || </span>
<a name="l00189"></a>00189 <span class="comment">//                  ps_type == ProbeSet::Marker || </span>
<a name="l00190"></a>00190 <span class="comment">//                  ps_type == ProbeSet::MultichannelMarker)) {</span>
<a name="l00191"></a>00191 <span class="comment">//               ++nGenotype;</span>
<a name="l00192"></a>00192 <span class="comment">//             }</span>
<a name="l00193"></a>00193 <span class="comment">//         }</span>
<a name="l00194"></a>00194 <span class="comment">//    }</span>
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <span class="comment">// Prepare headers for all CHP files.</span>
<a name="l00197"></a>00197     wstring algName = StringUtils::ConvertMBSToWCS(m_Info.<a class="code" href="classAnalysisInfo.html#a4e52df55ab7398557852b211c5a50d41" title="What algorithm are we reporting.">m_AlgName</a>);
<a name="l00198"></a>00198     wstring algVersion = StringUtils::ConvertMBSToWCS(m_Info.<a class="code" href="classAnalysisInfo.html#a485fade346a6f248b915cbd0a6e1041c" title="What version of the algorithm is being used.">m_AlgVersion</a>);
<a name="l00199"></a>00199     wstring chipType = StringUtils::ConvertMBSToWCS(m_Info.<a class="code" href="classAnalysisInfo.html#a89c1bfe7a31fccc70d06cb42f68c435e" title="What chip is this?">m_ChipType</a>);
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="comment">// Create columns for the force, signals a and b.</span>
<a name="l00202"></a>00202     vector&lt;ColumnInfo&gt; extraColumns;
<a name="l00203"></a>00203     <span class="keywordflow">if</span> (nGenotype &gt; 0) {
<a name="l00204"></a>00204         <a class="code" href="classQuantGTypeMethod.html" title="Quantification methods used for making genotyping calls implement (currently just brlmm) this interfa...">QuantGTypeMethod</a> *gMethod = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuantGTypeMethod.html" title="Quantification methods used for making genotyping calls implement (currently just brlmm) this interfa...">QuantGTypeMethod</a> *<span class="keyword">&gt;</span>(&amp;qMethod);
<a name="l00205"></a>00205         <span class="keywordflow">if</span> (gMethod == NULL) { <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Can only use a QuantMethodGTypeReport with a QuantGTypeMethod.&quot;</span>); }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207         <a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html">ParameterNameValueType</a> nv;
<a name="l00208"></a>00208         <span class="keywordtype">string</span> aName;
<a name="l00209"></a>00209         <span class="keywordtype">string</span> bName;
<a name="l00210"></a>00210         gMethod-&gt;<a class="code" href="classQuantGTypeMethod.html#acf5e5d8cca1b619863d4a7fea5750b1b" title="Get the summary value names for the A and B alleles respectively.">getAlleleValueNames</a>(aName, bName);
<a name="l00211"></a>00211         <a class="code" href="classaffymetrix__calvin__io_1_1FloatColumn.html">FloatColumn</a> contrastCol(StringUtils::ConvertMBSToWCS(aName));
<a name="l00212"></a>00212         extraColumns.push_back(contrastCol);
<a name="l00213"></a>00213         <a class="code" href="classaffymetrix__calvin__io_1_1FloatColumn.html">FloatColumn</a> strengthCol(StringUtils::ConvertMBSToWCS(bName));
<a name="l00214"></a>00214         extraColumns.push_back(strengthCol);
<a name="l00215"></a>00215         <a class="code" href="classaffymetrix__calvin__io_1_1UByteColumn.html">UByteColumn</a> forcedCol(L<span class="stringliteral">&quot;Forced Call&quot;</span>);
<a name="l00216"></a>00216         extraColumns.push_back(forcedCol);
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     <span class="comment">// For each chip, precreate all probeset signal entries (default to 0.0).</span>
<a name="l00220"></a>00220     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1,<span class="stringliteral">&quot;QuantMethodMultiDataCCCHPReport Creating temporary files for CHP output&quot;</span>);
<a name="l00221"></a>00221     std::string tmp_chp_name;
<a name="l00222"></a>00222     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;nfiles; i++)
<a name="l00223"></a>00223     {
<a name="l00224"></a>00224         <span class="keywordflow">try</span>
<a name="l00225"></a>00225         {
<a name="l00226"></a>00226             <a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html">ParameterNameValueType</a> param;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228             <span class="comment">// Create tmp chp file</span>
<a name="l00229"></a>00229             std::string tmp_chp_name=m_CHPFileNames[i] + <span class="stringliteral">&quot;.tmp&quot;</span>;
<a name="l00230"></a>00230             <a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html">CHPMultiDataData</a> *data = <span class="keyword">new</span> <a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html">CHPMultiDataData</a>(tmp_chp_name);
<a name="l00231"></a>00231             m_TmpChpFiles.push_back(tmp_chp_name);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233             <span class="comment">// set parent header</span>
<a name="l00234"></a>00234             <a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html">FusionCELData</a> cel;
<a name="l00235"></a>00235             <span class="keywordflow">try</span> {
<a name="l00236"></a>00236                 std::string tmp_unc_name=Fs::convertToUncPath(m_CELFileNames[i]);
<a name="l00237"></a>00237                 cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#af43c5c7a95f9f535883c1ddda0bea057">SetFileName</a>(tmp_unc_name.c_str());
<a name="l00238"></a>00238                 <span class="keywordflow">if</span> (!cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#aca791993ba594e5a424ece9cd0bfc54e">ReadHeader</a>()) {
<a name="l00239"></a>00239                     <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to read CEL file: &quot;</span>+<a class="code" href="Fs_8h.html#a030c4dbb5947e49f3d303e8de0c63e17" title="Adds quotes to the path.">FS_QUOTE_PATH</a>(tmp_unc_name));
<a name="l00240"></a>00240                 }
<a name="l00241"></a>00241                 <a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html">GenericData</a> *gdata = cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a5fa95da46ae88e9ab8a85e69a73f198d">GetGenericData</a>();
<a name="l00242"></a>00242                 <span class="keywordflow">if</span> (gdata != NULL)
<a name="l00243"></a>00243                 {
<a name="l00244"></a>00244                     data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#a9cd1af909c16df6a06f6009a9888f426">GetFileHeader</a>()-&gt;GetGenericDataHdr()-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html#a41928b79b637a88f915516fbf206c587">AddParent</a>(*gdata-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html#aa4dde02ef7050992a36bcd7c2c231c29">Header</a>().GetGenericDataHdr());
<a name="l00245"></a>00245                 }
<a name="l00246"></a>00246                 cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#ae5e091bf0e0549f45f45ba55221fea31">Close</a>();
<a name="l00247"></a>00247             }
<a name="l00248"></a>00248             <span class="keywordflow">catch</span> (...)
<a name="l00249"></a>00249             {
<a name="l00250"></a>00250               <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to read CEL file: &quot;</span>+<a class="code" href="Fs_8h.html#a030c4dbb5947e49f3d303e8de0c63e17" title="Adds quotes to the path.">FS_QUOTE_PATH</a>(tmp_unc_name));
<a name="l00251"></a>00251             }
<a name="l00252"></a>00252             <span class="keywordflow">if</span> (nGenotype &gt; 0) {
<a name="l00253"></a>00253               <span class="keywordtype">int</span> entryCount = nGenotype;
<a name="l00254"></a>00254               <span class="keywordflow">if</span> (nReporting &gt; 0) {
<a name="l00255"></a>00255                 entryCount = nReporting;
<a name="l00256"></a>00256               }
<a name="l00257"></a>00257               data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#a0748e6569c015dafb0ecee6493be843e">SetEntryCount</a>(GenotypeMultiDataType, entryCount, maxProbeSetNameLength, extraColumns);
<a name="l00258"></a>00258             }
<a name="l00259"></a>00259             <span class="keywordflow">if</span> (nExpression &gt; 0)
<a name="l00260"></a>00260                 data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#a0748e6569c015dafb0ecee6493be843e">SetEntryCount</a>(ExpressionMultiDataType, nExpression, maxProbeSetNameLength);
<a name="l00261"></a>00261             data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#a9fd4c6f3eedfa8652c7052678ba7fd02">SetAlgName</a>(algName);
<a name="l00262"></a>00262             data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#a9323519674e23adcc719174acce3c649">SetAlgVersion</a>(algVersion);
<a name="l00263"></a>00263             data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#a61fd501b8e4d8e3e240c125b92e84545">SetArrayType</a>(chipType);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265             param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(L<span class="stringliteral">&quot;program-name&quot;</span>);
<a name="l00266"></a>00266             param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(m_Info.<a class="code" href="classAnalysisInfo.html#a2cc9986186213673fb4ca8decc70124e" title="What is the name of the program.">m_ProgramName</a>));
<a name="l00267"></a>00267             data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#a23c5338c17c342b7731a08728f7d6315">GetGenericData</a>().<a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html#aa4dde02ef7050992a36bcd7c2c231c29">Header</a>().GetGenericDataHdr()-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html#aaef03a3208142900da10c77e3d46936f">AddNameValParam</a>(param);
<a name="l00268"></a>00268             param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(L<span class="stringliteral">&quot;program-version&quot;</span>);
<a name="l00269"></a>00269             param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(m_Info.<a class="code" href="classAnalysisInfo.html#a705a56532115d0c0c8f10644e633b64d" title="What program created this chp file.">m_ProgramVersion</a>));
<a name="l00270"></a>00270             data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#a23c5338c17c342b7731a08728f7d6315">GetGenericData</a>().<a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html#aa4dde02ef7050992a36bcd7c2c231c29">Header</a>().GetGenericDataHdr()-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html#aaef03a3208142900da10c77e3d46936f">AddNameValParam</a>(param);
<a name="l00271"></a>00271             param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(L<span class="stringliteral">&quot;program-company&quot;</span>);
<a name="l00272"></a>00272             param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(m_Info.<a class="code" href="classAnalysisInfo.html#aa1f9eedaa9c2024dfde2af6a71155bb1" title="What company created this chp file.">m_ProgramCompany</a>));
<a name="l00273"></a>00273             data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#a23c5338c17c342b7731a08728f7d6315">GetGenericData</a>().<a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html#aa4dde02ef7050992a36bcd7c2c231c29">Header</a>().GetGenericDataHdr()-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html#aaef03a3208142900da10c77e3d46936f">AddNameValParam</a>(param);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275             <span class="comment">// Add algorithm parameters to list.</span>
<a name="l00276"></a>00276             ParameterNameValueTypeList paramList;
<a name="l00277"></a>00277             assert(m_Info.<a class="code" href="classAnalysisInfo.html#ad48864dcd9e2e22d9d74dfbbb00fff04" title="These next two vectors are matched pairs, one contains the /// keys and the other the values...">m_ParamNames</a>.size() == m_Info.m_ParamValues.size());
<a name="l00278"></a>00278             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;m_Info.<a class="code" href="classAnalysisInfo.html#ad48864dcd9e2e22d9d74dfbbb00fff04" title="These next two vectors are matched pairs, one contains the /// keys and the other the values...">m_ParamNames</a>.size(); i++) 
<a name="l00279"></a>00279             {
<a name="l00280"></a>00280                 <span class="comment">// reasons not to add this param...</span>
<a name="l00281"></a>00281                 <span class="comment">// ...no value for this name.</span>
<a name="l00282"></a>00282                 <span class="keywordflow">if</span> (m_Info.m_ParamValues[i].length()==0) {
<a name="l00283"></a>00283                     <span class="keywordflow">continue</span>;
<a name="l00284"></a>00284                 }
<a name="l00285"></a>00285                 <span class="comment">// ...is it in the set of CHP supressed headers?</span>
<a name="l00286"></a>00286                 <span class="keywordflow">if</span> ((<a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a79755164d2b7e62b9746f99c1948ec43" title="put the &amp;quot;chip-view-md5sum&amp;quot; in the header? /// this is because we need to supress it for leg...">m_output_chip_view_md5sum</a>==<span class="keyword">true</span>) &amp;&amp;
<a name="l00287"></a>00287                     (m_Info.<a class="code" href="classAnalysisInfo.html#ad48864dcd9e2e22d9d74dfbbb00fff04" title="These next two vectors are matched pairs, one contains the /// keys and the other the values...">m_ParamNames</a>[i].find(<span class="stringliteral">&quot;chip-view-md5sum&quot;</span>)!=std::string::npos)) {
<a name="l00288"></a>00288                     <span class="keywordflow">continue</span>;
<a name="l00289"></a>00289                 }
<a name="l00290"></a>00290                 <span class="comment">// add it.</span>
<a name="l00291"></a>00291                 param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(StringUtils::ConvertMBSToWCS(m_Info.<a class="code" href="classAnalysisInfo.html#ad48864dcd9e2e22d9d74dfbbb00fff04" title="These next two vectors are matched pairs, one contains the /// keys and the other the values...">m_ParamNames</a>[i]));
<a name="l00292"></a>00292                 param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(m_Info.m_ParamValues[i]));
<a name="l00293"></a>00293                 paramList.push_back(param);
<a name="l00294"></a>00294             }
<a name="l00295"></a>00295             
<a name="l00296"></a>00296             <span class="comment">// Add list of all CEL GUIDs in batch</span><span class="comment"></span>
<a name="l00297"></a>00297 <span class="comment">            ///@todo This be computed by the engine and passed in via AnalysisInfo</span>
<a name="l00298"></a>00298 <span class="comment"></span>            <span class="keywordtype">string</span> prefix = <span class="stringliteral">&quot;apt-opt-&quot;</span>;
<a name="l00299"></a>00299             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> chip=0; chip&lt;m_CHPFileNames.size(); chip++)
<a name="l00300"></a>00300             {
<a name="l00301"></a>00301                 <span class="keywordflow">if</span> (m_celGuids[chip].empty() == <span class="keyword">false</span>)
<a name="l00302"></a>00302                 {
<a name="l00303"></a>00303                     <span class="keywordtype">string</span> paramName = prefix + <span class="stringliteral">&quot;cel-guid-&quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(chip+1);
<a name="l00304"></a>00304                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(StringUtils::ConvertMBSToWCS(paramName));
<a name="l00305"></a>00305                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(m_celGuids[chip]));
<a name="l00306"></a>00306                     paramList.push_back(param);
<a name="l00307"></a>00307                 }
<a name="l00308"></a>00308             }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310             data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#abb89c469a337dac6bae9c8cde64c9845">AddAlgParams</a>(paramList);
<a name="l00311"></a>00311 <span class="comment"></span>
<a name="l00312"></a>00312 <span class="comment">            ///@todo This be computed by the engine and passed in via AnalysisInfo                                                          </span>
<a name="l00313"></a>00313 <span class="comment"></span>
<a name="l00314"></a>00314             <span class="comment">// Add client meta data information to list                                                                                                 </span>
<a name="l00315"></a>00315             ParameterNameValueTypeList appMetaInfoList;
<a name="l00316"></a>00316             assert(m_Info.<a class="code" href="classAnalysisInfo.html#ac8ac9d2dfbbcfc1f4f94abba513bcc94" title="Two vectors for client supplied meta-data. Matched pairs of vectors, one contains the /// keys and th...">m_ClientInfoNames</a>.size() == m_Info.m_ClientInfoValues.size());
<a name="l00317"></a>00317             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;m_Info.<a class="code" href="classAnalysisInfo.html#ac8ac9d2dfbbcfc1f4f94abba513bcc94" title="Two vectors for client supplied meta-data. Matched pairs of vectors, one contains the /// keys and th...">m_ClientInfoNames</a>.size(); i++)
<a name="l00318"></a>00318             {
<a name="l00319"></a>00319                 <span class="keywordflow">if</span> (m_Info.m_ClientInfoValues[i].length() &gt; 0)
<a name="l00320"></a>00320                 {
<a name="l00321"></a>00321                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(StringUtils::ConvertMBSToWCS(m_Info.<a class="code" href="classAnalysisInfo.html#ac8ac9d2dfbbcfc1f4f94abba513bcc94" title="Two vectors for client supplied meta-data. Matched pairs of vectors, one contains the /// keys and th...">m_ClientInfoNames</a>[i]));
<a name="l00322"></a>00322                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(m_Info.m_ClientInfoValues[i]));
<a name="l00323"></a>00323                     appMetaInfoList.push_back(param);
<a name="l00324"></a>00324                     <span class="comment">//                    appMetaInfoList.push_back(param);</span>
<a name="l00325"></a>00325                 }
<a name="l00326"></a>00326             }
<a name="l00327"></a>00327             data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#ab1af82a60de0e1dade825b60517fb688">AddAppMetaInfo</a>(appMetaInfoList);
<a name="l00328"></a>00328             
<a name="l00329"></a>00329             ParameterNameValueTypeList summaryParamList;
<a name="l00330"></a>00330             std::string blankStr(256, <span class="charliteral">&#39; &#39;</span>);
<a name="l00331"></a>00331             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> source = 0; source &lt; m_ChipSummaries.size(); source++) {
<a name="l00332"></a>00332                 ChipSummary::metricDefVec_t metricDefs = m_ChipSummaries[source]-&gt;getMetricDefs();
<a name="l00333"></a>00333                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; metricDefs.size(); i++) {
<a name="l00334"></a>00334                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(StringUtils::ConvertMBSToWCS(metricDefs[i].m_name));
<a name="l00335"></a>00335                     <span class="keywordflow">if</span> (metricDefs[i].m_type == ChipSummary::Metric::Double) {
<a name="l00336"></a>00336                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a17601dadaa07e7a1d955108df7fee9af">SetValueFloat</a>(-1.0);
<a name="l00337"></a>00337                     } 
<a name="l00338"></a>00338                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (metricDefs[i].m_type == ChipSummary::Metric::Integer) {
<a name="l00339"></a>00339                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ab6641303770a83bf5aebf22b47cbac5e">SetValueInt32</a>(-1);
<a name="l00340"></a>00340                     } 
<a name="l00341"></a>00341                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (metricDefs[i].m_type == ChipSummary::Metric::String) {
<a name="l00342"></a>00342                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a5cb4644ca145eab52f8fa6f78123f818">SetValueAscii</a>(blankStr);
<a name="l00343"></a>00343                     } 
<a name="l00344"></a>00344                     <span class="keywordflow">else</span> {
<a name="l00345"></a>00345                         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;QuantMethodMultiDataCCCHPReport: Unable to handle unknown type: &quot;</span> +
<a name="l00346"></a>00346                                       <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(metricDefs[i].m_type) );
<a name="l00347"></a>00347                     }
<a name="l00348"></a>00348                     summaryParamList.push_back(param);
<a name="l00349"></a>00349                 }
<a name="l00350"></a>00350             }
<a name="l00351"></a>00351             data-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html#ab8eb3690c1bdaa5658df2c6def4a29a4">AddSummaryParams</a>(summaryParamList);
<a name="l00352"></a>00352             
<a name="l00353"></a>00353             <a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataFileWriter.html">CHPMultiDataFileWriter</a> writer(*data);
<a name="l00354"></a>00354             <span class="keyword">delete</span> data;
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356         <span class="keywordflow">catch</span> (...)
<a name="l00357"></a>00357         {
<a name="l00358"></a>00358             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;QuantMethodMultiDataCHPReport::prepare() - Unable to write header and/or precreate signal entries to file: &quot;</span> + m_CHPFileNames[i] + <span class="stringliteral">&quot;.tmp&quot;</span>);
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362     <span class="comment">// Initialize genotype entry buffer writer.</span>
<a name="l00363"></a>00363     std::vector&lt;MultiDataType&gt; dataTypes;
<a name="l00364"></a>00364     std::map&lt;MultiDataType, int&gt; maxLen;
<a name="l00365"></a>00365     <span class="keywordflow">if</span> (nGenotype &gt; 0)
<a name="l00366"></a>00366     {
<a name="l00367"></a>00367         dataTypes.push_back(GenotypeMultiDataType);
<a name="l00368"></a>00368         maxLen[GenotypeMultiDataType] = maxProbeSetNameLength;
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370     <span class="keywordflow">if</span> (nExpression &gt; 0)
<a name="l00371"></a>00371     {
<a name="l00372"></a>00372         dataTypes.push_back(ExpressionMultiDataType);
<a name="l00373"></a>00373         maxLen[ExpressionMultiDataType] = maxProbeSetNameLength;
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375     m_GenotypeEntryBufferWriter.<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataFileBufferWriter.html#ae7ddbdf4ffa4209fe18dfcc66c3fdede">Initialize</a>(&amp;m_TmpChpFiles, dataTypes, maxLen);
<a name="l00376"></a>00376     <span class="keywordtype">int</span> buffer_flush_limit = 2*MAX_BUFFER_SIZE;
<a name="l00377"></a>00377     <span class="comment">// 2**17 == 131072 -- a power of 2 close to 100k</span>
<a name="l00378"></a>00378     <span class="keywordflow">if</span> (131072 * nfiles &gt; buffer_flush_limit) {
<a name="l00379"></a>00379         buffer_flush_limit = 131072 * nfiles;
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381     m_GenotypeEntryBufferWriter.<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataFileBufferWriter.html#a49f5e922d43185c85ce2f360a8097885">SetMaxBufferSize</a>(buffer_flush_limit);
<a name="l00382"></a>00382     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 <span class="comment"></span>
<a name="l00385"></a>00385 <span class="comment">/**</span>
<a name="l00386"></a>00386 <span class="comment"> * After every probeset computation this function is called an is an opportunity</span>
<a name="l00387"></a>00387 <span class="comment"> * to query the quantification method for results, residuals, etc.</span>
<a name="l00388"></a>00388 <span class="comment"> *</span>
<a name="l00389"></a>00389 <span class="comment"> * @param psGroup - List of probesets from which probes were used.</span>
<a name="l00390"></a>00390 <span class="comment"> * @param qMethod - Quantification method with compute method called.</span>
<a name="l00391"></a>00391 <span class="comment"> *</span>
<a name="l00392"></a>00392 <span class="comment"> * @return true if success, false otherwise.</span>
<a name="l00393"></a>00393 <span class="comment"> */</span>
<a name="l00394"></a><a class="code" href="classQuantMethodMultiDataCCCHPReport.html#aaddf295425219904eeff4fd189c0522c">00394</a> <span class="keywordtype">bool</span> <a class="code" href="classQuantMethodMultiDataCCCHPReport.html#aaddf295425219904eeff4fd189c0522c" title="After every probeset computation this function is called an is an opportunity to query the quantifica...">QuantMethodMultiDataCCCHPReport::report</a>(<a class="code" href="classProbeSetGroup.html" title="Group of probe sets that should be processed as a single large probe set.">ProbeSetGroup</a> &amp;psGroup, 
<a name="l00395"></a>00395                                              <a class="code" href="classQuantMethod.html" title="QuantMethod - Interface for computing quantification summaries from PM intensities grouped into probe...">QuantMethod</a> &amp;qMethod,
<a name="l00396"></a>00396                                              <span class="keyword">const</span> <a class="code" href="classIntensityMart.html" title="IntensityMart.">IntensityMart</a> &amp;iMart,
<a name="l00397"></a>00397                                              std::vector&lt;ChipStream *&gt; &amp;iTrans,
<a name="l00398"></a>00398                                              <a class="code" href="classPmAdjuster.html" title="Interface for determining a change based on intensity of perfect match.">PmAdjuster</a> &amp;pmAdjust)
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400     <a class="code" href="classQuantGTypeMethod.html" title="Quantification methods used for making genotyping calls implement (currently just brlmm) this interfa...">QuantGTypeMethod</a> *gMethod = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuantGTypeMethod.html" title="Quantification methods used for making genotyping calls implement (currently just brlmm) this interfa...">QuantGTypeMethod</a> *<span class="keyword">&gt;</span>(&amp;qMethod);
<a name="l00401"></a>00401     <a class="code" href="classQuantExprMethod.html" title="QuantExprMethod - Interface for computing quantification summaries from PM intensities grouped into p...">QuantExprMethod</a> *eMethod = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuantExprMethod.html" title="QuantExprMethod - Interface for computing quantification summaries from PM intensities grouped into p...">QuantExprMethod</a> *<span class="keyword">&gt;</span>(&amp;qMethod);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     assert(psGroup.<a class="code" href="classProbeSetGroup.html#aa197d2e48f3c2e8ae67cc8f5d54735ac" title="Vector of probe set pointers.">probeSets</a>.size() &gt; 0 &amp;&amp; psGroup.<a class="code" href="classProbeSetGroup.html#aa197d2e48f3c2e8ae67cc8f5d54735ac" title="Vector of probe set pointers.">probeSets</a>[0]);
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     <span class="keywordflow">if</span> (m_ProbeSetsToReport != NULL) {
<a name="l00406"></a>00406         <span class="keywordflow">if</span> (m_ProbeSetsToReport-&gt;find(psGroup.<a class="code" href="classProbeSetGroup.html#a0eb8ea2dfda45864880e0495539753db" title="Name of probe set group.">name</a>)==m_ProbeSetsToReport-&gt;end()) {
<a name="l00407"></a>00407             <span class="comment">// @todo: should this return true or false?</span>
<a name="l00408"></a>00408             m_ProcessedProbeSetCount++;
<a name="l00409"></a>00409             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00410"></a>00410         }
<a name="l00411"></a>00411     }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="comment">//checkCurrentId(psGroup); we are rewriting things, so skip overhead</span>
<a name="l00414"></a>00414     <span class="comment">// Create an expression CHP entry from analysis results.</span>
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <span class="keyword">const</span> <a class="code" href="classProbeSet.html#a052c4bdaa64d04532332b533bc36d634" title="What sort of probeset is this?">ProbeSet::ProbeSetType</a> psType = psGroup.<a class="code" href="classProbeSetGroup.html#aa197d2e48f3c2e8ae67cc8f5d54735ac" title="Vector of probe set pointers.">probeSets</a>[0]-&gt;psType;
<a name="l00417"></a>00417     <span class="keywordflow">if</span> (psType == ProbeSet::Expression &amp;&amp; nExpression &gt; 0)
<a name="l00418"></a>00418     {
<a name="l00419"></a>00419         <span class="keywordtype">int</span> nChips = 0;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         <span class="keywordflow">if</span> (gMethod != NULL) {
<a name="l00422"></a>00422             nChips = gMethod-&gt;<a class="code" href="classQuantGTypeMethod.html#aa02713a7902dd54cc6edc3a51c62b3b1" title="How many genotyping calls do we have? Also indicates how many samples there are.">getNumCalls</a>();
<a name="l00423"></a>00423         } 
<a name="l00424"></a>00424         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eMethod != NULL) {
<a name="l00425"></a>00425             nChips = eMethod-&gt;<a class="code" href="classQuantExprMethod.html#ac2900783138ce00c4712bd634c72fbd2" title="Return number of targets (experiments or chips).">getNumTargets</a>();
<a name="l00426"></a>00426         } 
<a name="l00427"></a>00427         <span class="keywordflow">else</span> {
<a name="l00428"></a>00428             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unknown quantification type &quot;</span> + qMethod.<a class="code" href="classQuantMethod.html#ab1b819505891590c9f3e57d9cc67d4de" title="What is the name of the quantification method?">getType</a>());
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431         <a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataExpressionData.html">ProbeSetMultiDataExpressionData</a> entry;
<a name="l00432"></a>00432         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> target=0; target&lt;nChips; target++)
<a name="l00433"></a>00433         {
<a name="l00434"></a>00434             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataExpressionData.html#a25caa86bc3c3c45b37e06c6279c94303">name</a> = psGroup.<a class="code" href="classProbeSetGroup.html#a0eb8ea2dfda45864880e0495539753db" title="Name of probe set group.">name</a>;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436             <span class="keywordflow">if</span> (gMethod != NULL) {
<a name="l00437"></a>00437                 entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataExpressionData.html#a80e4b1092348efdf96865064ca1ef1d5">quantification</a> = gMethod-&gt;<a class="code" href="classQuantGTypeMethod.html#a0d242123ad6e0bfd6934d0ef0c0073cc" title="Get our confidence value for a particular call in a particular sample.">getConfidence</a>(target);
<a name="l00438"></a>00438             } 
<a name="l00439"></a>00439             <span class="keywordflow">else</span> { <span class="comment">// eMethod != NULL because of above condition</span>
<a name="l00440"></a>00440                 entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataExpressionData.html#a80e4b1092348efdf96865064ca1ef1d5">quantification</a> = eMethod-&gt;<a class="code" href="classQuantExprMethod.html#a79a2967be16784639395bb8921239d9c" title="Get the estimated intensity for a chip.">getSignalEstimate</a>(target);
<a name="l00441"></a>00441             } 
<a name="l00442"></a>00442 
<a name="l00443"></a>00443             m_GenotypeEntryBufferWriter.<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataFileBufferWriter.html#aceead7cedcb653140a928cb3871754e3">WriteMultiDataExpressionEntry</a>(ExpressionMultiDataType, target, entry);
<a name="l00444"></a>00444         }
<a name="l00445"></a>00445         m_GoodProbesetsExpr.push_back(m_ProcessedProbeSetCount);
<a name="l00446"></a>00446         m_GoodProbesetsExprIndex.push_back(m_ProcessedExprProbeSetCount);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         m_ProcessedExprProbeSetCount++;
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450     <span class="comment">// Create a genotype CHP entry from analysis results.</span>
<a name="l00451"></a>00451     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((psType == ProbeSet::GenoType || psType == ProbeSet::Marker || psType == ProbeSet::MultichannelMarker) &amp;&amp; nGenotype &gt; 0)
<a name="l00452"></a>00452     {
<a name="l00453"></a>00453         <span class="keywordflow">if</span> (gMethod == NULL) { <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Can only generate genotype output in MutiData CHP file when using a QuantGTypeMethod.&quot;</span>); }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455         <a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html">ProbeSetMultiDataGenotypeData</a> entry;
<a name="l00456"></a>00456         entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a642f7fb39f0c26b91c60e17b958636af">metrics</a>.resize(3);
<a name="l00457"></a>00457         <span class="keywordtype">double</span> avalue;
<a name="l00458"></a>00458         <span class="keywordtype">double</span> bvalue;
<a name="l00459"></a>00459         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> target=0; target&lt;gMethod-&gt;<a class="code" href="classQuantGTypeMethod.html#aa02713a7902dd54cc6edc3a51c62b3b1" title="How many genotyping calls do we have? Also indicates how many samples there are.">getNumCalls</a>(); target++)
<a name="l00460"></a>00460         {<span class="comment"></span>
<a name="l00461"></a>00461 <span class="comment">            ///@todo should check that the call encoding is the expected GType encoding</span>
<a name="l00462"></a>00462 <span class="comment"></span>            <span class="keywordtype">int</span> call = gMethod-&gt;<a class="code" href="classQuantGTypeMethod.html#a927281a63e8b749027c68a261604cdb8" title="Get the genotype call at specified index (sample).">getCall</a>(target);
<a name="l00463"></a>00463             u_int8_t forcedCall = (u_int8_t)<a class="code" href="namespaceaffx.html#a33ab09a156736964b6a4aef8166c855b" title="Convert the enumerant to a value used by the CHP files.">GTypeCallToChpValue</a>(<a class="code" href="namespaceaffx.html#a8368f9d25c1badaa812816c14dc29ec0" title="Convert an integer from a file to an internal GType ///.">GType_from_int</a>(gMethod-&gt;<a class="code" href="classQuantGTypeMethod.html#a5b5d32b6fe0f304307834f9d633391c5" title="Get the genotype call at specified index (sample).">getForcedCall</a>(target)));
<a name="l00464"></a>00464             <span class="keywordtype">double</span> confidence = gMethod-&gt;<a class="code" href="classQuantGTypeMethod.html#a0d242123ad6e0bfd6934d0ef0c0073cc" title="Get our confidence value for a particular call in a particular sample.">getConfidence</a>(target);
<a name="l00465"></a>00465             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a15a06f972089b8828fab4d74b96581b6">name</a> = psGroup.<a class="code" href="classProbeSetGroup.html#a0eb8ea2dfda45864880e0495539753db" title="Name of probe set group.">name</a>;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467             <span class="comment">// Translate our representation to the CHP call representation.</span>
<a name="l00468"></a>00468             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a3782586eda1be37f02170a7377971643">call</a> = (u_int8_t)<a class="code" href="namespaceaffx.html#a33ab09a156736964b6a4aef8166c855b" title="Convert the enumerant to a value used by the CHP files.">GTypeCallToChpValue</a>(<a class="code" href="namespaceaffx.html#a8368f9d25c1badaa812816c14dc29ec0" title="Convert an integer from a file to an internal GType ///.">GType_from_int</a>(call));
<a name="l00469"></a>00469             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a21e66cd325d5b56ebc40cd3d9d1640ce">confidence</a> = confidence;
<a name="l00470"></a>00470                 
<a name="l00471"></a>00471             gMethod-&gt;<a class="code" href="classQuantGTypeMethod.html#a1836b30c812dc9e96f23dc5a3c6c3250" title="Get the summary value after transformation for the A and B alleles respectively.">getAlleleValues</a>(target, avalue, bvalue);
<a name="l00472"></a>00472             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a642f7fb39f0c26b91c60e17b958636af">metrics</a>[0].SetValueFloat(avalue);
<a name="l00473"></a>00473             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a642f7fb39f0c26b91c60e17b958636af">metrics</a>[1].SetValueFloat(bvalue);
<a name="l00474"></a>00474             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a642f7fb39f0c26b91c60e17b958636af">metrics</a>[2].SetValueUInt8(forcedCall);
<a name="l00475"></a>00475             m_GenotypeEntryBufferWriter.<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataFileBufferWriter.html#ac7872e59858d188cab631b587208233f">WriteMultiDataGenotypeEntry</a>(GenotypeMultiDataType, target, entry);
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477         m_GoodProbesetsGType.push_back(m_ProcessedProbeSetCount);
<a name="l00478"></a>00478         m_GoodProbesetsGTypeIndex.push_back(m_ProcessedGTypeProbeSetCount);
<a name="l00479"></a>00479 
<a name="l00480"></a>00480         m_ProcessedGTypeProbeSetCount++;
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     m_ProcessedProbeSetCount++;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 <span class="comment"></span>
<a name="l00488"></a>00488 <span class="comment">/**</span>
<a name="l00489"></a>00489 <span class="comment"> * For genotyping CHP files GTYPE likes to have the median of the raw intensity</span>
<a name="l00490"></a>00490 <span class="comment"> * probes stuffed into the confidence field of the CHP files. I&#39;m not sure why</span>
<a name="l00491"></a>00491 <span class="comment"> * but Richard C asked for it so here it is.</span>
<a name="l00492"></a>00492 <span class="comment"> *</span>
<a name="l00493"></a>00493 <span class="comment"> * @param psGroup - Groupt of probes.</span>
<a name="l00494"></a>00494 <span class="comment"> * @param iMart - Raw intensity data for chips.</span>
<a name="l00495"></a>00495 <span class="comment"> * @param chipIx - Which chip we are taking the median for.</span>
<a name="l00496"></a>00496 <span class="comment"> *</span>
<a name="l00497"></a>00497 <span class="comment"> * @return median of all raw intensities for the PM probes in psGroup.</span>
<a name="l00498"></a>00498 <span class="comment"> */</span>
<a name="l00499"></a><a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a03aff7ce1bbd20177de0c77764ddc876">00499</a> <span class="keywordtype">float</span> <a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a03aff7ce1bbd20177de0c77764ddc876" title="For genotyping CHP files GTYPE likes to have the median of the raw intensity probes stuffed into the ...">QuantMethodMultiDataCCCHPReport::medianOfPmProbes</a>(<a class="code" href="classProbeSetGroup.html" title="Group of probe sets that should be processed as a single large probe set.">ProbeSetGroup</a> &amp;psGroup, 
<a name="l00500"></a>00500 <span class="keyword">const</span> <a class="code" href="classIntensityMart.html" title="IntensityMart.">IntensityMart</a> &amp;iMart, <span class="keywordtype">int</span> chipIx) {
<a name="l00501"></a>00501     vector&lt;float&gt; pm;
<a name="l00502"></a>00502     <span class="keywordtype">float</span> med = 0;
<a name="l00503"></a>00503     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> psIx = 0; psIx &lt; psGroup.<a class="code" href="classProbeSetGroup.html#aa197d2e48f3c2e8ae67cc8f5d54735ac" title="Vector of probe set pointers.">probeSets</a>.size(); psIx++) {
<a name="l00504"></a>00504         <span class="keyword">const</span> <a class="code" href="classProbeSet.html" title="Collection of atoms that measure target that should be absent or present at the same time...">ProbeSet</a> *ps = psGroup.<a class="code" href="classProbeSetGroup.html#aa197d2e48f3c2e8ae67cc8f5d54735ac" title="Vector of probe set pointers.">probeSets</a>[psIx];
<a name="l00505"></a>00505         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> atomIx = 0; atomIx &lt; ps-&gt;<a class="code" href="classProbeSet.html#ab92eb06095441bf193a6fce3f758540b" title="Atoms that make up this probe set.">atoms</a>.size(); atomIx++) {
<a name="l00506"></a>00506             <a class="code" href="classAtom.html" title="Represents a collection of probes that make up a unit for an intensity measurement of a particular se...">Atom</a> *a = ps-&gt;<a class="code" href="classProbeSet.html#ab92eb06095441bf193a6fce3f758540b" title="Atoms that make up this probe set.">atoms</a>[atomIx];
<a name="l00507"></a>00507             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> probeIx = 0; probeIx &lt; a-&gt;<a class="code" href="classAtom.html#a5953a4944a1e24b3f51a20ce92d8def2" title="Vector of probes that make up this atom. Order is important.">probes</a>.size(); probeIx++) {
<a name="l00508"></a>00508                 <a class="code" href="classProbe.html" title="Represents an individual feature on a chip.">Probe</a> *p = a-&gt;<a class="code" href="classAtom.html#a5953a4944a1e24b3f51a20ce92d8def2" title="Vector of probes that make up this atom. Order is important.">probes</a>[probeIx];
<a name="l00509"></a>00509                 <span class="keywordflow">if</span> (Probe::isPm(*p)) {
<a name="l00510"></a>00510                     pm.push_back(iMart.<a class="code" href="classIntensityMart.html#aaa15914058548f9935424274454f5823" title="Given the probe index and chip index return the intensity data appropriate for that probe in that chi...">getProbeIntensity</a>(p-&gt;<a class="code" href="classProbe.html#a839c453922e807335dc6f4b385ed456c" title="Id of probe, in practice usually realated to position on array.">id</a>, chipIx));
<a name="l00511"></a>00511                 }
<a name="l00512"></a>00512             }
<a name="l00513"></a>00513         }
<a name="l00514"></a>00514     }
<a name="l00515"></a>00515     <span class="keywordflow">if</span> (pm.empty()) {
<a name="l00516"></a>00516         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;QuantMethodMultiDataCHPReport::medianOfPmProbes() - No Pm Probes.&quot;</span>);
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518     med = median(pm.begin(), pm.end());
<a name="l00519"></a>00519     <span class="keywordflow">return</span> med;
<a name="l00520"></a>00520 }
<a name="l00521"></a>00521 <span class="comment"></span>
<a name="l00522"></a>00522 <span class="comment">/**</span>
<a name="l00523"></a>00523 <span class="comment"> * If a probeset fails to compute for whatever reason then this method is</span>
<a name="l00524"></a>00524 <span class="comment"> * called rather than the normal report call above. By default does nothing.</span>
<a name="l00525"></a>00525 <span class="comment"> *</span>
<a name="l00526"></a>00526 <span class="comment"> * @param psGroup - List of probesets from which probes were used.</span>
<a name="l00527"></a>00527 <span class="comment"> * @param qMethod - Quantification method with compute method called.</span>
<a name="l00528"></a>00528 <span class="comment"> *</span>
<a name="l00529"></a>00529 <span class="comment"> * @return true if success, false otherwise.</span>
<a name="l00530"></a>00530 <span class="comment"> */</span>
<a name="l00531"></a><a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a9b35aa41602dd73efcb13156801d2647">00531</a> <span class="keywordtype">bool</span> <a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a9b35aa41602dd73efcb13156801d2647" title="If a probeset fails to compute for whatever reason then this method is called rather than the normal ...">QuantMethodMultiDataCCCHPReport::reportFailure</a>(<a class="code" href="classProbeSetGroup.html" title="Group of probe sets that should be processed as a single large probe set.">ProbeSetGroup</a> &amp;psGroup, 
<a name="l00532"></a>00532                                                     <a class="code" href="classQuantMethod.html" title="QuantMethod - Interface for computing quantification summaries from PM intensities grouped into probe...">QuantMethod</a> &amp;qMethod,
<a name="l00533"></a>00533                                                     <span class="keyword">const</span> <a class="code" href="classIntensityMart.html" title="IntensityMart.">IntensityMart</a> &amp;iMart, 
<a name="l00534"></a>00534                                                     std::vector&lt;ChipStream *&gt; &amp;iTrans,
<a name="l00535"></a>00535                                                     <a class="code" href="classPmAdjuster.html" title="Interface for determining a change based on intensity of perfect match.">PmAdjuster</a> &amp;pmAdjust)
<a name="l00536"></a>00536 {<span class="comment"></span>
<a name="l00537"></a>00537 <span class="comment">    /// @todo CLARIFY WHAT SHOULD HAPPEN TO CONTROL PROBESETS (ie AFFX-5Q-123)</span>
<a name="l00538"></a>00538 <span class="comment">    /// currently none of them make it out because:</span>
<a name="l00539"></a>00539 <span class="comment">    ///   (1) these probesets get flagged as Expression</span>
<a name="l00540"></a>00540 <span class="comment">    ///   (2) in the reporter construction in Genotype Engine, expression output is disabled</span>
<a name="l00541"></a>00541 <span class="comment">    ///   (3) when we rewrite the chp files in finish() these are dropped because they are not flagged as &quot;good&quot;</span>
<a name="l00542"></a>00542 <span class="comment"></span>    assert(psGroup.<a class="code" href="classProbeSetGroup.html#aa197d2e48f3c2e8ae67cc8f5d54735ac" title="Vector of probe set pointers.">probeSets</a>.size() &gt; 0);
<a name="l00543"></a>00543     <span class="comment">//checkCurrentId(psGroup); we are rewriting things, so skip overhead</span>
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="comment">// Create a blank entry in order to be consistent with psGroups list.</span>
<a name="l00546"></a>00546     <span class="keyword">const</span> <a class="code" href="classProbeSet.html#a052c4bdaa64d04532332b533bc36d634" title="What sort of probeset is this?">ProbeSet::ProbeSetType</a> psType = ChipLayout::getProbeSetType(psGroup.<a class="code" href="classProbeSetGroup.html#aa197d2e48f3c2e8ae67cc8f5d54735ac" title="Vector of probe set pointers.">probeSets</a>[0]);
<a name="l00547"></a>00547     <span class="keywordflow">if</span> (psType == ProbeSet::Expression &amp;&amp; nExpression &gt; 0)
<a name="l00548"></a>00548     {
<a name="l00549"></a>00549         <a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataExpressionData.html">ProbeSetMultiDataExpressionData</a> entry;
<a name="l00550"></a>00550         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> target=0; target&lt;m_CHPFileNames.size(); target++)
<a name="l00551"></a>00551         {
<a name="l00552"></a>00552             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataExpressionData.html#a25caa86bc3c3c45b37e06c6279c94303">name</a> = psGroup.<a class="code" href="classProbeSetGroup.html#a0eb8ea2dfda45864880e0495539753db" title="Name of probe set group.">name</a>;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataExpressionData.html#a80e4b1092348efdf96865064ca1ef1d5">quantification</a> = <a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a03aff7ce1bbd20177de0c77764ddc876" title="For genotyping CHP files GTYPE likes to have the median of the raw intensity probes stuffed into the ...">medianOfPmProbes</a>(psGroup, iMart, target);
<a name="l00555"></a>00555             m_GenotypeEntryBufferWriter.<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataFileBufferWriter.html#aceead7cedcb653140a928cb3871754e3">WriteMultiDataExpressionEntry</a>(ExpressionMultiDataType, target, entry);
<a name="l00556"></a>00556         }
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psType == ProbeSet::GenoType &amp;&amp; nGenotype &gt; 0)
<a name="l00559"></a>00559     {
<a name="l00560"></a>00560         <a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html">ProbeSetMultiDataGenotypeData</a> entry;
<a name="l00561"></a>00561         entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a642f7fb39f0c26b91c60e17b958636af">metrics</a>.resize(3);
<a name="l00562"></a>00562         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> target=0; target&lt;m_CHPFileNames.size(); target++)
<a name="l00563"></a>00563         {
<a name="l00564"></a>00564             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a15a06f972089b8828fab4d74b96581b6">name</a> = psGroup.<a class="code" href="classProbeSetGroup.html#a0eb8ea2dfda45864880e0495539753db" title="Name of probe set group.">name</a>;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a3782586eda1be37f02170a7377971643">call</a> = ALLELE_NO_CALL;
<a name="l00567"></a>00567             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a21e66cd325d5b56ebc40cd3d9d1640ce">confidence</a> = <a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a03aff7ce1bbd20177de0c77764ddc876" title="For genotyping CHP files GTYPE likes to have the median of the raw intensity probes stuffed into the ...">medianOfPmProbes</a>(psGroup, iMart, target);
<a name="l00568"></a>00568             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a642f7fb39f0c26b91c60e17b958636af">metrics</a>[0].SetValueFloat(0.0f);
<a name="l00569"></a>00569             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a642f7fb39f0c26b91c60e17b958636af">metrics</a>[1].SetValueFloat(0.0f);
<a name="l00570"></a>00570             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataGenotypeData.html#a642f7fb39f0c26b91c60e17b958636af">metrics</a>[2].SetValueUInt8(<a class="code" href="CHPFileData_8h.html#afd94016ae5feb88f6ef46eae61af879c">ALLELE_NO_CALL</a>);
<a name="l00571"></a>00571             m_GenotypeEntryBufferWriter.<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataFileBufferWriter.html#ac7872e59858d188cab631b587208233f">WriteMultiDataGenotypeEntry</a>(GenotypeMultiDataType, target, entry);
<a name="l00572"></a>00572         }
<a name="l00573"></a>00573     }
<a name="l00574"></a>00574     <span class="comment">// update counter to reflect that this probeset has been accounted for</span>
<a name="l00575"></a>00575     <span class="comment">// this is also incremented in ::report() method</span>
<a name="l00576"></a>00576     m_ProcessedProbeSetCount++;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00579"></a>00579 }
<a name="l00580"></a>00580 <span class="comment"></span>
<a name="l00581"></a>00581 <span class="comment">/**</span>
<a name="l00582"></a>00582 <span class="comment"> * No more probesets will be processed, this is a chance to finish outputting</span>
<a name="l00583"></a>00583 <span class="comment"> * results and clean up.</span>
<a name="l00584"></a>00584 <span class="comment"> * @param qMethod - Quantification method that was used.</span>
<a name="l00585"></a>00585 <span class="comment"> * @return true if success, false otherwise.</span>
<a name="l00586"></a>00586 <span class="comment"> */</span>
<a name="l00587"></a><a class="code" href="classQuantMethodMultiDataCCCHPReport.html#af17adcc4ea014ba9764b11c065853ffc">00587</a> <span class="keywordtype">bool</span> <a class="code" href="classQuantMethodMultiDataCCCHPReport.html#af17adcc4ea014ba9764b11c065853ffc" title="No more probesets will be processed, this is a chance to finish outputting results and clean up...">QuantMethodMultiDataCCCHPReport::finish</a>(<a class="code" href="classQuantMethod.html" title="QuantMethod - Interface for computing quantification summaries from PM intensities grouped into probe...">QuantMethod</a> &amp;qMethod)
<a name="l00588"></a>00588 {
<a name="l00589"></a>00589     <span class="comment">// Sanity to check we saw all the probe sets we were expecting.</span>
<a name="l00590"></a>00590     <span class="keywordflow">if</span> (m_ProcessedProbeSetCount != m_Info.<a class="code" href="classAnalysisInfo.html#ac85efbbb6618cb87c39511af32c311a7" title="How many probesets are on the chip and in cdf file. This is /// critical as probesets must be the exa...">m_NumProbeSets</a>)
<a name="l00591"></a>00591     {
<a name="l00592"></a>00592         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;QuantMethodMultiDataCCCHPReport::finish() - Expecting: &quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(m_Info.<a class="code" href="classAnalysisInfo.html#ac85efbbb6618cb87c39511af32c311a7" title="How many probesets are on the chip and in cdf file. This is /// critical as probesets must be the exa...">m_NumProbeSets</a>) +
<a name="l00593"></a>00593                       <span class="stringliteral">&quot; but got: &quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(m_ProcessedProbeSetCount) + 
<a name="l00594"></a>00594                       <span class="stringliteral">&quot;. Command Console CHP file will be corrupt.&quot;</span>);
<a name="l00595"></a>00595     }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <span class="comment">// Flush remaining signal entries in the buffer.</span>
<a name="l00598"></a>00598     m_GenotypeEntryBufferWriter.<a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataFileBufferWriter.html#adc1d11e60de38c9ae61a0a49913c4650">FlushBuffer</a>();
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     <span class="comment">// Rewrite CHP files to get chip summary entires</span>
<a name="l00601"></a>00601     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1,<span class="stringliteral">&quot;Creating final files for CHP output&quot;</span>);
<a name="l00602"></a>00602     Verbose::progressBegin(1, <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(<span class="stringliteral">&quot;Finalizing Multi Data CHP Files&quot;</span>), 
<a name="l00603"></a>00603                            m_CHPFileNames.size(), 1, m_CHPFileNames.size());
<a name="l00604"></a>00604     <span class="keywordflow">try</span> {
<a name="l00605"></a>00605         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chip = 0; chip &lt; m_CHPFileNames.size(); chip++) 
<a name="l00606"></a>00606         {
<a name="l00607"></a>00607             <span class="comment">// open up tmp chp file to pull results from</span>
<a name="l00608"></a>00608             <a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html">GenericData</a> data;
<a name="l00609"></a>00609             <a class="code" href="classaffymetrix__calvin__io_1_1GenericFileReader.html">GenericFileReader</a> reader;
<a name="l00610"></a>00610             std::string filename = m_CHPFileNames[chip]+<span class="stringliteral">&quot;.tmp&quot;</span>;
<a name="l00611"></a>00611             reader.<a class="code" href="classaffymetrix__calvin__io_1_1GenericFileReader.html#ad856db1d86014980c5edc13eb2a50b79">SetFilename</a>(filename);
<a name="l00612"></a>00612             reader.<a class="code" href="classaffymetrix__calvin__io_1_1GenericFileReader.html#a74077d19abfa7a4324c08ab837c5c5f5">ReadHeader</a>(data);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614             <a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html">GenericDataHeader</a>* hdr = data.<a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html#aa4dde02ef7050992a36bcd7c2c231c29">Header</a>().GetGenericDataHdr();
<a name="l00615"></a>00615             <a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html">GenericDataHeader</a> updateHdr;
<a name="l00616"></a>00616             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> source = 0; source &lt; m_ChipSummaries.size(); source++) {
<a name="l00617"></a>00617                 ChipSummary::metricDefVec_t metricDefs = m_ChipSummaries[source]-&gt;getMetricDefs();
<a name="l00618"></a>00618                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; metricDefs.size(); i++) {
<a name="l00619"></a>00619                     <a class="code" href="classChipSummary_1_1Metric.html" title="Class for storing metrics.">ChipSummary::Metric</a> metric;
<a name="l00620"></a>00620                     <span class="keywordflow">if</span> (!m_ChipSummaries[source]-&gt;getMetric(chip, metricDefs[i].m_name, metric)) {
<a name="l00621"></a>00621                         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;QuantMethodMultiDataCCCHPReport: metric &#39;&quot;</span> + metricDefs[i].m_name + <span class="stringliteral">&quot;&#39; was not found&quot;</span>);
<a name="l00622"></a>00622                     }
<a name="l00623"></a>00623                     std::wstring mName(<a class="code" href="AffymetrixParameterConsts_8h.html#ab14ea9d46f61faa619b482d0daf22841">CHIP_SUMMARY_PARAMETER_NAME_PREFIX</a>);
<a name="l00624"></a>00624                     mName += StringUtils::ConvertMBSToWCS(metric.m_Name);
<a name="l00625"></a>00625                     <a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html">ParameterNameValueType</a> param;
<a name="l00626"></a>00626                     <span class="keywordflow">if</span> (hdr-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html#adf1fcb58594d739f23b364f163e859ac">FindNameValParam</a>(mName, param) == <span class="keyword">false</span>) {
<a name="l00627"></a>00627                         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;QuantMethodMultiDataCCCHPReport: metric name &#39;&quot;</span> + StringUtils::ConvertWCSToMBS(mName) + 
<a name="l00628"></a>00628                                       <span class="stringliteral">&quot;&#39; could not be found in the header of &quot;</span> + filename);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630                     }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632                     <span class="keywordflow">switch</span> (param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b06936378877cf91734053b08e27b0d">GetParameterType</a>())
<a name="l00633"></a>00633                     {
<a name="l00634"></a>00634                     <span class="keywordflow">case</span> ParameterNameValueType::Int8Type:
<a name="l00635"></a>00635                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a2e6ccd92aafd9a768e310f5719880643">SetValueInt8</a>((int8_t)metric.m_Integer);
<a name="l00636"></a>00636                         <span class="keywordflow">break</span>;
<a name="l00637"></a>00637                     
<a name="l00638"></a>00638                     <span class="keywordflow">case</span> ParameterNameValueType::UInt8Type:
<a name="l00639"></a>00639                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ad11abbdb74b9c4554a5e85b1d520a0e4">SetValueUInt8</a>((u_int8_t)metric.m_Integer);
<a name="l00640"></a>00640                         <span class="keywordflow">break</span>;
<a name="l00641"></a>00641                     
<a name="l00642"></a>00642                     <span class="keywordflow">case</span> ParameterNameValueType::Int16Type:
<a name="l00643"></a>00643                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a1e401979596dd7f7be135440bab0440e">SetValueInt16</a>((int16_t)metric.m_Integer);
<a name="l00644"></a>00644                         <span class="keywordflow">break</span>;
<a name="l00645"></a>00645                     
<a name="l00646"></a>00646                     <span class="keywordflow">case</span> ParameterNameValueType::UInt16Type:
<a name="l00647"></a>00647                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a754d7b94331b3d61e4063e1bebaf4118">SetValueUInt16</a>((u_int16_t)metric.m_Integer);
<a name="l00648"></a>00648                         <span class="keywordflow">break</span>;
<a name="l00649"></a>00649                     
<a name="l00650"></a>00650                     <span class="keywordflow">case</span> ParameterNameValueType::Int32Type:
<a name="l00651"></a>00651                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ab6641303770a83bf5aebf22b47cbac5e">SetValueInt32</a>((int32_t)metric.m_Integer);
<a name="l00652"></a>00652                         <span class="keywordflow">break</span>;
<a name="l00653"></a>00653                     
<a name="l00654"></a>00654                     <span class="keywordflow">case</span> ParameterNameValueType::UInt32Type:
<a name="l00655"></a>00655                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#aecb3756fa440a9948aee2057574e45b7">SetValueUInt32</a>((u_int32_t)metric.m_Integer);
<a name="l00656"></a>00656                         <span class="keywordflow">break</span>;
<a name="l00657"></a>00657                 
<a name="l00658"></a>00658                     <span class="keywordflow">case</span> ParameterNameValueType::FloatType:
<a name="l00659"></a>00659                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a17601dadaa07e7a1d955108df7fee9af">SetValueFloat</a>((<span class="keywordtype">float</span>)metric.m_Double);
<a name="l00660"></a>00660                         <span class="keywordflow">break</span>;
<a name="l00661"></a>00661                 
<a name="l00662"></a>00662                     <span class="keywordflow">case</span> ParameterNameValueType::TextType:
<a name="l00663"></a>00663                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(metric.m_String), (<span class="keywordtype">int</span>) metric.m_String.length());
<a name="l00664"></a>00664                         <span class="keywordflow">break</span>;
<a name="l00665"></a>00665                 
<a name="l00666"></a>00666                     <span class="keywordflow">case</span> ParameterNameValueType::AsciiType:
<a name="l00667"></a>00667                         <span class="keywordflow">if</span> (metric.m_String.size() &gt; 256) {
<a name="l00668"></a>00668                             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(std::string(<span class="stringliteral">&quot;QuantMethodMultiDataCCCHPReport: string header parameter too long, name = &#39;&quot;</span>) +
<a name="l00669"></a>00669                                           metric.m_Name + 
<a name="l00670"></a>00670                                           <span class="stringliteral">&quot;&#39;, value = &#39;&quot;</span> + 
<a name="l00671"></a>00671                                           metric.m_String + <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00672"></a>00672                         }
<a name="l00673"></a>00673                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a5cb4644ca145eab52f8fa6f78123f818">SetValueAscii</a>(metric.m_String, (<span class="keywordtype">int</span>) metric.m_String.length());
<a name="l00674"></a>00674                         <span class="keywordflow">break</span>;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676                     <span class="keywordflow">default</span>:
<a name="l00677"></a>00677                         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;QuantMethodMultiDataCCCHPReport: unknown header parameter type found in file &quot;</span> + filename);
<a name="l00678"></a>00678                     }
<a name="l00679"></a>00679                     updateHdr.<a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html#aaef03a3208142900da10c77e3d46936f">AddNameValParam</a>(param);
<a name="l00680"></a>00680                 }
<a name="l00681"></a>00681             }
<a name="l00682"></a>00682             std::ofstream os;
<a name="l00683"></a>00683             os.open(filename.c_str(), std::ios::out|std::ios::binary|std::ios::in);
<a name="l00684"></a>00684             <span class="keywordflow">if</span> (!os) {
<a name="l00685"></a>00685                 <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;QuantMethodMultiDataCCCHPReport: file &quot;</span> + 
<a name="l00686"></a>00686                               filename + <span class="stringliteral">&quot; could not be opened for writing&quot;</span>);
<a name="l00687"></a>00687             }
<a name="l00688"></a>00688             <a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeaderUpdater.html">GenericDataHeaderUpdater</a> updater;
<a name="l00689"></a>00689             updater.<a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeaderUpdater.html#a9bb7b91d15cd3e5da27ae5019b65ebda">Update</a>(os, updateHdr, *hdr);
<a name="l00690"></a>00690             os.close();
<a name="l00691"></a>00691 
<a name="l00692"></a>00692             <a class="code" href="classVerbose.html#ab28a28741a3ab2086099e2d66e920eb5" title="Print a dot out to let the user know we are still alive and making progress.">Verbose::progressStep</a>(1);
<a name="l00693"></a>00693         }
<a name="l00694"></a>00694     } <span class="keywordflow">catch</span> (...) {
<a name="l00695"></a>00695         removeAllChps();
<a name="l00696"></a>00696         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Error in creating final CHP output.&quot;</span>);
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698     Verbose::progressEnd(1, <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(<span class="stringliteral">&quot;Done.&quot;</span>));
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment">// Remove .tmp extension</span>
<a name="l00701"></a>00701     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; m_CHPFileNames.size(); i++) 
<a name="l00702"></a>00702     {
<a name="l00703"></a>00703         std::string from = m_CHPFileNames[i] + <span class="stringliteral">&quot;.tmp&quot;</span>;
<a name="l00704"></a>00704         std::string to = m_CHPFileNames[i];
<a name="l00705"></a>00705         <span class="keywordflow">if</span> (!<a class="code" href="classFs.html#a57352b91aec25124a8f5b2db1cababeb" title="Return true on success.">Fs::fileRename</a>(from.c_str(),to.c_str())) {
<a name="l00706"></a>00706             removeAllChps();
<a name="l00707"></a>00707             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to rename &#39;&quot;</span> + from + <span class="stringliteral">&quot;&#39; to &#39;&quot;</span> + to +<span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00708"></a>00708         }
<a name="l00709"></a>00709     }
<a name="l00710"></a>00710     removeTmpChps();
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a><a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a709c19e950ceb15cd506175ef89a5c48">00715</a> <span class="keywordtype">void</span> <a class="code" href="classQuantMethodMultiDataCCCHPReport.html#a709c19e950ceb15cd506175ef89a5c48" title="Print a message out to the stream.">QuantMethodMultiDataCCCHPReport::addStdHeaders</a>(<a class="code" href="classQuantMethodReport.html" title="Class for reporting results of quantification methods.">QuantMethodReport</a> *qReport,
<a name="l00716"></a>00716                    <span class="keyword">const</span> std::string&amp; execGuid, 
<a name="l00717"></a>00717                    <span class="keyword">const</span> std::string&amp; reportGuid,
<a name="l00718"></a>00718                    <span class="keyword">const</span> std::string&amp; timeStr,
<a name="l00719"></a>00719                    <span class="keyword">const</span> std::string&amp; commandLine,
<a name="l00720"></a>00720                    <span class="keyword">const</span> std::string&amp; execVersion,
<a name="l00721"></a>00721                    <span class="keyword">const</span> <a class="code" href="classAnalysisInfo.html" title="Information about a particular analysis run.">AnalysisInfo</a>&amp; info) {
<a name="l00722"></a>00722   nExpression = info.<a class="code" href="classAnalysisInfo.html#a302e3084afe43804e83c520b7beb463a" title="Number of expression probesets.">m_NumExpression</a>;
<a name="l00723"></a>00723   nGenotype = info.<a class="code" href="classAnalysisInfo.html#a9a829523fde5f52310057a05b01ba601" title="Number of genotyping expression.">m_NumGenotyping</a>;
<a name="l00724"></a>00724   nReporting = info.<a class="code" href="classAnalysisInfo.html#a3fc5ed6fab19e4d4b155978fb6d6f3e3" title="How many snps to report in CHP file.">m_NumReporting</a>;
<a name="l00725"></a>00725   m_Info = info;
<a name="l00726"></a>00726   m_AlgName = info.<a class="code" href="classAnalysisInfo.html#a4e52df55ab7398557852b211c5a50d41" title="What algorithm are we reporting.">m_AlgName</a>;
<a name="l00727"></a>00727   <span class="comment">/* Most of the headers get written in the prepare statement... */</span>
<a name="l00728"></a>00728 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Jul 15 2014 10:37:36 for Affymetrix Power Tools by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
