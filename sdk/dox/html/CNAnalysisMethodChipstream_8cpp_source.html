<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Affymetrix Power Tools: copynumber/CNAnalysisMethodChipstream.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_2a6c9f730113b04fdf7a766d4dbe6d8e.html">copynumber</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>CNAnalysisMethodChipstream.cpp</h1>  </div>
</div>
<div class="contents">
<a href="CNAnalysisMethodChipstream_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">////////////////////////////////////////////////////////////////</span>
<a name="l00002"></a>00002 <span class="comment"></span><span class="comment">//</span>
<a name="l00003"></a>00003 <span class="comment">// Copyright (C) 2005 Affymetrix, Inc.</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">// This program is free software; you can redistribute it and/or modify</span>
<a name="l00006"></a>00006 <span class="comment">// it under the terms of the GNU General Public License (version 2) as</span>
<a name="l00007"></a>00007 <span class="comment">// published by the Free Software Foundation.</span>
<a name="l00008"></a>00008 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">// This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<a name="l00012"></a>00012 <span class="comment">// General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment">//</span>
<a name="l00014"></a>00014 <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment">// along with this program;if not, write to the</span>
<a name="l00016"></a>00016 <span class="comment">//</span>
<a name="l00017"></a>00017 <span class="comment">// Free Software Foundation, Inc.,</span>
<a name="l00018"></a>00018 <span class="comment">// 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00019"></a>00019 <span class="comment">//</span><span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">////////////////////////////////////////////////////////////////</span>
<a name="l00021"></a>00021 <span class="comment"></span><span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">/**</span>
<a name="l00023"></a>00023 <span class="comment"> * @file CNAnalysisMethodChipstream.cpp</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * @brief This file contains the CNAnalysisMethodChipstream class members.</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="CNAnalysisMethodChipstream_8h.html" title="This header contains the CNAnalysisMethodChipstream class definition.">copynumber/CNAnalysisMethodChipstream.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="comment">//</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="CNAnalysisMethodCovariateSignalAdjuster_8h.html" title="Class for doing covariate-based signal adjustment.">copynumber/CNAnalysisMethodCovariateSignalAdjuster.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="CNAnalysisMethodFactory_8h.html" title="This header contains the CNAnalysisMethodFactory class definition.">copynumber/CNAnalysisMethodFactory.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="CNAnalysisMethodReference_8h.html" title="This header contains the CNAnalysisMethodReference class definition.">copynumber/CNAnalysisMethodReference.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="comment">//</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="FusionCELData_8h.html">calvin_files/fusion/src/FusionCELData.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="StringUtils_8h.html">calvin_files/utils/src/StringUtils.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="BioTypes_8h.html" title="Central location enumerations and other types that aren&amp;#39;t particular to a single class or applica...">chipstream/BioTypes.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="CelReader_8h.html" title="Class for reading cel files and passing the data to memory representation and analysis objects...">chipstream/CelReader.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;chipstream/ChipLayout.h&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="ChipStreamFactory_8h.html" title="Factory class for making chip streams based on a string representation.">chipstream/ChipStreamFactory.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;chipstream/HomHiLoCelListener.h&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;chipstream/QuantLabelZIO.h&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="SketchQuantNormTran_8h.html" title="Class for doing normalization. Can do sketch and full quantile (just set sketch to chip size) and sup...">chipstream/SketchQuantNormTran.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="SparseMart_8h.html" title="Class for representing cel file intensity data in memory. Can save a lot of the space if not all of a...">chipstream/SparseMart.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="TsvFile_8h.html" title="Headers for the TsvFile classes.">file/TsvFile/TsvFile.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;normalization/normalization.h&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="AffxStatistics_8h.html" title="This header contains the AffxStatistics class definition.">util/AffxStatistics.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="RowFile_8h.html" title="Class for dealing with line oriented files.">util/RowFile.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="comment">//</span><span class="comment"></span>
<a name="l00049"></a>00049 <span class="comment">/**</span>
<a name="l00050"></a>00050 <span class="comment"> * @brief Supply a little how/what/why about the algorithms this</span>
<a name="l00051"></a>00051 <span class="comment"> * class performs and what parameters it takes.</span>
<a name="l00052"></a>00052 <span class="comment"> * @return SelfDoc</span>
<a name="l00053"></a>00053 <span class="comment"> */</span>
<a name="l00054"></a><a class="code" href="classCNAnalysisMethodChipstream.html#af758eaf5ecfcc8f0f6499e617fb5824d">00054</a> <a class="code" href="classSelfDoc.html" title="Small interface to for algorithmic classes that can explain themselves.">SelfDoc</a> <a class="code" href="classCNAnalysisMethodChipstream.html#af758eaf5ecfcc8f0f6499e617fb5824d" title="Supply a little how/what/why about the algorithms this class performs and what parameters it takes...">CNAnalysisMethodChipstream::explainSelf</a>()
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     <a class="code" href="classCNAnalysisMethodChipstream.html" title="The Chipstream Analysis Method.">CNAnalysisMethodChipstream</a> obj;
<a name="l00057"></a>00057     <a class="code" href="classSelfDoc.html" title="Small interface to for algorithmic classes that can explain themselves.">SelfDoc</a> doc;
<a name="l00058"></a>00058     doc.<a class="code" href="classSelfDoc.html#a51db8ea9abfa958f92fb5bc601ad68dc" title="Setter method for name appearing in doc.">setDocName</a>(obj.getType());
<a name="l00059"></a>00059     doc.<a class="code" href="classSelfDoc.html#acd4638b447701d1a642effb6b8d2a396" title="Setter method for description appearing in doc.">setDocDescription</a>(obj.getDescription());
<a name="l00060"></a>00060     doc.<a class="code" href="classSelfDoc.html#aa43e6721e35792413711e07bda90861d" title="Setter method for parameters and their documentation.">setDocOptions</a>(obj.<a class="code" href="classCNAnalysisMethodChipstream.html#a5d2b355d7be3a54aa976cc0fcb38f8a7" title="Default Getter method for parameters and their documentation.">getDefaultDocOptions</a>());
<a name="l00061"></a>00061     <span class="keywordflow">return</span> doc;
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 <span class="comment"></span>
<a name="l00064"></a>00064 <span class="comment">/**</span>
<a name="l00065"></a>00065 <span class="comment"> * @brief Default Getter method for parameters and their documentation.</span>
<a name="l00066"></a>00066 <span class="comment"> * @return map of parameters and their descriptions.</span>
<a name="l00067"></a>00067 <span class="comment"> */</span>
<a name="l00068"></a><a class="code" href="classCNAnalysisMethodChipstream.html#a5d2b355d7be3a54aa976cc0fcb38f8a7">00068</a> std::vector&lt;SelfDoc::Opt&gt; <a class="code" href="classCNAnalysisMethodChipstream.html#a5d2b355d7be3a54aa976cc0fcb38f8a7" title="Default Getter method for parameters and their documentation.">CNAnalysisMethodChipstream::getDefaultDocOptions</a>()
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070   std::vector&lt;SelfDoc::Opt&gt; opts;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072   <span class="comment">// SelfDoc::Opt(name, type, value, default, min, max, description)</span>
<a name="l00073"></a>00073   <a class="code" href="classSelfDoc_1_1Opt.html" title="Description of one possible option/parameter for a self describing class.">SelfDoc::Opt</a> chipstreamNDBandwidth = {<span class="stringliteral">&quot;NDBandwidth&quot;</span>, SelfDoc::Opt::Float, <span class="stringliteral">&quot;10.0&quot;</span>, <span class="stringliteral">&quot;10.0&quot;</span>, <span class="stringliteral">&quot;10.0&quot;</span>, <span class="stringliteral">&quot;20.0&quot;</span>, <span class="stringliteral">&quot;Normal-Diploid Bandwidth&quot;</span>};
<a name="l00074"></a>00074   opts.push_back(chipstreamNDBandwidth);
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   <span class="keywordflow">return</span> opts;
<a name="l00079"></a>00079 }
<a name="l00080"></a>00080 <span class="comment"></span>
<a name="l00081"></a>00081 <span class="comment">/**</span>
<a name="l00082"></a>00082 <span class="comment"> * @brief This static function should be overridden by child classes</span>
<a name="l00083"></a>00083 <span class="comment"> * to return an object of the correct type initialized correctly</span>
<a name="l00084"></a>00084 <span class="comment"> * with the parameters in the string, string map. All objects</span>
<a name="l00085"></a>00085 <span class="comment"> * created this way should be deleted when finished using.</span>
<a name="l00086"></a>00086 <span class="comment"> *</span>
<a name="l00087"></a>00087 <span class="comment"> * @param param - Map of key/value pairs to initialize the object.</span>
<a name="l00088"></a>00088 <span class="comment"> *</span>
<a name="l00089"></a>00089 <span class="comment"> * @return Pointer toCreate object, this should be sub casted as necessary.</span>
<a name="l00090"></a>00090 <span class="comment"> */</span>
<a name="l00091"></a><a class="code" href="classCNAnalysisMethodChipstream.html#a59d184d01b0999a7d1a9577f6d7eb257">00091</a> <a class="code" href="classSelfCreate.html" title="Small interface for functions that know how to make an instance of themselves given a map of key...">SelfCreate</a>* <a class="code" href="classCNAnalysisMethodChipstream.html#a59d184d01b0999a7d1a9577f6d7eb257" title="This static function should be overridden by child classes to return an object of the correct type in...">CNAnalysisMethodChipstream::newObject</a>(std::map&lt;std::string,std::string&gt;&amp; params)
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093     <a class="code" href="classSelfDoc.html" title="Small interface to for algorithmic classes that can explain themselves.">SelfDoc</a> doc = <a class="code" href="classCNAnalysisMethodChipstream.html#af758eaf5ecfcc8f0f6499e617fb5824d" title="Supply a little how/what/why about the algorithms this class performs and what parameters it takes...">explainSelf</a>();
<a name="l00094"></a>00094     std::vector&lt;SelfDoc::Opt&gt; opts = <a class="code" href="classCNAnalysisMethodChipstream.html#a5d2b355d7be3a54aa976cc0fcb38f8a7" title="Default Getter method for parameters and their documentation.">getDefaultDocOptions</a>();
<a name="l00095"></a>00095     <a class="code" href="classCNAnalysisMethodChipstream.html" title="The Chipstream Analysis Method.">CNAnalysisMethodChipstream</a>* pMethod = <span class="keyword">new</span> <a class="code" href="classCNAnalysisMethodChipstream.html#aa7770aa32e67f343bfe78597c8dde259" title="Constructor.">CNAnalysisMethodChipstream</a>();
<a name="l00096"></a>00096     std::string strPrefix = getPrefix();
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     pMethod-&gt;m_fNDBandwidth = <a class="code" href="classCNAnalysisMethod.html#a595a9187f287c87e5904f4415d95d3cb" title="Setup a float parameter for this analysis method, including min amd max validation.">setupFloatParameter</a>(<span class="stringliteral">&quot;NDBandwidth&quot;</span>, strPrefix, params, doc, opts);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="keywordflow">return</span> pMethod;
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 <span class="comment"></span>
<a name="l00103"></a>00103 <span class="comment">/**</span>
<a name="l00104"></a>00104 <span class="comment"> * @brief Constructor</span>
<a name="l00105"></a>00105 <span class="comment"> */</span>
<a name="l00106"></a><a class="code" href="classCNAnalysisMethodChipstream.html#aa7770aa32e67f343bfe78597c8dde259">00106</a> <a class="code" href="classCNAnalysisMethodChipstream.html#aa7770aa32e67f343bfe78597c8dde259" title="Constructor.">CNAnalysisMethodChipstream::CNAnalysisMethodChipstream</a>()
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108     m_iPrevGenderCode = -1;
<a name="l00109"></a>00109     m_iGenderCode = -1;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     m_uiMaxProbeCount = 0;
<a name="l00112"></a>00112     m_pdProbeEffects = NULL;
<a name="l00113"></a>00113     m_pdChipEffects = NULL;
<a name="l00114"></a>00114     m_ppdPM = NULL;
<a name="l00115"></a>00115     m_ppdMM = NULL;
<a name="l00116"></a>00116     m_ppdResiduals = NULL;
<a name="l00117"></a>00117     m_pPlier = NULL;
<a name="l00118"></a>00118     m_iPlierChipCount = 0;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     m_pvProbes = NULL;
<a name="l00121"></a>00121     m_pProbes = NULL;
<a name="l00122"></a>00122     m_iInstanceCount = 0;
<a name="l00123"></a>00123     m_pobjAdapterTypeNormTran = NULL;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     m_pvSNPReferenceSketch = NULL;
<a name="l00126"></a>00126     m_pvCNReferenceSketch = NULL;
<a name="l00127"></a>00127     m_pvChipSketch = NULL;
<a name="l00128"></a>00128     m_pvSNPData = NULL;
<a name="l00129"></a>00129     m_pvCNData = NULL;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     m_dXXRatio = 0;
<a name="l00132"></a>00132     m_dYRatio = 0;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     m_fNDBandwidth = 0.0;
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 <span class="comment"></span>
<a name="l00137"></a>00137 <span class="comment">/**</span>
<a name="l00138"></a>00138 <span class="comment"> * @brief Destructor</span>
<a name="l00139"></a>00139 <span class="comment"> */</span>
<a name="l00140"></a><a class="code" href="classCNAnalysisMethodChipstream.html#a0af25a13b8ae73c9891f04ebbbd4dba0">00140</a> <a class="code" href="classCNAnalysisMethodChipstream.html#a0af25a13b8ae73c9891f04ebbbd4dba0" title="Destructor.">CNAnalysisMethodChipstream::~CNAnalysisMethodChipstream</a>()
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (m_pvSNPReferenceSketch != NULL) {deleteSketch();}
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (m_pProbes != NULL) {deleteProbes();}
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (m_pPlier != NULL) {deletePlier();}
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (m_pvSNPData != NULL) {<span class="keyword">delete</span> m_pvSNPData;}
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (m_pvCNData != NULL) {<span class="keyword">delete</span> m_pvCNData;}
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="comment"></span>
<a name="l00150"></a>00150 <span class="comment">/**</span>
<a name="l00151"></a>00151 <span class="comment"> * @brief Run the analysis.</span>
<a name="l00152"></a>00152 <span class="comment"> */</span>
<a name="l00153"></a><a class="code" href="classCNAnalysisMethodChipstream.html#aebb56bca4c30710bf5108078f60b000f">00153</a> <span class="keywordtype">void</span> <a class="code" href="classCNAnalysisMethodChipstream.html#aebb56bca4c30710bf5108078f60b000f" title="Run the analysis.">CNAnalysisMethodChipstream::run</a>()
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1, <span class="stringliteral">&quot;MAJOR PROGRESS UPDATE: Running Probe Intensity Normalization.&quot;</span>);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1, <span class="stringliteral">&quot;CNAnalysisMethodChipstream::run(...) start&quot;</span>);
<a name="l00158"></a>00158     isSetup();
<a name="l00159"></a>00159     getProbeSets()-&gt;quickSort(0); <span class="comment">// by ProbeSetName</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 <span class="comment">//    loadGenotypeCallsFromFile();</span>
<a name="l00162"></a>00162     <span class="keywordflow">if</span> (m_pProbes == NULL) {newProbes();}
<a name="l00163"></a>00163     <span class="keywordflow">if</span> (m_pvSNPReferenceSketch == NULL) {newSketch();}
<a name="l00164"></a>00164     <span class="keywordflow">if</span> (m_pPlier == NULL) {newPlier(1);}
<a name="l00165"></a>00165     determineSketchProbeSets();
<a name="l00166"></a>00166     normalizeIntensities();
<a name="l00167"></a>00167     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;keep-intermediate-data&quot;</span>))
<a name="l00168"></a>00168         {
<a name="l00169"></a>00169                 writeIntensities(<span class="stringliteral">&quot;single-sample-normalized&quot;</span>);
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     memory(<span class="stringliteral">&quot;CNAnalysisMethodChipstream::run(...)&quot;</span>);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (        m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;local-gc-background-intensity-adjustment-method&quot;</span>)      &amp;&amp; 
<a name="l00175"></a>00175                 m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;local-gc-background-intensity-adjustment-method&quot;</span>) != <span class="stringliteral">&quot;none&quot;</span>  &amp;&amp;
<a name="l00176"></a>00176                 m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;local-gc-background-intensity-adjustment-method&quot;</span>) != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00177"></a>00177     {
<a name="l00178"></a>00178         adjustIntensitiesPDNN();
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     adjustIntensitiesHighPassFilter();
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     calculateSignalEstimates(); 
<a name="l00184"></a>00184     calculateXY(); 
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;keep-intermediate-data&quot;</span>))
<a name="l00187"></a>00187     {
<a name="l00188"></a>00188             writeSignals(<span class="stringliteral">&quot;chipstream&quot;</span>);
<a name="l00189"></a>00189             writeSignalsTsv(<span class="stringliteral">&quot;chipstream&quot;</span>, getProbeSets());
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     getProbeSets()-&gt;quickSort(1); <span class="comment">// by Chromosome, Position</span>
<a name="l00193"></a>00193     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1, <span class="stringliteral">&quot;CNAnalysisMethodChipstream::run(...) end&quot;</span>);
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="comment">/*</span>
<a name="l00198"></a>00198 <span class="comment">void CNAnalysisMethodChipstream::loadSnpProbeSets(std::vector&lt;CNProbeSet*&gt; &amp;vSnpProbeSets)</span>
<a name="l00199"></a>00199 <span class="comment">{</span>
<a name="l00200"></a>00200 <span class="comment">        vSnpProbeSets.clear();</span>
<a name="l00201"></a>00201 <span class="comment">        for (int i = 0; (i &lt; m_pvProbeSets-&gt;getCount()); i++)</span>
<a name="l00202"></a>00202 <span class="comment">        {</span>
<a name="l00203"></a>00203 <span class="comment">                CNProbeSet* p = m_pvProbeSets-&gt;getAt(i);</span>
<a name="l00204"></a>00204 <span class="comment">                if ((p-&gt;isProcess()) &amp;&amp; (p-&gt;processAsSNP()) &amp;&amp; (p-&gt;getInformation() != 0))</span>
<a name="l00205"></a>00205 <span class="comment">                {</span>
<a name="l00206"></a>00206 <span class="comment">                        vSnpProbeSets.push_back(p);</span>
<a name="l00207"></a>00207 <span class="comment">                }</span>
<a name="l00208"></a>00208 <span class="comment">        }</span>
<a name="l00209"></a>00209 <span class="comment">}</span>
<a name="l00210"></a>00210 <span class="comment">*/</span>
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::determineSketchProbeSets()
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215 <span class="comment">//MG temporary code for Bitao</span>
<a name="l00216"></a>00216         <a class="code" href="classAffxArray.html">AffxArray&lt;AffxString&gt;</a> ar;
<a name="l00217"></a>00217         <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;normal-diploid-files-file&quot;</span>) != <span class="stringliteral">&quot;&quot;</span>) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;normal-diploid-files-file&quot;</span>) != <span class="stringliteral">&quot;none&quot;</span>))
<a name="l00218"></a>00218         {
<a name="l00219"></a>00219           <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">affx::TsvFile</a> tsv;
<a name="l00220"></a>00220           tsv.<a class="code" href="classaffx_1_1TsvFile.html#a0b08c1eea21d4b6a893f57df16521a46" title="remove whitespace from value?">m_optAutoTrim</a> = <span class="keyword">true</span>;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222           std::string diploid;
<a name="l00223"></a>00223           <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> normalDiploidFileName = getExperiment()-&gt;getExperimentNormalDiploidFileName();
<a name="l00224"></a>00224           <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(normalDiploidFileName) == affx::TSV_OK)  {
<a name="l00225"></a>00225             <span class="keywordflow">while</span> ( tsv.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0) == affx::TSV_OK ) {
<a name="l00226"></a>00226               tsv.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,0, diploid);
<a name="l00227"></a>00227               ar.add(<span class="keyword">new</span> <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a>(diploid));
<a name="l00228"></a>00228             }
<a name="l00229"></a>00229             tsv.<a class="code" href="classaffx_1_1TsvFile.html#a6a397412f48d477d0e87b00f914d06f7" title="Closes the file and clears bindings and other info.">clear</a>();
<a name="l00230"></a>00230           } <span class="keywordflow">else</span> {<a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Cannot open file: &quot;</span> + normalDiploidFileName);}
<a name="l00231"></a>00231           ar.quickSort(0);
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233 <span class="comment">//</span>
<a name="l00234"></a>00234         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; getProbeSets()-&gt;getCount()); iIndex++)
<a name="l00235"></a>00235         {
<a name="l00236"></a>00236                 <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* p = getProbeSets()-&gt;getAt(iIndex);
<a name="l00237"></a>00237                 p-&gt;setUseForSketch(<span class="keyword">false</span>);
<a name="l00238"></a>00238                 <span class="keywordflow">if</span> (p-&gt;getChromosome() &lt; m_iXChromosome)
<a name="l00239"></a>00239                 {
<a name="l00240"></a>00240                         <span class="keywordflow">if</span> (ar.getCount() &gt; 0)
<a name="l00241"></a>00241                         {
<a name="l00242"></a>00242                                 <span class="comment">// Check if probe set exists in normal diploid list.</span>
<a name="l00243"></a>00243                                 <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> str = p-&gt;getProbeSetName();
<a name="l00244"></a>00244                                 p-&gt;setUseForSketch(ar.binarySearch(str, 0) != -1);
<a name="l00245"></a>00245                         }
<a name="l00246"></a>00246                         <span class="keywordflow">else</span>
<a name="l00247"></a>00247                         {
<a name="l00248"></a>00248                                 <span class="comment">// No list, assume all probe sets are normal diploid.</span>
<a name="l00249"></a>00249                                 p-&gt;setUseForSketch(<span class="keyword">true</span>);
<a name="l00250"></a>00250                         }
<a name="l00251"></a>00251                 }
<a name="l00252"></a>00252         }
<a name="l00253"></a>00253         ar.deleteAll();
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::extractSketch(std::vector&lt;float&gt;&amp; vData, std::vector&lt;float&gt;&amp; vSketch)
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258     <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a> v(vData.size());
<a name="l00259"></a>00259     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; (i &lt; vData.size()); i++)
<a name="l00260"></a>00260     {
<a name="l00261"></a>00261         v.set(i, vData[i]);
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263     v.quickSort();
<a name="l00264"></a>00264     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; (i &lt; vSketch.size()); i++)
<a name="l00265"></a>00265     {
<a name="l00266"></a>00266         vSketch[i] = (float)v.percentile(((<span class="keywordtype">double</span>)i / (<span class="keywordtype">double</span>)(vSketch.size() - 1)), <span class="keyword">false</span>);
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 <span class="keywordtype">float</span> CNAnalysisMethodChipstream::interpolate(    <span class="keywordtype">float</span> fIntensity,
<a name="l00271"></a>00271                                                 <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a>&amp; vReferenceSketch,
<a name="l00272"></a>00272                                                 <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a>&amp; vChipSketch,
<a name="l00273"></a>00273                                                 <span class="keywordtype">double</span> dRatio)
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiSketchSize = vReferenceSketch.length();
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (fIntensity &lt; vChipSketch.get(0))
<a name="l00277"></a>00277     {
<a name="l00278"></a>00278         fIntensity = vReferenceSketch.get(0) * fIntensity / vChipSketch.get(0);
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fIntensity &gt;= vChipSketch.get(uiSketchSize - 1))
<a name="l00281"></a>00281     {
<a name="l00282"></a>00282         fIntensity = vReferenceSketch.get(uiSketchSize - 1) + (fIntensity - vChipSketch.get(uiSketchSize - 1)) * dRatio;
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284     <span class="keywordflow">else</span>
<a name="l00285"></a>00285     {
<a name="l00286"></a>00286         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiLowIndex = 0;
<a name="l00287"></a>00287         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiHighIndex = 0;
<a name="l00288"></a>00288         vChipSketch.binarySearch(fIntensity, uiLowIndex, uiHighIndex); <span class="comment">// Produces &lt;= n &lt;=</span>
<a name="l00289"></a>00289         <span class="keywordflow">if</span> (fIntensity == vChipSketch.get(uiHighIndex)) {uiLowIndex = uiHighIndex; uiHighIndex++;} <span class="comment">// Want &lt;= n &lt;</span>
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (vChipSketch.get(uiLowIndex) == vChipSketch.get(uiHighIndex))
<a name="l00291"></a>00291         {
<a name="l00292"></a>00292             fIntensity = vReferenceSketch.get(uiLowIndex);
<a name="l00293"></a>00293         }
<a name="l00294"></a>00294         <span class="keywordflow">else</span>
<a name="l00295"></a>00295         {
<a name="l00296"></a>00296             fIntensity = vReferenceSketch.get(uiLowIndex) + (fIntensity - vChipSketch.get(uiLowIndex)) * ((vReferenceSketch.get(uiHighIndex) - vReferenceSketch.get(uiLowIndex)) / (vChipSketch.get(uiHighIndex) - vChipSketch.get(uiLowIndex)));
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299     <span class="keywordflow">if</span> (!<a class="code" href="classUtil.html#a66b3f27deb315aab108936d0830c6991" title="Wrapper for different version of isnan() on different systems.">Util::isFinite</a>(fIntensity)) {fIntensity = vReferenceSketch.get(vReferenceSketch.length() - 1);}
<a name="l00300"></a>00300     <span class="keywordflow">return</span> fIntensity;
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::normalizeIntensities()
<a name="l00304"></a>00304 {
<a name="l00305"></a>00305     <span class="comment">// Check to see if a subset was selected.</span>
<a name="l00306"></a>00306     loadIntensities();
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     <span class="keywordflow">if</span> (!(m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;doDualNormalization&quot;</span>)))
<a name="l00309"></a>00309     {        
<a name="l00310"></a>00310         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiSketchSize = 0;
<a name="l00311"></a>00311         <span class="keywordflow">if</span>(m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;sketch-size&quot;</span>))
<a name="l00312"></a>00312         {
<a name="l00313"></a>00313             uiSketchSize = m_pEngine-&gt;<a class="code" href="classOptions.html#afcfab86e21cac5bba43e0858bd428e62" title="Get the integer value of an option.">getOptInt</a>(<span class="stringliteral">&quot;sketch-size&quot;</span>);
<a name="l00314"></a>00314         }
<a name="l00315"></a>00315         <span class="keywordflow">else</span>
<a name="l00316"></a>00316         {
<a name="l00317"></a>00317             uiSketchSize = 50000;
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319         <span class="keywordflow">if</span> (uiSketchSize &gt; m_pvProbes-&gt;getCount()) {uiSketchSize = m_pvProbes-&gt;getCount();}
<a name="l00320"></a>00320         <a class="code" href="classSketchQuantNormTran.html" title="SketchQuantNormTran for doing normalization.">SketchQuantNormTran</a> *qnorm = <span class="keyword">new</span> <a class="code" href="classSketchQuantNormTran.html" title="SketchQuantNormTran for doing normalization.">SketchQuantNormTran</a>(uiSketchSize, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, 0, <span class="keyword">false</span>);
<a name="l00321"></a>00321         vector&lt;float&gt; sketch;
<a name="l00322"></a>00322         <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strReferenceFileName = m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;reference-file&quot;</span>);
<a name="l00323"></a>00323         <a class="code" href="classaffx_1_1File5__File.html">affx::File5_File</a> file5;
<a name="l00324"></a>00324         <a class="code" href="classaffx_1_1File5__Group.html">affx::File5_Group</a>* group5 = NULL;
<a name="l00325"></a>00325         <a class="code" href="classaffx_1_1File5__Tsv.html">affx::File5_Tsv</a>* tsv5 = NULL;
<a name="l00326"></a>00326         file5.open(strReferenceFileName, affx::FILE5_OPEN_RO);
<a name="l00327"></a>00327         group5 = file5.openGroup(<span class="stringliteral">&quot;CN5&quot;</span>, affx::FILE5_OPEN);
<a name="l00328"></a>00328         <span class="keywordtype">double</span> d = 0;
<a name="l00329"></a>00329         tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;target-sketch&quot;</span>, affx::FILE5_OPEN);
<a name="l00330"></a>00330         <span class="keywordflow">while</span> (tsv5-&gt;nextLine() == affx::FILE5_OK)
<a name="l00331"></a>00331         {
<a name="l00332"></a>00332             tsv5-&gt;get(0, 0, &amp;d); sketch.push_back((<span class="keywordtype">float</span>)d);
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334         tsv5-&gt;close();
<a name="l00335"></a>00335         <span class="keyword">delete</span> tsv5;
<a name="l00336"></a>00336         group5-&gt;close();
<a name="l00337"></a>00337         <span class="keyword">delete</span> group5;
<a name="l00338"></a>00338         file5.close();
<a name="l00339"></a>00339 
<a name="l00340"></a>00340         qnorm-&gt;<a class="code" href="classSketchQuantNormTran.html#a9dfca855f9cd75e0a9bc33d4b756b8c6" title="Set a target distribution to normalize all the chips to.">setTargetSketch</a>(sketch);
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         qnorm-&gt;newChip(*m_pvSNPData);
<a name="l00343"></a>00343         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvProbes-&gt;getCount()); iIndex++)
<a name="l00344"></a>00344         {
<a name="l00345"></a>00345             <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l00346"></a>00346             p-&gt;setIntensity(qnorm-&gt;<a class="code" href="classSketchQuantNormTran.html#a8b27b3bcaa8ae8aa902ddbd8d6b202a5" title="transform the intensity point supplied coming from a particular probe in a particular microarray...">transform</a>(iIndex, 0, p-&gt;getIntensity()));
<a name="l00347"></a>00347         }
<a name="l00348"></a>00348         <span class="keyword">delete</span> qnorm;
<a name="l00349"></a>00349         <span class="keywordflow">return</span>;
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     extractSketch(*m_pvSNPData, *m_pvChipSketch);
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a> vReferenceSketch(m_pvSNPReferenceSketch-&gt;size());
<a name="l00355"></a>00355     <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a> vChipSketch(m_pvChipSketch-&gt;size());
<a name="l00356"></a>00356     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvChipSketch-&gt;size()); iIndex++)
<a name="l00357"></a>00357     {
<a name="l00358"></a>00358         vReferenceSketch.set(iIndex, m_pvSNPReferenceSketch-&gt;at(iIndex));
<a name="l00359"></a>00359         vChipSketch.set(iIndex, m_pvChipSketch-&gt;at(iIndex));
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361     <span class="keywordtype">double</span> dRatio = (vReferenceSketch.median() / vChipSketch.median());
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="comment">// Normalize the snp probe intensities.</span>
<a name="l00364"></a>00364     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvProbes-&gt;getCount()); iIndex++)
<a name="l00365"></a>00365     {
<a name="l00366"></a>00366         <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l00367"></a>00367         <span class="keywordflow">if</span> (p-&gt;getProbeSetIndex() == -1) {<span class="keywordflow">continue</span>;}
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;processAsSNPNormalize())
<a name="l00369"></a>00369         {
<a name="l00370"></a>00370             p-&gt;setIntensity(interpolate(p-&gt;getIntensity(), vReferenceSketch, vChipSketch, dRatio));
<a name="l00371"></a>00371         }
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     extractSketch(*m_pvCNData, *m_pvChipSketch);
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvChipSketch-&gt;size()); iIndex++)
<a name="l00377"></a>00377     {
<a name="l00378"></a>00378         vReferenceSketch.set(iIndex, m_pvCNReferenceSketch-&gt;at(iIndex));
<a name="l00379"></a>00379         vChipSketch.set(iIndex, m_pvChipSketch-&gt;at(iIndex));
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381     dRatio = (vReferenceSketch.median() / vChipSketch.median());
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="comment">// Normalize the cn probe intensities.</span>
<a name="l00384"></a>00384     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvProbes-&gt;getCount()); iIndex++)
<a name="l00385"></a>00385     {
<a name="l00386"></a>00386         <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l00387"></a>00387         <span class="keywordflow">if</span> (p-&gt;getProbeSetIndex() == -1) {<span class="keywordflow">continue</span>;}
<a name="l00388"></a>00388         <span class="keywordflow">if</span> (getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;processAsCNNormalize())
<a name="l00389"></a>00389         {
<a name="l00390"></a>00390             p-&gt;setIntensity(interpolate(p-&gt;getIntensity(), vReferenceSketch, vChipSketch, dRatio));
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394         <span class="keywordtype">bool</span> testFlag = <span class="keyword">false</span>;
<a name="l00395"></a>00395         <span class="keywordflow">if</span>(testFlag)
<a name="l00396"></a>00396         {
<a name="l00397"></a>00397                 <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">affx::TsvFile</a> *tsv = <span class="keyword">new</span> <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">affx::TsvFile</a>;
<a name="l00398"></a>00398                 tsv-&gt;<a class="code" href="classaffx_1_1TsvFile.html#a607cbaf58e6e0772ef7d2aaee277c552" title="open the file for writing in &amp;quot;v2&amp;quot; format. ///">writeTsv</a>(getExperiment()-&gt;getExperimentName() + <span class="stringliteral">&quot;.intensities.txt&quot;</span>);
<a name="l00399"></a>00399                 tsv-&gt;<a class="code" href="classaffx_1_1TsvFile.html#aadc22863a63b9c6588b0f2dc61875809" title="User methods.">defineColumn</a>(    0,0,<span class="stringliteral">&quot;probe_id&quot;</span>, affx::TSV_TYPE_INT);
<a name="l00400"></a>00400                 tsv-&gt;<a class="code" href="classaffx_1_1TsvFile.html#aadc22863a63b9c6588b0f2dc61875809" title="User methods.">defineColumn</a>(    0,1,<span class="stringliteral">&quot;intensity&quot;</span>, affx::TSV_TYPE_DOUBLE);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvProbes-&gt;getCount()); iIndex++)
<a name="l00403"></a>00403             {
<a name="l00404"></a>00404                 <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l00405"></a>00405                 tsv-&gt;set(0,0,p-&gt;getProbeID());
<a name="l00406"></a>00406                 tsv-&gt;set(0,1,p-&gt;getIntensity());
<a name="l00407"></a>00407                 tsv-&gt;<a class="code" href="classaffx_1_1TsvFile.html#a2a459be42bea9ea3f180773370ec0de7" title="Write a level of data to the file. ///.">writeLevel</a>(0);
<a name="l00408"></a>00408             }
<a name="l00409"></a>00409             <span class="keyword">delete</span> tsv;
<a name="l00410"></a>00410         }
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::calculateSignalEstimates()
<a name="l00414"></a>00414 {
<a name="l00415"></a>00415 <span class="comment">//    Verbose::out(1, &quot;CNAnalysisMethodChipstream::calculateSignalEstimates()&quot;);</span>
<a name="l00416"></a>00416     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1, <span class="stringliteral">&quot;MAJOR PROGRESS UPDATE: Running Signal Summarization.&quot;</span>);
<a name="l00417"></a>00417     m_pvProbes-&gt;quickSort(0); <span class="comment">// by ProbeSetIndex, by Allele</span>
<a name="l00418"></a>00418     <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a> vIntensities(m_uiMaxProbeCount);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     <span class="keywordtype">long</span> errorCode = 0;
<a name="l00421"></a>00421     <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* pPrev = NULL;
<a name="l00422"></a>00422     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiProbeCount = 0;
<a name="l00423"></a>00423     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvProbes-&gt;getCount()); iIndex++)
<a name="l00424"></a>00424     {
<a name="l00425"></a>00425         <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l00426"></a>00426         <span class="keywordflow">if</span> ((pPrev == NULL) || (pPrev-&gt;<a class="code" href="classCNProbe.html#acde845187ba473744a8751f3f67d532c" title="Compare function.">compareTo</a>(*p, 0) == 0))
<a name="l00427"></a>00427         {
<a name="l00428"></a>00428             <span class="keywordflow">if</span> (pPrev == NULL) {pPrev = p;}
<a name="l00429"></a>00429             m_pdProbeEffects[uiProbeCount] = p-&gt;getProbeEffect();
<a name="l00430"></a>00430             m_ppdPM[0][uiProbeCount] = p-&gt;getIntensity();
<a name="l00431"></a>00431             vIntensities.set(uiProbeCount, p-&gt;getIntensity());
<a name="l00432"></a>00432             m_ppdMM[0][uiProbeCount] = 0;
<a name="l00433"></a>00433             m_ppdResiduals[0][uiProbeCount] = 0;
<a name="l00434"></a>00434             uiProbeCount++;
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436         <span class="keywordflow">else</span>
<a name="l00437"></a>00437         {
<a name="l00438"></a>00438             <span class="comment">// Run plier</span>
<a name="l00439"></a>00439             errorCode = 0;
<a name="l00440"></a>00440             m_pdChipEffects[0] = 0;
<a name="l00441"></a>00441             m_pPlier-&gt;setNumFeature(uiProbeCount);
<a name="l00442"></a>00442             m_pPlier-&gt;run(&amp;errorCode);
<a name="l00443"></a>00443             <span class="keywordflow">if</span> (errorCode != 0) {<a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Problem running plier. Error code: &quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(errorCode));}
<a name="l00444"></a>00444             setProbeSetSignal(pPrev, m_pdChipEffects[0], vIntensities.median(uiProbeCount));
<a name="l00445"></a>00445 
<a name="l00446"></a>00446             <span class="comment">// Setup for next plier run</span>
<a name="l00447"></a>00447             pPrev = p;
<a name="l00448"></a>00448             m_pdProbeEffects[0] = p-&gt;getProbeEffect();
<a name="l00449"></a>00449             m_ppdPM[0][0] = p-&gt;getIntensity();
<a name="l00450"></a>00450             vIntensities.set(0, p-&gt;getIntensity());
<a name="l00451"></a>00451             m_ppdMM[0][0] = 0;
<a name="l00452"></a>00452             m_ppdResiduals[0][0] = 0;
<a name="l00453"></a>00453             uiProbeCount = 1;
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456     <span class="keywordflow">if</span> (pPrev != NULL)
<a name="l00457"></a>00457     {
<a name="l00458"></a>00458         <span class="comment">// Run plier</span>
<a name="l00459"></a>00459         errorCode = 0;
<a name="l00460"></a>00460         m_pdChipEffects[0] = 0;
<a name="l00461"></a>00461         m_pPlier-&gt;setNumFeature(uiProbeCount);
<a name="l00462"></a>00462         m_pPlier-&gt;run(&amp;errorCode);
<a name="l00463"></a>00463         <span class="keywordflow">if</span> (errorCode != 0) {<a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Problem running plier. Error code: &quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(errorCode));}
<a name="l00464"></a>00464         setProbeSetSignal(pPrev, m_pdChipEffects[0], vIntensities.median(uiProbeCount));
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::setProbeSetSignal(<a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p, <span class="keywordtype">double</span> dSignal, <span class="keywordtype">double</span> dMedianIntensity)
<a name="l00469"></a>00469 {
<a name="l00470"></a>00470     <span class="keywordflow">if</span> (p-&gt;getAllele() == 0)
<a name="l00471"></a>00471     {
<a name="l00472"></a>00472         <span class="keywordtype">float</span> fSignal = (float)dSignal;
<a name="l00473"></a>00473         getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;setAAlleleSignal((<span class="keywordtype">float</span>)(fSignal / 2.0));
<a name="l00474"></a>00474         getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;setBAlleleSignal((<span class="keywordtype">float</span>)(fSignal / 2.0));
<a name="l00475"></a>00475         getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;setAMedianIntensity((<span class="keywordtype">float</span>)(dMedianIntensity / 2.0));
<a name="l00476"></a>00476         getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;setBMedianIntensity((<span class="keywordtype">float</span>)(dMedianIntensity / 2.0));
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478     <span class="keywordflow">else</span>
<a name="l00479"></a>00479     {
<a name="l00480"></a>00480         <span class="keywordflow">if</span> (p-&gt;getAllele() == <span class="charliteral">&#39;A&#39;</span>)
<a name="l00481"></a>00481         {
<a name="l00482"></a>00482             getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;setAAlleleSignal((<span class="keywordtype">float</span>)dSignal);
<a name="l00483"></a>00483             getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;setAMedianIntensity((<span class="keywordtype">float</span>)dMedianIntensity);
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;getAllele() == <span class="charliteral">&#39;B&#39;</span>)
<a name="l00486"></a>00486         {
<a name="l00487"></a>00487             getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;setBAlleleSignal((<span class="keywordtype">float</span>)dSignal);
<a name="l00488"></a>00488             getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex())-&gt;setBMedianIntensity((<span class="keywordtype">float</span>)dMedianIntensity);
<a name="l00489"></a>00489         }
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491 }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::calculateGenotypes()
<a name="l00494"></a>00494 {
<a name="l00495"></a>00495     <span class="comment">//set(&quot;brlmmp-parameters&quot;, &quot;CM=2.bins=100.mix=1.bic=2.HARD=3.SB=0.45.KX=1.KH=1.5.KXX=0.5.KAH=-0.6.KHB=-0.6.transform=MVA.AAM=2.0.BBM=-2.0.AAV=0.06.BBV=0.06.ABV=0.06.copyqc=0.wobble=0.05.MS=1&quot;)</span>
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <span class="keywordtype">bool</span> bCyto2 = ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)));
<a name="l00498"></a>00498     <a class="code" href="classsnp__param.html" title="this holds all the parameters for a snp, including alg choices">snp_param</a> sp;
<a name="l00499"></a>00499     initializeSnpParameters(sp, 2);
<a name="l00500"></a>00500     setBrlmmpParameters(sp);
<a name="l00501"></a>00501     <span class="keywordflow">if</span> (!bCyto2) {loadSnpDistributions();}
<a name="l00502"></a>00502     vector&lt;affx::GType&gt; tcall(1);
<a name="l00503"></a>00503     vector&lt;double&gt; tconf(1);
<a name="l00504"></a>00504     vector&lt;double&gt; tx(1);
<a name="l00505"></a>00505     vector&lt;double&gt; ty(1);
<a name="l00506"></a>00506     vector&lt;int&gt; GenoHint(1);
<a name="l00507"></a>00507     vector&lt;double&gt; SubsetInbredPenalty(1);
<a name="l00508"></a>00508     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeSetIndex = 0; (iProbeSetIndex &lt; getProbeSets()-&gt;getCount()); iProbeSetIndex++)
<a name="l00509"></a>00509     {
<a name="l00510"></a>00510         <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* p = getProbeSets()-&gt;getAt(iProbeSetIndex);
<a name="l00511"></a>00511         <span class="keywordflow">if</span> ((bCyto2) &amp;&amp; (p-&gt;getGenotypeCall() != -1)) {
<a name="l00512"></a>00512             <span class="keywordflow">continue</span>;
<a name="l00513"></a>00513         }
<a name="l00514"></a>00514         p-&gt;setGenotypeCall(-1);
<a name="l00515"></a>00515         p-&gt;setGenotypeConfidence(0);
<a name="l00516"></a>00516         <span class="keywordflow">if</span> (p-&gt;getSnpDistribution() != NULL)
<a name="l00517"></a>00517         {
<a name="l00518"></a>00518             <a class="code" href="classsnp__param.html" title="this holds all the parameters for a snp, including alg choices">snp_param</a> tsp;
<a name="l00519"></a>00519             tsp.<a class="code" href="classsnp__param.html#a73c1d4ba7af3924f444007aaa2e802ce" title="copy parameters">copy</a>(sp); <span class="comment">// duplicate current parameters to keep commands</span>
<a name="l00520"></a>00520             tsp.<a class="code" href="classsnp__param.html#a5e4855e2b4b0dbd944e007f71f81a362" title="only one copy, for example, XY snps">copynumber</a> = 2; <span class="comment">// what copy for this snp so know right model centers</span>
<a name="l00521"></a>00521             <span class="keywordflow">if</span> (getExperiment()-&gt;getRawIntensityRatioGenderAsInt() == <a class="code" href="namespaceaffx.html#a1c064510a1a9f30814f840025d73d669afdfe578a9e9044b7b274b736ed341a81" title="Has XY chromosomes.">affx::Male</a>)
<a name="l00522"></a>00522             {
<a name="l00523"></a>00523                 <span class="keywordflow">if</span> ((p-&gt;getChromosome() == m_iXChromosome) &amp;&amp; (!p-&gt;isPseudoAutosomalRegion())) {tsp.<a class="code" href="classsnp__param.html#a5e4855e2b4b0dbd944e007f71f81a362" title="only one copy, for example, XY snps">copynumber</a> = 1;}
<a name="l00524"></a>00524                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;getChromosome() == m_iYChromosome) {tsp.<a class="code" href="classsnp__param.html#a5e4855e2b4b0dbd944e007f71f81a362" title="only one copy, for example, XY snps">copynumber</a> = 1;}
<a name="l00525"></a>00525             }
<a name="l00526"></a>00526             <span class="keywordflow">else</span>
<a name="l00527"></a>00527             {
<a name="l00528"></a>00528                 <span class="keywordflow">if</span> (p-&gt;getChromosome() == m_iYChromosome) {
<a name="l00529"></a>00529                     <span class="keywordflow">continue</span>;
<a name="l00530"></a>00530                 }
<a name="l00531"></a>00531             }
<a name="l00532"></a>00532             tsp.prior.Copy(*p-&gt;getSnpDistribution());
<a name="l00533"></a>00533             <span class="comment">// note: using temporary copy of main parameters tsp</span>
<a name="l00534"></a>00534             tcall[0] = affx::NN;
<a name="l00535"></a>00535             tconf[0] = 0;
<a name="l00536"></a>00536             tx[0] = p-&gt;getAAlleleSignal();
<a name="l00537"></a>00537             ty[0] = p-&gt;getBAlleleSignal();
<a name="l00538"></a>00538             GenoHint[0] = -1;
<a name="l00539"></a>00539             SubsetInbredPenalty[0] = 0; <span class="comment">// null parameter</span>
<a name="l00540"></a>00540             <a class="code" href="GenoUtility_8cpp.html#a1a2531d6033d567af0446274e94f74a4" title="transform the data vector">GenoUtility_transformData</a>(tx, ty, <a class="code" href="GenoUtility_8h.html#a0176e2f61ce5ea7a3495a511cf46b2c1a6db9488b39205827082e765aa0e87297" title="Minus Vs Average.">MvA</a>, 1);
<a name="l00541"></a>00541             <a class="code" href="snp_8label_8cpp.html#a1050ceb8ac15c0c39cffa4dbf76709b3" title="The master routine: takes data and turns it into genotypes with no seeds needed.">bayes_label</a>(tcall,tconf,tx,ty,GenoHint,SubsetInbredPenalty,tsp);
<a name="l00542"></a>00542             p-&gt;setGenotypeCall(<a class="code" href="namespaceaffx.html#ac9e9039b462ebd2bec646ed4c5ff1122" title="Convert a GType enum to an external integer value ///.">affx::GType_to_int</a>(tcall[0]));
<a name="l00543"></a>00543             p-&gt;setGenotypeConfidence((<span class="keywordtype">float</span>)tconf[0]);
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546 }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::newProbes()
<a name="l00549"></a>00549 {
<a name="l00550"></a>00550     <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strReferenceFileName = m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;reference-file&quot;</span>);
<a name="l00551"></a>00551     <a class="code" href="classaffx_1_1File5__File.html">affx::File5_File</a> file5;
<a name="l00552"></a>00552     <a class="code" href="classaffx_1_1File5__Group.html">affx::File5_Group</a>* group5 = NULL;
<a name="l00553"></a>00553     <a class="code" href="classaffx_1_1File5__Tsv.html">affx::File5_Tsv</a>* tsv5 = NULL;
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     <span class="keywordtype">int</span> iCount = 0;
<a name="l00556"></a>00556     <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)))
<a name="l00557"></a>00557     {
<a name="l00558"></a>00558         iCount = <a class="code" href="classaffx_1_1File5__Tsv.html#a70d378884ad8debef8c9e7200263fb67" title="Look inside the file and get the count of rows of a tsv ///.">affx::File5_Tsv::getFileTsvLineCount</a>(strReferenceFileName, <span class="stringliteral">&quot;Cyto2&quot;</span>, <span class="stringliteral">&quot;ProbeEffects&quot;</span>);
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560     <span class="keywordflow">else</span>
<a name="l00561"></a>00561     {
<a name="l00562"></a>00562         iCount = <a class="code" href="classaffx_1_1File5__Tsv.html#a70d378884ad8debef8c9e7200263fb67" title="Look inside the file and get the count of rows of a tsv ///.">affx::File5_Tsv::getFileTsvLineCount</a>(strReferenceFileName, <span class="stringliteral">&quot;CN5&quot;</span>, <span class="stringliteral">&quot;CN5.plier.feature-response&quot;</span>);
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     <span class="keywordflow">if</span> (iCount &lt;= 0) {<span class="keywordflow">throw</span>(<a class="code" href="classExcept.html" title="General purpose exception error for error handling.">Except</a>(<span class="stringliteral">&quot;Cannot find any probes in the CN reference file to process.&quot;</span>));}
<a name="l00565"></a>00565     file5.open(strReferenceFileName, affx::FILE5_OPEN_RO);
<a name="l00566"></a>00566     <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)))
<a name="l00567"></a>00567     {
<a name="l00568"></a>00568         group5 = file5.openGroup(<span class="stringliteral">&quot;Cyto2&quot;</span>, affx::FILE5_OPEN);
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570     <span class="keywordflow">else</span>
<a name="l00571"></a>00571     {
<a name="l00572"></a>00572         group5 = file5.openGroup(<span class="stringliteral">&quot;CN5&quot;</span>, affx::FILE5_OPEN);
<a name="l00573"></a>00573     }
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     m_pProbes = <span class="keyword">new</span> <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>[iCount];
<a name="l00576"></a>00576     <span class="keywordtype">int</span> i = 0;
<a name="l00577"></a>00577     <span class="keywordtype">double</span> d = 0;
<a name="l00578"></a>00578     <span class="keywordtype">float</span> f = 0;
<a name="l00579"></a>00579     <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> str;
<a name="l00580"></a>00580     <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a> ps;
<a name="l00581"></a>00581     <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)))
<a name="l00582"></a>00582     {
<a name="l00583"></a>00583         tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;ProbeEffects&quot;</span>, affx::FILE5_OPEN);
<a name="l00584"></a>00584         <span class="keywordflow">if</span> (tsv5-&gt;getColumnCount(0) &lt; 5) {<a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;The CN Reference file is missing data required by CNAnalysisMethodChipstream::newProbes() &quot;</span>);}
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586     <span class="keywordflow">else</span>
<a name="l00587"></a>00587     {
<a name="l00588"></a>00588         tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;CN5.plier.feature-response&quot;</span>, affx::FILE5_OPEN);
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiIndex = 0;
<a name="l00591"></a>00591     <span class="keywordflow">while</span> (tsv5-&gt;nextLine() == affx::FILE5_OK)
<a name="l00592"></a>00592     {
<a name="l00593"></a>00593         tsv5-&gt;get(0, 0, &amp;i); m_pProbes[uiIndex].setProbeID(i);
<a name="l00594"></a>00594         tsv5-&gt;get(0, 1, &amp;d); m_pProbes[uiIndex].setProbeEffect(d);
<a name="l00595"></a>00595 
<a name="l00596"></a>00596         <span class="keywordflow">if</span> (tsv5-&gt;getColumnDtype(0,2) == affx::FILE5_DTYPE_INT)
<a name="l00597"></a>00597         {
<a name="l00598"></a>00598             tsv5-&gt;get(0, 2, &amp;i); m_pProbes[uiIndex].setProbeSetIndex(i);
<a name="l00599"></a>00599             tsv5-&gt;get(0, 3, &amp;i); m_pProbes[uiIndex].setAllele((<span class="keywordtype">char</span>)i);
<a name="l00600"></a>00600             tsv5-&gt;get(0, 4, &amp;f); m_pProbes[uiIndex].setMedianIntensity(f);
<a name="l00601"></a>00601             uiIndex++;
<a name="l00602"></a>00602         }
<a name="l00603"></a>00603         <span class="keywordflow">else</span>
<a name="l00604"></a>00604         {
<a name="l00605"></a>00605             tsv5-&gt;get(0, 2, &amp;str);
<a name="l00606"></a>00606             <span class="keywordflow">if</span> ((str.endsWith(<span class="stringliteral">&quot;-A&quot;</span>)) || (str.endsWith(<span class="stringliteral">&quot;-B&quot;</span>)))
<a name="l00607"></a>00607             {
<a name="l00608"></a>00608                 str = str.substring(0, str.length() - 2);
<a name="l00609"></a>00609             }
<a name="l00610"></a>00610             ps.setProbeSetName(str);
<a name="l00611"></a>00611             <span class="keywordtype">int</span> iSearchIndex = m_pvProbeSets-&gt;binarySearch(ps, 0);
<a name="l00612"></a>00612             <span class="keywordflow">if</span> (iSearchIndex != -1)
<a name="l00613"></a>00613             {
<a name="l00614"></a>00614                 m_pProbes[uiIndex].setProbeSetIndex(iSearchIndex);
<a name="l00615"></a>00615                 uiIndex++;
<a name="l00616"></a>00616             } <span class="keywordflow">else</span> {iCount--;}
<a name="l00617"></a>00617         }
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619     tsv5-&gt;close();
<a name="l00620"></a>00620     <span class="keyword">delete</span> tsv5;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     group5-&gt;close();
<a name="l00623"></a>00623     <span class="keyword">delete</span> group5;
<a name="l00624"></a>00624     file5.close();
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     m_pvProbes = <span class="keyword">new</span> <a class="code" href="classCNProbeArray.html" title="A vector of CNProbe pointers.">CNProbeArray</a>;
<a name="l00627"></a>00627     m_pvProbes-&gt;reserve(iCount);
<a name="l00628"></a>00628     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeIndex = 0; (iProbeIndex &lt; iCount); iProbeIndex++)
<a name="l00629"></a>00629     {
<a name="l00630"></a>00630         m_pvProbes-&gt;add(&amp;m_pProbes[iProbeIndex]);
<a name="l00631"></a>00631     }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     <span class="comment">// Initialize the adapter type normalization</span>
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (!m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>))
<a name="l00635"></a>00635     {
<a name="l00636"></a>00636         <a class="code" href="classChipLayout.html" title="ChipLayout - Data structure to represent the probesets encoded in the CDF, SPF or PGF files which def...">ChipLayout</a>* pLayout = <span class="keyword">new</span> <a class="code" href="classChipLayout.html" title="ChipLayout - Data structure to represent the probesets encoded in the CDF, SPF or PGF files which def...">ChipLayout</a>;
<a name="l00637"></a>00637         <a class="code" href="classCNAnalysisMethodReference.html#ac4ced7757fd883ecc751be2c10d073d5" title="Utility function for reading a ChipLayout based on the options passed to the base engine (i...">CNAnalysisMethodReference::loadLayout</a>(pLayout,m_pEngine);
<a name="l00638"></a>00638         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeIndex = 0; (iProbeIndex &lt; iCount); iProbeIndex++)
<a name="l00639"></a>00639         {
<a name="l00640"></a>00640             <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* probe = m_pvProbes-&gt;at(iProbeIndex);
<a name="l00641"></a>00641             <span class="keywordflow">if</span> (probe-&gt;getProbeSetIndex() == -1) {<span class="keywordflow">continue</span>;}
<a name="l00642"></a>00642             <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strProbeSetName = m_pvProbeSets-&gt;at(probe-&gt;getProbeSetIndex())-&gt;getProbeSetName();
<a name="l00643"></a>00643 
<a name="l00644"></a>00644             <a class="code" href="classProbeListPacked.html">ProbeListPacked</a> pList = pLayout-&gt;<a class="code" href="classChipLayout.html#ae465f92816b1c9983a45d1f73293cc7b" title="Find a probe set using the name as a key.">getProbeListByName</a>(strProbeSetName);
<a name="l00645"></a>00645             <span class="keywordflow">if</span> (!pList.isNull())
<a name="l00646"></a>00646             {
<a name="l00647"></a>00647                 <a class="code" href="classProbeSet.html" title="Collection of atoms that measure target that should be absent or present at the same time...">ProbeSet</a>* ps = <a class="code" href="classProbeListFactory.html#aaed559bbfe723ed4fe225f805a2411e8">ProbeListFactory::asProbeSet</a>(pList);
<a name="l00648"></a>00648                 <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="classProbeSet.html#aa3e4170184169cc3bee6d958d74940ba" title="What type of probeset is this?">psType</a> == ProbeSet::GenoType) || (ps-&gt;<a class="code" href="classProbeSet.html#aa3e4170184169cc3bee6d958d74940ba" title="What type of probeset is this?">psType</a> == ProbeSet::Copynumber) || (strProbeSetName.startsWith(<span class="stringliteral">&quot;anti&quot;</span>)))
<a name="l00649"></a>00649                 {
<a name="l00650"></a>00650                     <span class="keywordtype">int</span> iAtomCount = 0;
<a name="l00651"></a>00651                     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iGroupIndex = 0; (iGroupIndex &lt; ps-&gt;<a class="code" href="classProbeSet.html#a6d8ed948634c42033bd0c35d2640b274" title="How many groups (or blocks) are there? Used extensively in genotyping chips.">numGroups</a>); iGroupIndex++)
<a name="l00652"></a>00652                     {
<a name="l00653"></a>00653                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iAtomIndex = 0; (iAtomIndex &lt; ps-&gt;<a class="code" href="classProbeSet.html#a23b9df97be8aacc01ad21642b8c966b9" title="Number of atoms in each group, used to get the offsets into the atoms vector.">atomsPerGroup</a>[iGroupIndex]); iAtomIndex++)
<a name="l00654"></a>00654                         {
<a name="l00655"></a>00655                             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iProbeIndex = 0; (iProbeIndex &lt; ps-&gt;<a class="code" href="classProbeSet.html#ab92eb06095441bf193a6fce3f758540b" title="Atoms that make up this probe set.">atoms</a>[iAtomCount]-&gt;probes.size()); iProbeIndex++)
<a name="l00656"></a>00656                             {
<a name="l00657"></a>00657                                 <span class="keywordflow">if</span> (Probe::isPm(*ps-&gt;<a class="code" href="classProbeSet.html#ab92eb06095441bf193a6fce3f758540b" title="Atoms that make up this probe set.">atoms</a>[iAtomCount]-&gt;probes[iProbeIndex]))
<a name="l00658"></a>00658                                 {
<a name="l00659"></a>00659                                     <span class="keywordtype">int</span> uiIndex = ps-&gt;<a class="code" href="classProbeSet.html#ab92eb06095441bf193a6fce3f758540b" title="Atoms that make up this probe set.">atoms</a>[iAtomCount]-&gt;probes[iProbeIndex]-&gt;id;
<a name="l00660"></a>00660                                     <span class="keywordflow">if</span> (probe-&gt;getProbeID() == (uiIndex + 1))
<a name="l00661"></a>00661                                     {
<a name="l00662"></a>00662                                         probe-&gt;setAllele(0);
<a name="l00663"></a>00663                                         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="classProbeSet.html#aa3e4170184169cc3bee6d958d74940ba" title="What type of probeset is this?">psType</a> == ProbeSet::GenoType)
<a name="l00664"></a>00664                                         {
<a name="l00665"></a>00665                                             <span class="keywordflow">if</span> ((iGroupIndex % 2) == 0)
<a name="l00666"></a>00666                                             {
<a name="l00667"></a>00667                                                 probe-&gt;setAllele(<span class="charliteral">&#39;A&#39;</span>);
<a name="l00668"></a>00668                                             }
<a name="l00669"></a>00669                                             <span class="keywordflow">else</span>
<a name="l00670"></a>00670                                             {
<a name="l00671"></a>00671                                                 probe-&gt;setAllele(<span class="charliteral">&#39;B&#39;</span>);
<a name="l00672"></a>00672                                             }
<a name="l00673"></a>00673                                         }
<a name="l00674"></a>00674                                     }
<a name="l00675"></a>00675                                 }
<a name="l00676"></a>00676                             }
<a name="l00677"></a>00677                             iAtomCount++;
<a name="l00678"></a>00678                         }
<a name="l00679"></a>00679                     }
<a name="l00680"></a>00680                 }
<a name="l00681"></a>00681                 <span class="keyword">delete</span> ps;
<a name="l00682"></a>00682             }
<a name="l00683"></a>00683         }
<a name="l00684"></a>00684         <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;adapter-type-normalization&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;adapter-type-normalization&quot;</span>)))
<a name="l00685"></a>00685         {
<a name="l00686"></a>00686             m_pobjAdapterTypeNormTran = <span class="keyword">new</span> <a class="code" href="classAdapterTypeNormTran.html" title="AdapterTypeNormTran - Class for doing adapter type normalization.">AdapterTypeNormTran</a>(0.8287, 0.7960, 1.4218, 0.9954, 1.63920);
<a name="l00687"></a>00687             m_pobjAdapterTypeNormTran-&gt;setup(m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;annotation-file&quot;</span>), pLayout, 1);
<a name="l00688"></a>00688         }
<a name="l00689"></a>00689         calculateRawSNPQCs(pLayout);
<a name="l00690"></a>00690 
<a name="l00691"></a>00691         <span class="keyword">delete</span> pLayout;
<a name="l00692"></a>00692     }
<a name="l00693"></a>00693 }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::calculateRawSNPQCs(<a class="code" href="classChipLayout.html" title="ChipLayout - Data structure to represent the probesets encoded in the CDF, SPF or PGF files which def...">ChipLayout</a>* pLayout)
<a name="l00696"></a>00696 {
<a name="l00697"></a>00697     <a class="code" href="classAffxArray.html">AffxArray&lt;AffxString&gt;</a> arSNPIds;
<a name="l00698"></a>00698     <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;snp-qc-snp-list&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;snp-qc-snp-list&quot;</span>) != <span class="stringliteral">&quot;&quot;</span>))
<a name="l00699"></a>00699     {
<a name="l00700"></a>00700       <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">affx::TsvFile</a> tsv;
<a name="l00701"></a>00701       tsv.<a class="code" href="classaffx_1_1TsvFile.html#a0b08c1eea21d4b6a893f57df16521a46" title="remove whitespace from value?">m_optAutoTrim</a> = <span class="keyword">true</span>;
<a name="l00702"></a>00702       <span class="keywordflow">if</span> ( tsv.<a class="code" href="classaffx_1_1TsvFile.html#a28ad46dc5cadab63edc56cb5f36a0efe" title="Opens a file as a table.">openTable</a>(m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;snp-qc-snp-list&quot;</span>)) == <a class="code" href="namespaceaffx.html#ad00847b6f358e7269f493808ee6bd395a05b4d7241e83bd24a318f4caa49b284e" title="No Error.">affx::TSV_OK</a>) {
<a name="l00703"></a>00703         std::string snp;
<a name="l00704"></a>00704         <span class="keywordflow">while</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0) == affx::TSV_OK) {
<a name="l00705"></a>00705           tsv.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,0,snp);
<a name="l00706"></a>00706           arSNPIds.add(<span class="keyword">new</span> <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a>(snp));
<a name="l00707"></a>00707         }
<a name="l00708"></a>00708         tsv.<a class="code" href="classaffx_1_1TsvFile.html#a6a397412f48d477d0e87b00f914d06f7" title="Closes the file and clears bindings and other info.">clear</a>();
<a name="l00709"></a>00709       }
<a name="l00710"></a>00710     }
<a name="l00711"></a>00711     arSNPIds.quickSort(0);
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     vector&lt;string&gt; probeSetNames;
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (arSNPIds.empty()) {
<a name="l00715"></a>00715         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; iIndex &lt; m_pvProbeSets-&gt;getCount(); iIndex++) {
<a name="l00716"></a>00716             <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pobjProbeSet = m_pvProbeSets-&gt;at(iIndex);
<a name="l00717"></a>00717             <span class="keywordflow">if</span> (pobjProbeSet-&gt;processAsVisualization())
<a name="l00718"></a>00718             {
<a name="l00719"></a>00719                 probeSetNames.push_back(pobjProbeSet-&gt;getProbeSetName());
<a name="l00720"></a>00720             }
<a name="l00721"></a>00721         }
<a name="l00722"></a>00722     } <span class="keywordflow">else</span> {
<a name="l00723"></a>00723         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; iIndex &lt; m_pvProbeSets-&gt;getCount(); iIndex++) {
<a name="l00724"></a>00724             <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pobjProbeSet = m_pvProbeSets-&gt;at(iIndex);
<a name="l00725"></a>00725             <span class="keywordflow">if</span> (pobjProbeSet-&gt;processAsVisualization())
<a name="l00726"></a>00726             {
<a name="l00727"></a>00727                 <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> str = pobjProbeSet-&gt;getProbeSetName();
<a name="l00728"></a>00728                 <span class="keywordflow">if</span> (arSNPIds.binarySearch(str, 0) != -1)
<a name="l00729"></a>00729                 {
<a name="l00730"></a>00730                     probeSetNames.push_back(pobjProbeSet-&gt;getProbeSetName());
<a name="l00731"></a>00731                 }
<a name="l00732"></a>00732             }
<a name="l00733"></a>00733         }
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735     arSNPIds.deleteAll();
<a name="l00736"></a>00736 
<a name="l00737"></a>00737     <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="Util_8h.html#a18af743c2cec4baeee9ffb27999ddaad" title="Log base two.">log2</a> = log(2.0);
<a name="l00738"></a>00738     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; iIndex &lt; getExperiments()-&gt;size(); iIndex++)
<a name="l00739"></a>00739     {
<a name="l00740"></a>00740         <a class="code" href="classCNExperiment.html" title="A class for storing CNExperiment data.">CNExperiment</a>* pExperiment = getExperiments()-&gt;getAt(iIndex);
<a name="l00741"></a>00741         vector&lt;double&gt; vData;
<a name="l00742"></a>00742 
<a name="l00743"></a>00743         vector&lt;string&gt; celFileNames;
<a name="l00744"></a>00744         <span class="keywordtype">string</span> cel = (m_pEngine-&gt;<a class="code" href="classOptions.html#ab20d0083424d9d9a8b94da46f487f57a" title="Return a vector of values for a particular option.">getOptVector</a>(<span class="stringliteral">&quot;cels&quot;</span>))[pExperiment-&gt;getIndex()];
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         celFileNames.push_back(cel);
<a name="l00747"></a>00747         vector&lt;int&gt; dummy_order(pLayout-&gt;<a class="code" href="classChipLayout.html#abedbffee7c6a978e3e5545d659a78ec7" title="Get the total number of probes on this chip.">getProbeCount</a>());
<a name="l00748"></a>00748         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; pLayout-&gt;<a class="code" href="classChipLayout.html#abedbffee7c6a978e3e5545d659a78ec7" title="Get the total number of probes on this chip.">getProbeCount</a>(); i++) {
<a name="l00749"></a>00749             dummy_order[i] = i;
<a name="l00750"></a>00750         }
<a name="l00751"></a>00751         <a class="code" href="classChipStream.html" title="ChipStream - base class for objects that can initialize themselves one at a time and transform intens...">ChipStream</a> *chipStream = 0;
<a name="l00752"></a>00752         <span class="keywordtype">string</span> junk;
<a name="l00753"></a>00753         <a class="code" href="classChipStreamFactory.html" title="Factory class for making chip streams based on a string representation.">ChipStreamFactory</a> chipStreamFactory;
<a name="l00754"></a>00754         chipStream = chipStreamFactory.<a class="code" href="classChipStreamFactory.html#a810e174b77b80386beaec95a8754466d" title="Factory for making ChipStreams from a string description.">chipStreamForString</a>(<span class="stringliteral">&quot;no-trans&quot;</span>, *pLayout, junk);
<a name="l00755"></a>00755         <a class="code" href="classSparseMart.html" title="SparseMart Class for representing only a subset of cel file intensity data in memory.">SparseMart</a> *sparseMart = <span class="keyword">new</span> <a class="code" href="classSparseMart.html" title="SparseMart Class for representing only a subset of cel file intensity data in memory.">SparseMart</a>(dummy_order, celFileNames, <span class="keyword">true</span>);
<a name="l00756"></a>00756         dummy_order.clear();
<a name="l00757"></a>00757         vector&lt;int&gt;().swap(dummy_order);   <span class="comment">// release memory</span>
<a name="l00758"></a>00758 
<a name="l00759"></a>00759         <a class="code" href="classCelReader.html" title="Class for reading cel files and passing the data to memory representation and analysis objects...">CelReader</a> celReader;
<a name="l00760"></a>00760         celReader.<a class="code" href="classIntensityReader.html#a0124349ddc9af057e80f05dcd9557deb" title="Set the names of the files to read data from.">setFiles</a>(celFileNames);
<a name="l00761"></a>00761         celReader.<a class="code" href="classIntensityReader.html#a09f2f97ab0ba20f77f4fba6cc8644a5c" title="Push this chip stream onto the collection that will receive data.">registerStream</a>(chipStream);
<a name="l00762"></a>00762         celReader.<a class="code" href="classIntensityReader.html#abd0311ffde07633f1ecb5dec205732a4" title="Push an intensity mart onto the list of those that should receive data.">registerIntensityMart</a>(sparseMart);
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         celReader.<a class="code" href="classCelReader.html#a9966a326c023b7048e732db3c657913f" title="Do the heavy lifting of reading data from the cel files and passing to all the streams and intensity ...">readFiles</a>();
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         vector&lt;int&gt; probeIds;
<a name="l00767"></a>00767         vector&lt;double&gt; probeIntensities;
<a name="l00768"></a>00768         <span class="keywordflow">for</span> (vector&lt;string&gt;::iterator it = probeSetNames.begin(); it != probeSetNames.end(); ++it) {
<a name="l00769"></a>00769             probeIds.clear();
<a name="l00770"></a>00770             probeIntensities.clear();
<a name="l00771"></a>00771             <a class="code" href="classProbeListPacked.html">ProbeListPacked</a> probeset = pLayout-&gt;<a class="code" href="classChipLayout.html#ae465f92816b1c9983a45d1f73293cc7b" title="Find a probe set using the name as a key.">getProbeListByName</a>(*it);
<a name="l00772"></a>00772             <span class="keywordflow">if</span> (probeset.isNull()) {
<a name="l00773"></a>00773                 <a class="code" href="classVerbose.html#a34e1d936178741eeb78de93c5497e1b8" title="Print a warning message.">Verbose::warn</a>(0, <span class="stringliteral">&quot;Empty probe set &#39;&quot;</span> + *it + <span class="stringliteral">&quot;&#39; found in cel file &quot;</span> + cel +
<a name="l00774"></a>00774                                  <span class="stringliteral">&quot; while calculating SNPQC. This probe set will be ignored.&quot;</span>);
<a name="l00775"></a>00775                 <span class="keywordflow">continue</span>;
<a name="l00776"></a>00776             }
<a name="l00777"></a>00777             probeset.get_probeIds(probeIds);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> idx=0; idx &lt; probeIds.size(); idx++) {
<a name="l00780"></a>00780                 probeIntensities.push_back(chipStream-&gt;<a class="code" href="classChipStream.html#a79c1b8891ac313f3438d259f6fb72800" title="Retrieve intensity from resident DiskIntensityMart.">getTransformedIntensity</a>(probeIds[idx], 0));
<a name="l00781"></a>00781             }
<a name="l00782"></a>00782             vector&lt;double&gt;::iterator iterMedianA = probeIntensities.begin() + probeIntensities.size()/4;
<a name="l00783"></a>00783             vector&lt;double&gt;::iterator iterEndA    = probeIntensities.begin() + probeIntensities.size()/2;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785             vector&lt;double&gt;::iterator iterMedianB = probeIntensities.begin() + (3*probeIntensities.size())/4;
<a name="l00786"></a>00786             vector&lt;double&gt;::iterator iterStartB  = probeIntensities.begin() + probeIntensities.size()/2;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788             std::nth_element(probeIntensities.begin(), iterMedianA, iterEndA);
<a name="l00789"></a>00789             std::nth_element(iterStartB, iterMedianB, probeIntensities.end());
<a name="l00790"></a>00790 
<a name="l00791"></a>00791             <span class="keywordflow">if</span> (*iterMedianA &lt; 0.0 || *iterMedianB &lt; 0.0) {
<a name="l00792"></a>00792                 <a class="code" href="classVerbose.html#a34e1d936178741eeb78de93c5497e1b8" title="Print a warning message.">Verbose::warn</a>(0, <span class="stringliteral">&quot;Negative intensity found in CEL file &quot;</span> + cel +
<a name="l00793"></a>00793                                  <span class="stringliteral">&quot;. Probe set &#39;&quot;</span> + *it + <span class="stringliteral">&quot;&#39; ignored in SNPQC calculation.&quot;</span>);
<a name="l00794"></a>00794                 <span class="keywordflow">continue</span>;
<a name="l00795"></a>00795             }
<a name="l00796"></a>00796             vData.push_back(log((*iterMedianA)/(*iterMedianB))/log2);
<a name="l00797"></a>00797         }
<a name="l00798"></a>00798         <span class="keyword">delete</span> chipStream;
<a name="l00799"></a>00799         <span class="keyword">delete</span> sparseMart;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         pExperiment-&gt;setRawSNPQC(<a class="code" href="classHomHiLoCelListener.html#abd84bc7a9c7f6fc88d98145dde03be03" title="Calculate snpqc metric.">HomHiLoCelListener::computeSNPQC</a>(vData));
<a name="l00802"></a>00802     }
<a name="l00803"></a>00803 }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::newPlier(<span class="keywordtype">int</span> iChipCount)
<a name="l00806"></a>00806 {
<a name="l00807"></a>00807     m_iPlierChipCount = iChipCount;
<a name="l00808"></a>00808     <span class="comment">// Allocate memory for PLIER</span>
<a name="l00809"></a>00809     m_uiMaxProbeCount = m_pvProbes-&gt;getMaximumNumberProbesPerProbeSet();
<a name="l00810"></a>00810     m_pdProbeEffects = <span class="keyword">new</span> <span class="keywordtype">double</span>[m_uiMaxProbeCount];
<a name="l00811"></a>00811     m_pdChipEffects = <span class="keyword">new</span> <span class="keywordtype">double</span>[iChipCount];
<a name="l00812"></a>00812 
<a name="l00813"></a>00813     m_ppdPM = <span class="keyword">new</span> <span class="keywordtype">double</span> *[iChipCount];
<a name="l00814"></a>00814     m_ppdMM = <span class="keyword">new</span> <span class="keywordtype">double</span> *[iChipCount];
<a name="l00815"></a>00815     m_ppdResiduals = <span class="keyword">new</span> <span class="keywordtype">double</span> *[iChipCount];
<a name="l00816"></a>00816     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; iChipCount; i++)
<a name="l00817"></a>00817     {
<a name="l00818"></a>00818         m_ppdPM[i] = <span class="keyword">new</span> <span class="keywordtype">double</span>[m_uiMaxProbeCount];
<a name="l00819"></a>00819         m_ppdMM[i] = <span class="keyword">new</span> <span class="keywordtype">double</span>[m_uiMaxProbeCount];
<a name="l00820"></a>00820         m_ppdResiduals[i] = <span class="keyword">new</span> <span class="keywordtype">double</span>[m_uiMaxProbeCount];
<a name="l00821"></a>00821     }
<a name="l00822"></a>00822     m_pPlier = <span class="keyword">new</span> <a class="code" href="classcaffyplier.html">caffyplier</a>;
<a name="l00823"></a>00823     <span class="keywordflow">if</span> (iChipCount == 1)
<a name="l00824"></a>00824     {
<a name="l00825"></a>00825         m_pPlier-&gt;setPlierFitFeatureResponse(<span class="keyword">false</span>);
<a name="l00826"></a>00826         m_pPlier-&gt;setPlierUseInputModel(<span class="keyword">true</span>);
<a name="l00827"></a>00827         m_pPlier-&gt;setSafetyZero(0);
<a name="l00828"></a>00828     }
<a name="l00829"></a>00829     <span class="keywordflow">else</span>
<a name="l00830"></a>00830     {
<a name="l00831"></a>00831         m_pPlier-&gt;setPlierFitFeatureResponse(<span class="keyword">true</span>);
<a name="l00832"></a>00832         m_pPlier-&gt;setPlierUseInputModel(<span class="keyword">false</span>);
<a name="l00833"></a>00833         m_pPlier-&gt;setFixFeatureEffect(<span class="keyword">true</span>);
<a name="l00834"></a>00834     }
<a name="l00835"></a>00835     m_pPlier-&gt;setPM(m_ppdPM);
<a name="l00836"></a>00836     m_pPlier-&gt;setMM(m_ppdMM);
<a name="l00837"></a>00837     m_pPlier-&gt;setResiduals(m_ppdResiduals);
<a name="l00838"></a>00838     m_pPlier-&gt;setTargetResponse(m_pdChipEffects);
<a name="l00839"></a>00839     m_pPlier-&gt;setFeatureResponse(m_pdProbeEffects);
<a name="l00840"></a>00840     m_pPlier-&gt;setPlierOptOptimizationMethod(1);
<a name="l00841"></a>00841     m_pPlier-&gt;setNumExp(iChipCount);
<a name="l00842"></a>00842 }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::deletePlier()
<a name="l00845"></a>00845 {
<a name="l00846"></a>00846     <span class="comment">// Deallocate memory for plier</span>
<a name="l00847"></a>00847     <span class="keywordflow">if</span> (m_pPlier != NULL)
<a name="l00848"></a>00848     {
<a name="l00849"></a>00849         <span class="keyword">delete</span> [] m_pdProbeEffects;
<a name="l00850"></a>00850         <span class="keyword">delete</span> [] m_pdChipEffects;
<a name="l00851"></a>00851         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_iPlierChipCount; i++)
<a name="l00852"></a>00852         {
<a name="l00853"></a>00853             <span class="keyword">delete</span> [] m_ppdPM[i];
<a name="l00854"></a>00854             <span class="keyword">delete</span> [] m_ppdMM[i];
<a name="l00855"></a>00855             <span class="keyword">delete</span> [] m_ppdResiduals[i];
<a name="l00856"></a>00856         }
<a name="l00857"></a>00857         <span class="keyword">delete</span> [] m_ppdResiduals;
<a name="l00858"></a>00858         <span class="keyword">delete</span> [] m_ppdPM;
<a name="l00859"></a>00859         <span class="keyword">delete</span> [] m_ppdMM;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861         <span class="keyword">delete</span> m_pPlier;
<a name="l00862"></a>00862     }
<a name="l00863"></a>00863 }
<a name="l00864"></a>00864 
<a name="l00865"></a>00865 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::newSketch()
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867     <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strReferenceFileName = m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;reference-file&quot;</span>);
<a name="l00868"></a>00868     <a class="code" href="classaffx_1_1File5__File.html">affx::File5_File</a> file5;
<a name="l00869"></a>00869     <a class="code" href="classaffx_1_1File5__Group.html">affx::File5_Group</a>* group5 = NULL;
<a name="l00870"></a>00870     <a class="code" href="classaffx_1_1File5__Tsv.html">affx::File5_Tsv</a>* tsv5 = NULL;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872     <span class="comment">// load the sketch from the reference</span>
<a name="l00873"></a>00873     file5.open(strReferenceFileName, affx::FILE5_OPEN_RO);
<a name="l00874"></a>00874     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;doDualNormalization&quot;</span>) )
<a name="l00875"></a>00875     {
<a name="l00876"></a>00876         <span class="keywordflow">if</span>(m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>))
<a name="l00877"></a>00877         {
<a name="l00878"></a>00878             group5 = file5.openGroup(<span class="stringliteral">&quot;Cyto2&quot;</span>, affx::FILE5_OPEN);
<a name="l00879"></a>00879             tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;SketchSNP&quot;</span>, affx::FILE5_OPEN);
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881         <span class="keywordflow">else</span>
<a name="l00882"></a>00882         {
<a name="l00883"></a>00883             group5 = file5.openGroup(<span class="stringliteral">&quot;CopyNumber&quot;</span>, affx::FILE5_OPEN);
<a name="l00884"></a>00884             tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;SketchSNP&quot;</span>, affx::FILE5_OPEN);
<a name="l00885"></a>00885         }
<a name="l00886"></a>00886     }
<a name="l00887"></a>00887     <span class="keywordflow">else</span>
<a name="l00888"></a>00888     {
<a name="l00889"></a>00889         group5 = file5.openGroup(<span class="stringliteral">&quot;CN5&quot;</span>, affx::FILE5_OPEN);
<a name="l00890"></a>00890         tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;target-sketch&quot;</span>, affx::FILE5_OPEN);
<a name="l00891"></a>00891     }
<a name="l00892"></a>00892     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiSketchSize = 0;
<a name="l00893"></a>00893     <span class="keywordflow">while</span> (tsv5-&gt;nextLine() == affx::FILE5_OK)
<a name="l00894"></a>00894     {
<a name="l00895"></a>00895         uiSketchSize++;
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897     tsv5-&gt;close();
<a name="l00898"></a>00898     <span class="keyword">delete</span> tsv5;
<a name="l00899"></a>00899     m_pvChipSketch = <span class="keyword">new</span> std::vector&lt;float&gt;(uiSketchSize);
<a name="l00900"></a>00900     m_pvSNPReferenceSketch = <span class="keyword">new</span> std::vector&lt;float&gt;(uiSketchSize);
<a name="l00901"></a>00901     m_pvCNReferenceSketch = <span class="keyword">new</span> std::vector&lt;float&gt;(uiSketchSize);
<a name="l00902"></a>00902     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;doDualNormalization&quot;</span>))
<a name="l00903"></a>00903     {
<a name="l00904"></a>00904         tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;SketchSNP&quot;</span>, affx::FILE5_OPEN);
<a name="l00905"></a>00905     }
<a name="l00906"></a>00906     <span class="keywordflow">else</span>
<a name="l00907"></a>00907     {
<a name="l00908"></a>00908         tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;target-sketch&quot;</span>, affx::FILE5_OPEN);
<a name="l00909"></a>00909     }
<a name="l00910"></a>00910     <span class="keywordtype">double</span> d = 0;
<a name="l00911"></a>00911     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiSketchIndex = 0;
<a name="l00912"></a>00912     <span class="keywordflow">while</span> (tsv5-&gt;nextLine() == affx::FILE5_OK)
<a name="l00913"></a>00913     {
<a name="l00914"></a>00914         tsv5-&gt;get(0, 0, &amp;d); m_pvSNPReferenceSketch-&gt;at(uiSketchIndex) = (float)d;
<a name="l00915"></a>00915         uiSketchIndex++;
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917     tsv5-&gt;close();
<a name="l00918"></a>00918     <span class="keyword">delete</span> tsv5;
<a name="l00919"></a>00919     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;doDualNormalization&quot;</span>))
<a name="l00920"></a>00920     {
<a name="l00921"></a>00921         tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;SketchCN&quot;</span>, affx::FILE5_OPEN);
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923     <span class="keywordflow">else</span>
<a name="l00924"></a>00924     {
<a name="l00925"></a>00925         tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;target-sketch&quot;</span>, affx::FILE5_OPEN);
<a name="l00926"></a>00926     }
<a name="l00927"></a>00927     uiSketchIndex = 0;
<a name="l00928"></a>00928     <span class="keywordflow">while</span> (tsv5-&gt;nextLine() == affx::FILE5_OK)
<a name="l00929"></a>00929     {
<a name="l00930"></a>00930         tsv5-&gt;get(0, 0, &amp;d); m_pvCNReferenceSketch-&gt;at(uiSketchIndex) = (float)d;
<a name="l00931"></a>00931         uiSketchIndex++;
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933     tsv5-&gt;close();
<a name="l00934"></a>00934     <span class="keyword">delete</span> tsv5;
<a name="l00935"></a>00935     <span class="keywordflow">if</span> (group5 != NULL)
<a name="l00936"></a>00936     {
<a name="l00937"></a>00937         group5-&gt;close();
<a name="l00938"></a>00938         <span class="keyword">delete</span> group5;
<a name="l00939"></a>00939     }
<a name="l00940"></a>00940     file5.close();
<a name="l00941"></a>00941 }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::deleteSketch()
<a name="l00944"></a>00944 {
<a name="l00945"></a>00945     <span class="keywordflow">if</span> (m_pvSNPReferenceSketch != NULL)
<a name="l00946"></a>00946     {
<a name="l00947"></a>00947         <span class="keyword">delete</span> m_pvSNPReferenceSketch; m_pvSNPReferenceSketch = NULL;
<a name="l00948"></a>00948         <span class="keyword">delete</span> m_pvCNReferenceSketch; m_pvCNReferenceSketch = NULL;
<a name="l00949"></a>00949         <span class="keyword">delete</span> m_pvChipSketch; m_pvChipSketch = NULL;
<a name="l00950"></a>00950     }
<a name="l00951"></a>00951 }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::deleteProbes()
<a name="l00954"></a>00954 {
<a name="l00955"></a>00955     <span class="keywordflow">if</span> (m_pProbes != NULL)
<a name="l00956"></a>00956     {
<a name="l00957"></a>00957         <span class="keywordflow">if</span> (m_pobjAdapterTypeNormTran != NULL) {<span class="keyword">delete</span> m_pobjAdapterTypeNormTran; m_pobjAdapterTypeNormTran = NULL;}
<a name="l00958"></a>00958         m_pvProbes-&gt;nullAll(); <span class="keyword">delete</span> m_pvProbes; m_pvProbes = NULL;
<a name="l00959"></a>00959         <span class="keyword">delete</span>[] m_pProbes; m_pProbes = NULL;
<a name="l00960"></a>00960     }
<a name="l00961"></a>00961 }
<a name="l00962"></a>00962 
<a name="l00963"></a>00963 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::loadIntensities()
<a name="l00964"></a>00964 {
<a name="l00965"></a>00965     m_pvProbes-&gt;quickSort(1); <span class="comment">// by ProbeID</span>
<a name="l00966"></a>00966 
<a name="l00967"></a>00967     <span class="keyword">const</span> <span class="keywordtype">bool</span> isCytoScanHD = m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cytoscan-hd&quot;</span>);
<a name="l00968"></a>00968 
<a name="l00969"></a>00969     <span class="comment">// Load the raw intensities to use for the sketch</span>
<a name="l00970"></a>00970     <span class="keywordflow">if</span> (!m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cels&quot;</span>)) {<span class="keywordflow">throw</span>(<a class="code" href="classExcept.html" title="General purpose exception error for error handling.">Except</a>(<span class="stringliteral">&quot;Cannot determine CEL file for loading raw intensities.&quot;</span>));}
<a name="l00971"></a>00971     <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strCelFileName = m_pEngine-&gt;<a class="code" href="classOptions.html#ab20d0083424d9d9a8b94da46f487f57a" title="Return a vector of values for a particular option.">getOptVector</a>(<span class="stringliteral">&quot;cels&quot;</span>)[getExperiment()-&gt;getIndex()];
<a name="l00972"></a>00972     <a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html">affymetrix_fusion_io::FusionCELData</a> cel;
<a name="l00973"></a>00973     cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#af43c5c7a95f9f535883c1ddda0bea057">SetFileName</a>(strCelFileName.c_str());
<a name="l00974"></a>00974     <span class="keywordflow">if</span> (!cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#afb44820c729a78caa986e598716c802c">Read</a>())
<a name="l00975"></a>00975     {
<a name="l00976"></a>00976         <span class="keywordflow">throw</span>(<a class="code" href="classExcept.html" title="General purpose exception error for error handling.">Except</a>(<span class="stringliteral">&quot;\nCan&#39;t read cel file: &quot;</span> + cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#acb10032210b46cb9b85c9dd03645acea">GetFileName</a>() + <span class="stringliteral">&quot;\nMessage: &quot;</span> + StringUtils::ConvertWCSToMBS(cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a2f70ba19b2198059dc024db84b67c459">GetError</a>())));
<a name="l00977"></a>00977     }
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <span class="keywordtype">int</span> numCells = cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a027ef23b1537af387ac91d2e81496e01">GetRows</a>() * cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a9036f2c16066af20c4058b993eb83fbf">GetCols</a>();
<a name="l00980"></a>00980     <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a> v(numCells);
<a name="l00981"></a>00981     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; (k &lt; numCells); k++)
<a name="l00982"></a>00982     {
<a name="l00983"></a>00983         v.set_unchecked(k, cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a76d2432b4075dbb9f00a1cf306a3a614">GetIntensity</a>(k));
<a name="l00984"></a>00984     }
<a name="l00985"></a>00985     getExperiment()-&gt;setMedianRawIntensity(v.median());
<a name="l00986"></a>00986     v.initialize(1);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988     <span class="keywordtype">int</span> iSNPDataCount = 0;
<a name="l00989"></a>00989     <span class="keywordtype">int</span> iCNDataCount = 0;
<a name="l00990"></a>00990     <span class="keywordtype">int</span> iIndex = 0;
<a name="l00991"></a>00991     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeIndex = 0; iProbeIndex &lt; numCells; iProbeIndex++)
<a name="l00992"></a>00992     {
<a name="l00993"></a>00993         <span class="keywordflow">if</span> ((iIndex &lt; m_pvProbes-&gt;getCount()) &amp;&amp; (m_pvProbes-&gt;getAt(iIndex)-&gt;getProbeID() == (iProbeIndex + 1)))
<a name="l00994"></a>00994         {
<a name="l00995"></a>00995             <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l00996"></a>00996             <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pProbeSet = getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex());
<a name="l00997"></a>00997             p-&gt;setIntensity(cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a76d2432b4075dbb9f00a1cf306a3a614">GetIntensity</a>(iProbeIndex));
<a name="l00998"></a>00998             <span class="keywordflow">if</span> (pProbeSet-&gt;isUseForSketch())
<a name="l00999"></a>00999             {
<a name="l01000"></a>01000                 <span class="keywordflow">if</span> (pProbeSet-&gt;processAsSNPNormalize())
<a name="l01001"></a>01001                 {
<a name="l01002"></a>01002                     iSNPDataCount++;
<a name="l01003"></a>01003                 }
<a name="l01004"></a>01004                 <span class="keywordflow">if</span> (pProbeSet-&gt;processAsCNNormalize())
<a name="l01005"></a>01005                 {
<a name="l01006"></a>01006                     iCNDataCount++;
<a name="l01007"></a>01007                 }
<a name="l01008"></a>01008             }
<a name="l01009"></a>01009             iIndex++;
<a name="l01010"></a>01010         }
<a name="l01011"></a>01011     }
<a name="l01012"></a>01012     <span class="keywordflow">if</span> (!m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;doDualNormalization&quot;</span>)) {iSNPDataCount = numCells; iCNDataCount = 0;}
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     <span class="comment">// Get ratio of antigenomic to genomic probes.</span>
<a name="l01015"></a>01015     {
<a name="l01016"></a>01016         <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strFileName = m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;antigenomic-probe-file&quot;</span>);
<a name="l01017"></a>01017         <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strReferenceFileName = m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;reference-file&quot;</span>);
<a name="l01018"></a>01018         <span class="keywordtype">int</span> iAntigenomicCount = 0;
<a name="l01019"></a>01019         <a class="code" href="classaffx_1_1File5__File.html">affx::File5_File</a> file5;
<a name="l01020"></a>01020         <a class="code" href="classaffx_1_1File5__Group.html">affx::File5_Group</a>* group5 = NULL;
<a name="l01021"></a>01021         <a class="code" href="classaffx_1_1File5__Tsv.html">affx::File5_Tsv</a>* tsv5 = NULL;
<a name="l01022"></a>01022         <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">affx::TsvFile</a> tsv;
<a name="l01023"></a>01023         tsv.<a class="code" href="classaffx_1_1TsvFile.html#a0b08c1eea21d4b6a893f57df16521a46" title="remove whitespace from value?">m_optAutoTrim</a> = <span class="keyword">true</span>;
<a name="l01024"></a>01024         
<a name="l01025"></a>01025         <span class="keywordflow">if</span> (strFileName != <span class="stringliteral">&quot;&quot;</span>)
<a name="l01026"></a>01026         {
<a name="l01027"></a>01027           std::string col;
<a name="l01028"></a>01028           <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(strFileName) != affx::TSV_OK) {<a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Cannot open file: &quot;</span> + strFileName);}
<a name="l01029"></a>01029           <span class="keywordflow">while</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0) == affx::TSV_OK) {
<a name="l01030"></a>01030             tsv.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,0,col);
<a name="l01031"></a>01031             <span class="keywordflow">if</span> (!col.empty()) {
<a name="l01032"></a>01032               iAntigenomicCount++;
<a name="l01033"></a>01033             }
<a name="l01034"></a>01034           }
<a name="l01035"></a>01035           tsv.<a class="code" href="classaffx_1_1TsvFile.html#a6a397412f48d477d0e87b00f914d06f7" title="Closes the file and clears bindings and other info.">clear</a>();
<a name="l01036"></a>01036         }
<a name="l01037"></a>01037         <span class="keywordflow">else</span>
<a name="l01038"></a>01038         {
<a name="l01039"></a>01039             <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>))
<a name="l01040"></a>01040             {
<a name="l01041"></a>01041                 iAntigenomicCount = <a class="code" href="classaffx_1_1File5__Tsv.html#a70d378884ad8debef8c9e7200263fb67" title="Look inside the file and get the count of rows of a tsv ///.">affx::File5_Tsv::getFileTsvLineCount</a>(strReferenceFileName, <span class="stringliteral">&quot;Cyto2&quot;</span>, <span class="stringliteral">&quot;AntigenomicProbes&quot;</span>);
<a name="l01042"></a>01042                 file5.open(strReferenceFileName, affx::FILE5_OPEN_RO);
<a name="l01043"></a>01043                 group5 = file5.openGroup(<span class="stringliteral">&quot;Cyto2&quot;</span>, affx::FILE5_OPEN);
<a name="l01044"></a>01044             }
<a name="l01045"></a>01045             <span class="keywordflow">else</span>
<a name="l01046"></a>01046             {
<a name="l01047"></a>01047                 iAntigenomicCount = <a class="code" href="classaffx_1_1File5__Tsv.html#a70d378884ad8debef8c9e7200263fb67" title="Look inside the file and get the count of rows of a tsv ///.">affx::File5_Tsv::getFileTsvLineCount</a>(strReferenceFileName, <span class="stringliteral">&quot;CN5&quot;</span>, <span class="stringliteral">&quot;AntigenomicProbes&quot;</span>);
<a name="l01048"></a>01048                 file5.open(strReferenceFileName, affx::FILE5_OPEN_RO);
<a name="l01049"></a>01049                 group5 = file5.openGroup(<span class="stringliteral">&quot;CN5&quot;</span>, affx::FILE5_OPEN);
<a name="l01050"></a>01050             }
<a name="l01051"></a>01051         }
<a name="l01052"></a>01052         <span class="keywordflow">if</span> (iAntigenomicCount &gt; 0)
<a name="l01053"></a>01053         {
<a name="l01054"></a>01054             <a class="code" href="classAffxMultiDimensionalArray.html" title="A class for managing one, two, or three dimensional arrays of primitive data types.">AffxMultiDimensionalArray&lt;int&gt;</a> v(iAntigenomicCount);
<a name="l01055"></a>01055             <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a> vIntensities(iAntigenomicCount);
<a name="l01056"></a>01056             
<a name="l01057"></a>01057             <span class="keywordtype">int</span> i = 0;
<a name="l01058"></a>01058             <span class="keywordtype">int</span> iIndex = 0;
<a name="l01059"></a>01059             <span class="keywordflow">if</span> (strFileName != <span class="stringliteral">&quot;&quot;</span>)
<a name="l01060"></a>01060             {
<a name="l01061"></a>01061               <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> probe;
<a name="l01062"></a>01062               <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(strFileName) != affx::TSV_OK ) {<a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Cannot open file: &quot;</span> + strFileName);}
<a name="l01063"></a>01063               <span class="keywordflow">while</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0) == affx::TSV_OK)  {
<a name="l01064"></a>01064                 tsv.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,0,probe);
<a name="l01065"></a>01065                 <span class="keywordflow">if</span> (!probe.empty()) {
<a name="l01066"></a>01066                   i = <a class="code" href="classAffxByteArray.html" title="A class for managing large byte arrays.">AffxByteArray</a>(probe).parseInt();
<a name="l01067"></a>01067                   v.set(iIndex, i - 1);
<a name="l01068"></a>01068                   iIndex++;
<a name="l01069"></a>01069                 }
<a name="l01070"></a>01070               }
<a name="l01071"></a>01071               tsv.<a class="code" href="classaffx_1_1TsvFile.html#a6a397412f48d477d0e87b00f914d06f7" title="Closes the file and clears bindings and other info.">clear</a>();
<a name="l01072"></a>01072             }
<a name="l01073"></a>01073             <span class="keywordflow">else</span>
<a name="l01074"></a>01074             {
<a name="l01075"></a>01075                 tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;AntigenomicProbes&quot;</span>, affx::FILE5_OPEN);
<a name="l01076"></a>01076                 <span class="keywordflow">while</span> (tsv5-&gt;nextLine() == affx::FILE5_OK)
<a name="l01077"></a>01077                 {
<a name="l01078"></a>01078                     tsv5-&gt;get(0, 0, &amp;i);
<a name="l01079"></a>01079                     v.set(iIndex, (i - 1));
<a name="l01080"></a>01080                     iIndex++;
<a name="l01081"></a>01081                 }
<a name="l01082"></a>01082                 tsv5-&gt;close();
<a name="l01083"></a>01083                 <span class="keyword">delete</span> tsv5;
<a name="l01084"></a>01084             }
<a name="l01085"></a>01085             v.quickSort();
<a name="l01086"></a>01086             iIndex = 0;
<a name="l01087"></a>01087             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; (k &lt; numCells); k++)
<a name="l01088"></a>01088             {
<a name="l01089"></a>01089                 <span class="keywordflow">if</span> (v.binarySearch(k) != -1)
<a name="l01090"></a>01090                 {
<a name="l01091"></a>01091                     vIntensities.set(iIndex, cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a76d2432b4075dbb9f00a1cf306a3a614">GetIntensity</a>(k));
<a name="l01092"></a>01092                     iIndex++;
<a name="l01093"></a>01093                 }
<a name="l01094"></a>01094             }
<a name="l01095"></a>01095             <span class="keywordtype">double</span> dMedianAntigenomicProbes = vIntensities.median();
<a name="l01096"></a>01096             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiCount = 0;
<a name="l01097"></a>01097             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvProbes-&gt;getCount()); iIndex++)
<a name="l01098"></a>01098             {
<a name="l01099"></a>01099                 <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l01100"></a>01100                 <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pProbeSet = getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex());
<a name="l01101"></a>01101                 <span class="keywordflow">if</span> (isCytoScanHD &amp;&amp; ((pProbeSet-&gt;getProcessFlag() != 1) || (!pProbeSet-&gt;processAsCNNormalize()))) {<span class="keywordflow">continue</span>;}
<a name="l01102"></a>01102                 <span class="keywordflow">if</span> (pProbeSet-&gt;processAsCNNormalize())
<a name="l01103"></a>01103                 {
<a name="l01104"></a>01104                     uiCount++;
<a name="l01105"></a>01105                 }
<a name="l01106"></a>01106             }
<a name="l01107"></a>01107             vIntensities.initialize(uiCount);
<a name="l01108"></a>01108             i = 0;
<a name="l01109"></a>01109             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvProbes-&gt;getCount()); iIndex++)
<a name="l01110"></a>01110             {
<a name="l01111"></a>01111                 <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l01112"></a>01112                 <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pProbeSet = getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex());
<a name="l01113"></a>01113                 <span class="keywordflow">if</span> (isCytoScanHD &amp;&amp; ((pProbeSet-&gt;getProcessFlag() != 1) || (!pProbeSet-&gt;processAsCNNormalize()))) {<span class="keywordflow">continue</span>;}
<a name="l01114"></a>01114                 <span class="keywordflow">if</span> (pProbeSet-&gt;processAsCNNormalize())
<a name="l01115"></a>01115                 {
<a name="l01116"></a>01116                     vIntensities.set(i, p-&gt;getIntensity());
<a name="l01117"></a>01117                     i++;
<a name="l01118"></a>01118                 }
<a name="l01119"></a>01119             }
<a name="l01120"></a>01120             <span class="keywordtype">double</span> dMedianCopynumberProbes = vIntensities.median();
<a name="l01121"></a>01121             <span class="keywordflow">if</span> (dMedianCopynumberProbes != 0)
<a name="l01122"></a>01122             {
<a name="l01123"></a>01123                 getExperiment()-&gt;setAntigenomicRatio((<span class="keywordtype">float</span>)(dMedianAntigenomicProbes / dMedianCopynumberProbes));
<a name="l01124"></a>01124             }
<a name="l01125"></a>01125         }
<a name="l01126"></a>01126         <span class="keywordflow">if</span> (strFileName == <span class="stringliteral">&quot;&quot;</span>)
<a name="l01127"></a>01127         {
<a name="l01128"></a>01128             group5-&gt;close();
<a name="l01129"></a>01129             <span class="keyword">delete</span> group5;
<a name="l01130"></a>01130             file5.close();
<a name="l01131"></a>01131         }
<a name="l01132"></a>01132     }
<a name="l01133"></a>01133 
<a name="l01134"></a>01134     adapterTypeNormalization(cel);
<a name="l01135"></a>01135     adjustIntensitiesUsingCovariateSignalAdjustment();
<a name="l01136"></a>01136 
<a name="l01137"></a>01137     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;keep-intermediate-data&quot;</span>))
<a name="l01138"></a>01138     {
<a name="l01139"></a>01139         <span class="keywordflow">if</span> (InstanceOf(<span class="keyword">this</span>, <a class="code" href="classCNAnalysisMethodReference.html" title="The Reference Analysis Method.">CNAnalysisMethodReference</a>) == <span class="keyword">true</span>)
<a name="l01140"></a>01140         {
<a name="l01141"></a>01141             writeIntensities(<span class="stringliteral">&quot;reference-before-normalized&quot;</span>);
<a name="l01142"></a>01142         }
<a name="l01143"></a>01143         <span class="keywordflow">else</span>
<a name="l01144"></a>01144         {
<a name="l01145"></a>01145             writeIntensities(<span class="stringliteral">&quot;single-sample-before-normalized&quot;</span>);
<a name="l01146"></a>01146         }
<a name="l01147"></a>01147     }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149     <span class="keywordflow">if</span> (m_pvSNPData != NULL)
<a name="l01150"></a>01150     {
<a name="l01151"></a>01151         <span class="keyword">delete</span> m_pvSNPData;
<a name="l01152"></a>01152     }
<a name="l01153"></a>01153     m_pvSNPData = <span class="keyword">new</span> std::vector&lt;float&gt;(iSNPDataCount);
<a name="l01154"></a>01154 
<a name="l01155"></a>01155     <span class="keywordflow">if</span> (m_pvCNData != NULL)
<a name="l01156"></a>01156     {
<a name="l01157"></a>01157         <span class="keyword">delete</span> m_pvCNData;
<a name="l01158"></a>01158     }
<a name="l01159"></a>01159     m_pvCNData = <span class="keyword">new</span> std::vector&lt;float&gt;(iCNDataCount);
<a name="l01160"></a>01160 
<a name="l01161"></a>01161     <span class="keywordtype">int</span> iSNPIndex = 0;
<a name="l01162"></a>01162     <span class="keywordtype">int</span> iCNIndex = 0;
<a name="l01163"></a>01163     <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)))
<a name="l01164"></a>01164     {
<a name="l01165"></a>01165     <span class="comment">// Working on 2.7M or 310K chips</span>
<a name="l01166"></a>01166         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvProbes-&gt;getCount()); iIndex++)
<a name="l01167"></a>01167         {
<a name="l01168"></a>01168             <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l01169"></a>01169             <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pProbeSet = getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex());
<a name="l01170"></a>01170             <span class="keywordflow">if</span> (pProbeSet-&gt;isUseForSketch())
<a name="l01171"></a>01171             {
<a name="l01172"></a>01172                 <span class="keywordflow">if</span> (pProbeSet-&gt;processAsSNPNormalize())
<a name="l01173"></a>01173                 {
<a name="l01174"></a>01174                     m_pvSNPData-&gt;at(iSNPIndex) = p-&gt;getIntensity();
<a name="l01175"></a>01175                     iSNPIndex++;
<a name="l01176"></a>01176                 }
<a name="l01177"></a>01177                 <span class="keywordflow">if</span> (pProbeSet-&gt;processAsCNNormalize())
<a name="l01178"></a>01178                 {
<a name="l01179"></a>01179                     m_pvCNData-&gt;at(iCNIndex) = p-&gt;getIntensity();
<a name="l01180"></a>01180                     iCNIndex++;
<a name="l01181"></a>01181                 }
<a name="l01182"></a>01182             }
<a name="l01183"></a>01183         }
<a name="l01184"></a>01184     }
<a name="l01185"></a>01185     <span class="keywordflow">else</span>
<a name="l01186"></a>01186     {
<a name="l01187"></a>01187         <span class="comment">//MG Working on snp6 or snp7 chips i.e. cyto2 = false </span>
<a name="l01188"></a>01188         <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;doDualNormalization&quot;</span>))
<a name="l01189"></a>01189         {
<a name="l01190"></a>01190             <span class="comment">// Working on snp6/7 chips with dual normalization.</span>
<a name="l01191"></a>01191             <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;adapter-type-normalization&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;adapter-type-normalization&quot;</span>)))
<a name="l01192"></a>01192             {
<a name="l01193"></a>01193                 <span class="comment">// Working on snp6/7 chips with dual and adapter type normalization.</span>
<a name="l01194"></a>01194                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeIndex = 0; iProbeIndex &lt; m_pvProbes-&gt;getCount(); iProbeIndex++)
<a name="l01195"></a>01195                 { 
<a name="l01196"></a>01196                     <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iProbeIndex);
<a name="l01197"></a>01197                     <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pProbeSet = getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex());
<a name="l01198"></a>01198                     <span class="keywordflow">if</span> (pProbeSet-&gt;isUseForSketch())
<a name="l01199"></a>01199                     {
<a name="l01200"></a>01200                         {
<a name="l01201"></a>01201                             <span class="keywordflow">if</span> (pProbeSet-&gt;processAsSNPNormalize())
<a name="l01202"></a>01202                             {
<a name="l01203"></a>01203                                 m_pvSNPData-&gt;at(iSNPIndex) = m_pobjAdapterTypeNormTran-&gt;<a class="code" href="classAdapterTypeNormTran.html#a6095e6ff6f4536eaa2554e4ddc971537" title="transform the intensity point supplied coming from a particular probe in a particular microarray...">transform</a>(p-&gt;getProbeID()-1, 0, cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a76d2432b4075dbb9f00a1cf306a3a614">GetIntensity</a>(p-&gt;getProbeID()-1)); 
<a name="l01204"></a>01204                                 iSNPIndex++;
<a name="l01205"></a>01205                             }
<a name="l01206"></a>01206                             <span class="keywordflow">if</span> (pProbeSet-&gt;processAsCNNormalize())
<a name="l01207"></a>01207                             {
<a name="l01208"></a>01208                                 m_pvCNData-&gt;at(iCNIndex) = m_pobjAdapterTypeNormTran-&gt;<a class="code" href="classAdapterTypeNormTran.html#a6095e6ff6f4536eaa2554e4ddc971537" title="transform the intensity point supplied coming from a particular probe in a particular microarray...">transform</a>(p-&gt;getProbeID()-1, 0, cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a76d2432b4075dbb9f00a1cf306a3a614">GetIntensity</a>(p-&gt;getProbeID()-1)); 
<a name="l01209"></a>01209                                 iCNIndex++;
<a name="l01210"></a>01210                             }
<a name="l01211"></a>01211                         }
<a name="l01212"></a>01212                    }
<a name="l01213"></a>01213                 }
<a name="l01214"></a>01214             }
<a name="l01215"></a>01215             <span class="keywordflow">else</span>
<a name="l01216"></a>01216             {
<a name="l01217"></a>01217                 <span class="comment">// Working on snp6/7 chips dual but no adapter type normalization.</span>
<a name="l01218"></a>01218                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iIndex = 0; (iIndex &lt; m_pvProbes-&gt;getCount()); iIndex++)
<a name="l01219"></a>01219                 {
<a name="l01220"></a>01220                     <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iIndex);
<a name="l01221"></a>01221                     <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pProbeSet = getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex());
<a name="l01222"></a>01222                     <span class="keywordflow">if</span> (pProbeSet-&gt;isUseForSketch())
<a name="l01223"></a>01223                     {
<a name="l01224"></a>01224                         <span class="keywordflow">if</span> (pProbeSet-&gt;processAsSNPNormalize())
<a name="l01225"></a>01225                         {
<a name="l01226"></a>01226                             m_pvSNPData-&gt;at(iSNPIndex) = p-&gt;getIntensity();
<a name="l01227"></a>01227                             iSNPIndex++;
<a name="l01228"></a>01228                         }
<a name="l01229"></a>01229                         <span class="keywordflow">if</span> (pProbeSet-&gt;processAsCNNormalize())
<a name="l01230"></a>01230                         {
<a name="l01231"></a>01231                             m_pvCNData-&gt;at(iCNIndex) = p-&gt;getIntensity();
<a name="l01232"></a>01232                             iCNIndex++;
<a name="l01233"></a>01233                         }
<a name="l01234"></a>01234                    }
<a name="l01235"></a>01235                 }
<a name="l01236"></a>01236 
<a name="l01237"></a>01237             }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239         }
<a name="l01240"></a>01240         <span class="keywordflow">else</span>
<a name="l01241"></a>01241         {
<a name="l01242"></a>01242             <span class="comment">// Working on snp6/7 chips with single normalization.</span>
<a name="l01243"></a>01243             <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;adapter-type-normalization&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;adapter-type-normalization&quot;</span>)))
<a name="l01244"></a>01244             {
<a name="l01245"></a>01245                 <span class="comment">// Working on snp6/7 chips with single and adapter type normalization. </span>
<a name="l01246"></a>01246                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeIndex = 0; iProbeIndex &lt; numCells; iProbeIndex++)
<a name="l01247"></a>01247                 {
<a name="l01248"></a>01248                     <span class="comment">// Note that when doing single normalization we load all intensities into the m_pvSNPData vector.</span>
<a name="l01249"></a>01249                     m_pvSNPData-&gt;at(iSNPIndex) = m_pobjAdapterTypeNormTran-&gt;<a class="code" href="classAdapterTypeNormTran.html#a6095e6ff6f4536eaa2554e4ddc971537" title="transform the intensity point supplied coming from a particular probe in a particular microarray...">transform</a>(iProbeIndex, 0, cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a76d2432b4075dbb9f00a1cf306a3a614">GetIntensity</a>(iProbeIndex));
<a name="l01250"></a>01250                     iSNPIndex++;
<a name="l01251"></a>01251                 }
<a name="l01252"></a>01252 
<a name="l01253"></a>01253 
<a name="l01254"></a>01254 <span class="comment">/*  This code seems more logical, but for backwards compatibility with workflow/cyto on snp6 chips we do quantile (i.e.single)</span>
<a name="l01255"></a>01255 <span class="comment">    normalization   on all probesets on the chip, not just the union of SNP and CN probesets. </span>
<a name="l01256"></a>01256 <span class="comment"></span>
<a name="l01257"></a>01257 <span class="comment">                for (int iProbeIndex = 0; iProbeIndex &lt; m_pvProbes-&gt;getCount(); iProbeIndex++)</span>
<a name="l01258"></a>01258 <span class="comment">                {</span>
<a name="l01259"></a>01259 <span class="comment">                    CNProbe* p = m_pvProbes-&gt;getAt(iProbeIndex);</span>
<a name="l01260"></a>01260 <span class="comment">                    CNProbeSet* pProbeSet = getProbeSets()-&gt;getAt(p-&gt;getProbeSetIndex());</span>
<a name="l01261"></a>01261 <span class="comment">                    if (pProbeSet-&gt;isUseForSketch())</span>
<a name="l01262"></a>01262 <span class="comment">                    {</span>
<a name="l01263"></a>01263 <span class="comment">                        m_pvSNPData-&gt;at(iSNPIndex) = m_pobjAdapterTypeNormTran-&gt;transform(p-&gt;getProbeID()-1, 0, cel.GetIntensity(p-&gt;getProbeID()-1));</span>
<a name="l01264"></a>01264 <span class="comment">                        iSNPIndex++;</span>
<a name="l01265"></a>01265 <span class="comment">                    }</span>
<a name="l01266"></a>01266 <span class="comment">                } </span>
<a name="l01267"></a>01267 <span class="comment">*/</span>
<a name="l01268"></a>01268             }
<a name="l01269"></a>01269             <span class="keywordflow">else</span>
<a name="l01270"></a>01270             {
<a name="l01271"></a>01271                 <span class="comment">// Working on snp6/7 chips with single and no adapter type normalization. </span>
<a name="l01272"></a>01272                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeIndex = 0; iProbeIndex &lt; numCells; iProbeIndex++)
<a name="l01273"></a>01273                 {
<a name="l01274"></a>01274                     m_pvSNPData-&gt;at(iSNPIndex) = cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a76d2432b4075dbb9f00a1cf306a3a614">GetIntensity</a>(iProbeIndex);
<a name="l01275"></a>01275                     iSNPIndex++;
<a name="l01276"></a>01276                 }
<a name="l01277"></a>01277             }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279         }
<a name="l01280"></a>01280     }
<a name="l01281"></a>01281 
<a name="l01282"></a>01282     cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#ae5e091bf0e0549f45f45ba55221fea31">Close</a>();
<a name="l01283"></a>01283 }
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::adapterTypeNormalization(<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html">affymetrix_fusion_io::FusionCELData</a>&amp; cel)
<a name="l01286"></a>01286 {
<a name="l01287"></a>01287 
<a name="l01288"></a>01288   <span class="comment">// adapter type normalization</span>
<a name="l01289"></a>01289     <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;adapter-type-normalization&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;adapter-type-normalization&quot;</span>)))
<a name="l01290"></a>01290     {
<a name="l01291"></a>01291         <span class="keywordtype">int</span> numCells = cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a027ef23b1537af387ac91d2e81496e01">GetRows</a>() * cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a9036f2c16066af20c4058b993eb83fbf">GetCols</a>();
<a name="l01292"></a>01292         std::vector&lt;float&gt; data(numCells);
<a name="l01293"></a>01293         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeIndex = 0; iProbeIndex &lt; numCells; iProbeIndex++)
<a name="l01294"></a>01294         {
<a name="l01295"></a>01295             data[iProbeIndex] = cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a76d2432b4075dbb9f00a1cf306a3a614">GetIntensity</a>(iProbeIndex);
<a name="l01296"></a>01296         }
<a name="l01297"></a>01297         <span class="comment">//m_pobjAdapterTypeNormTran-&gt;newChip(data);</span>
<a name="l01298"></a>01298         m_pobjAdapterTypeNormTran-&gt;setCelFileIndex(0);
<a name="l01299"></a>01299         m_pobjAdapterTypeNormTran-&gt;<a class="code" href="classAdapterTypeNormTran.html#a3b7726cfd93b4a5cdd68493e40e90798" title="Method for being passed a new cel file worth of data.">initializeData</a>(data);
<a name="l01300"></a>01300         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeIndex = 0; (iProbeIndex &lt; m_pvProbes-&gt;getCount()); iProbeIndex++)
<a name="l01301"></a>01301         {
<a name="l01302"></a>01302             <a class="code" href="classCNProbe.html" title="A class for storing probe intensity data.">CNProbe</a>* p = m_pvProbes-&gt;getAt(iProbeIndex);
<a name="l01303"></a>01303             p-&gt;setIntensity(m_pobjAdapterTypeNormTran-&gt;<a class="code" href="classAdapterTypeNormTran.html#a6095e6ff6f4536eaa2554e4ddc971537" title="transform the intensity point supplied coming from a particular probe in a particular microarray...">transform</a>((p-&gt;getProbeID() - 1), 0, p-&gt;getIntensity()));
<a name="l01304"></a>01304         }
<a name="l01305"></a>01305     }
<a name="l01306"></a>01306 }
<a name="l01307"></a>01307 
<a name="l01308"></a>01308 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::initializeSnpParameters(<a class="code" href="classsnp__param.html" title="this holds all the parameters for a snp, including alg choices">snp_param</a>&amp; sp, <span class="keywordtype">int</span> iCallMethod)
<a name="l01309"></a>01309 {
<a name="l01310"></a>01310     sp.<a class="code" href="classsnp__param.html#a956b62e64130e43f407662c31f54b372" title="initialize to some useful defaults">Initialize</a>();
<a name="l01311"></a>01311     sp.<a class="code" href="classsnp__param.html#ac6c59acd942ff43d8aa6baa17ad6364b" title="do we use raw labels or posterior distributions?">callmethod</a> = iCallMethod;
<a name="l01312"></a>01312     sp.<a class="code" href="classsnp__param.html#ab106a36c2ad59a00fdad233b5577d0b6" title="use quick method">bins</a> = 100;
<a name="l01313"></a>01313     sp.<a class="code" href="classsnp__param.html#ae4dba9978ef175bdadc5a3379289c0ef" title="turn on mixture distribution penalty">mix</a> = 1;
<a name="l01314"></a>01314     sp.<a class="code" href="classsnp__param.html#adfe46fd4d9582396882e89eaf3592c5a" title="bic penalty level bic*nparam*log(n)">bic</a> = 2;
<a name="l01315"></a>01315     sp.<a class="code" href="classsnp__param.html#a1900bf669c78de37107156241c6adcd4" title="do we stop cluster centers from being too close?">hardshell</a> = 3;
<a name="l01316"></a>01316     sp.<a class="code" href="classsnp__param.html#aea03fd76d67d7a0ebf46827c26f684e9" title="how close can cluster centers be?">shellbarrier</a> = 0.45;
<a name="l01317"></a>01317 
<a name="l01318"></a>01318     sp.prior.<a class="code" href="classsnp__distribution.html#a7325d44177912f9851253b1af5893ee3" title="aa allele cluster">aa</a>.<a class="code" href="classcluster__data.html#a09bcd6068f14afa7d1f52c270e3a2be7" title="strength of mean (pseudo-observations)">k</a> = 1;
<a name="l01319"></a>01319     sp.prior.<a class="code" href="classsnp__distribution.html#a1cabc31d59fa37b51256698c5cae3329" title="ab genotype cluster">ab</a>.<a class="code" href="classcluster__data.html#a09bcd6068f14afa7d1f52c270e3a2be7" title="strength of mean (pseudo-observations)">k</a> = 1.5;
<a name="l01320"></a>01320     sp.prior.<a class="code" href="classsnp__distribution.html#a65361a16c9c09a1870492f441ab9e299" title="bb genotype cluster">bb</a>.<a class="code" href="classcluster__data.html#a09bcd6068f14afa7d1f52c270e3a2be7" title="strength of mean (pseudo-observations)">k</a> = 1; <span class="comment">// bb.k always should = aa.k</span>
<a name="l01321"></a>01321 
<a name="l01322"></a>01322     sp.prior.<a class="code" href="classsnp__distribution.html#a7325d44177912f9851253b1af5893ee3" title="aa allele cluster">aa</a>.<a class="code" href="classcluster__data.html#a6d6d0888d2b43c15e866d2beaaf63643" title="mean of cluster">m</a> = 2;
<a name="l01323"></a>01323     sp.prior.<a class="code" href="classsnp__distribution.html#a1cabc31d59fa37b51256698c5cae3329" title="ab genotype cluster">ab</a>.<a class="code" href="classcluster__data.html#a6d6d0888d2b43c15e866d2beaaf63643" title="mean of cluster">m</a> = 0;
<a name="l01324"></a>01324     sp.prior.<a class="code" href="classsnp__distribution.html#a65361a16c9c09a1870492f441ab9e299" title="bb genotype cluster">bb</a>.<a class="code" href="classcluster__data.html#a6d6d0888d2b43c15e866d2beaaf63643" title="mean of cluster">m</a> = -2;
<a name="l01325"></a>01325 
<a name="l01326"></a>01326     sp.prior.<a class="code" href="classsnp__distribution.html#a7325d44177912f9851253b1af5893ee3" title="aa allele cluster">aa</a>.<a class="code" href="classcluster__data.html#ab5687aae0f32c286b69bd0cf5e0d9d37" title="variance of cluster">ss</a> = 0.06;
<a name="l01327"></a>01327     sp.prior.<a class="code" href="classsnp__distribution.html#a1cabc31d59fa37b51256698c5cae3329" title="ab genotype cluster">ab</a>.<a class="code" href="classcluster__data.html#ab5687aae0f32c286b69bd0cf5e0d9d37" title="variance of cluster">ss</a> = 0.06;
<a name="l01328"></a>01328     sp.prior.<a class="code" href="classsnp__distribution.html#a65361a16c9c09a1870492f441ab9e299" title="bb genotype cluster">bb</a>.<a class="code" href="classcluster__data.html#ab5687aae0f32c286b69bd0cf5e0d9d37" title="variance of cluster">ss</a> = 0.06;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     sp.prior.<a class="code" href="classsnp__distribution.html#a7325d44177912f9851253b1af5893ee3" title="aa allele cluster">aa</a>.<a class="code" href="classcluster__data.html#aaaf1dec521d21ec061d6d9e7c3b1e78c" title="strength of variance (pseudo-observations)">v</a> = 10;
<a name="l01331"></a>01331     sp.prior.<a class="code" href="classsnp__distribution.html#a1cabc31d59fa37b51256698c5cae3329" title="ab genotype cluster">ab</a>.<a class="code" href="classcluster__data.html#aaaf1dec521d21ec061d6d9e7c3b1e78c" title="strength of variance (pseudo-observations)">v</a> = 10;
<a name="l01332"></a>01332     sp.prior.<a class="code" href="classsnp__distribution.html#a65361a16c9c09a1870492f441ab9e299" title="bb genotype cluster">bb</a>.<a class="code" href="classcluster__data.html#aaaf1dec521d21ec061d6d9e7c3b1e78c" title="strength of variance (pseudo-observations)">v</a> = 10;
<a name="l01333"></a>01333 
<a name="l01334"></a>01334     sp.prior.xah = -0.6;
<a name="l01335"></a>01335     sp.prior.xab = 0.5;
<a name="l01336"></a>01336     sp.prior.<a class="code" href="classsnp__distribution.html#a7daecf444a60233a0de51e4c32fe7091" title="cross-correlation terms between clusters x">xhb</a> = -0.6;
<a name="l01337"></a>01337 
<a name="l01338"></a>01338     sp.<a class="code" href="classsnp__param.html#a46bef7e8276bb252b9787ebaf8f90f9b" title="check for possible outlier &amp;quot;size&amp;quot; values">copyqc</a> = 0;
<a name="l01339"></a>01339     sp.<a class="code" href="classsnp__param.html#aabee7993a0cd2545731ff91f5d6cce4e" title="how much do we allow clusters to shift from prior">wobble</a> = 0.05;
<a name="l01340"></a>01340 }
<a name="l01341"></a>01341 
<a name="l01342"></a>01342 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::setBrlmmpParameters(<a class="code" href="classsnp__param.html" title="this holds all the parameters for a snp, including alg choices">snp_param</a>&amp; sp)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344     <span class="keywordtype">string</span> spec = m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;brlmmp-parameters&quot;</span>);
<a name="l01345"></a>01345     <span class="keywordflow">if</span> (spec.empty()) {
<a name="l01346"></a>01346         <span class="keywordflow">return</span>;
<a name="l01347"></a>01347     }
<a name="l01348"></a>01348     <span class="keywordtype">string</span> name;
<a name="l01349"></a>01349     map&lt;string, string&gt; param;
<a name="l01350"></a>01350     <a class="code" href="classSelfCreate.html#afb6e01b234ac33a843cd92cd192e30de" title="Take a string of from &amp;quot;name.param1=value1.param2=value2&amp;quot; and populate the name and paramMap...">SelfCreate::fillInNameParam</a>(spec, name, param);
<a name="l01351"></a>01351 
<a name="l01352"></a>01352     map&lt;string, string&gt;::iterator iter;
<a name="l01353"></a>01353     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;bins&quot;</span>)) != param.end()) {
<a name="l01354"></a>01354         sp.<a class="code" href="classsnp__param.html#ab106a36c2ad59a00fdad233b5577d0b6" title="use quick method">bins</a> = <a class="code" href="AffxConv_8cpp.html#ab7d46fb769602a66d9e19f96e792498d" title="Converts a string with commas into an int.">getInt</a>(iter-&gt;second);
<a name="l01355"></a>01355     }
<a name="l01356"></a>01356     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;mix&quot;</span>)) != param.end()) {
<a name="l01357"></a>01357         sp.<a class="code" href="classsnp__param.html#ae4dba9978ef175bdadc5a3379289c0ef" title="turn on mixture distribution penalty">mix</a> = <a class="code" href="AffxConv_8cpp.html#ab7d46fb769602a66d9e19f96e792498d" title="Converts a string with commas into an int.">getInt</a>(iter-&gt;second);
<a name="l01358"></a>01358     }
<a name="l01359"></a>01359     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;bic&quot;</span>)) != param.end()) {
<a name="l01360"></a>01360         sp.<a class="code" href="classsnp__param.html#adfe46fd4d9582396882e89eaf3592c5a" title="bic penalty level bic*nparam*log(n)">bic</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01361"></a>01361     }
<a name="l01362"></a>01362     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;HARD&quot;</span>)) != param.end()) {
<a name="l01363"></a>01363         sp.<a class="code" href="classsnp__param.html#a1900bf669c78de37107156241c6adcd4" title="do we stop cluster centers from being too close?">hardshell</a> = <a class="code" href="AffxConv_8cpp.html#ab7d46fb769602a66d9e19f96e792498d" title="Converts a string with commas into an int.">getInt</a>(iter-&gt;second);
<a name="l01364"></a>01364     }
<a name="l01365"></a>01365     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;SB&quot;</span>)) != param.end()) {
<a name="l01366"></a>01366         sp.<a class="code" href="classsnp__param.html#aea03fd76d67d7a0ebf46827c26f684e9" title="how close can cluster centers be?">shellbarrier</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01367"></a>01367     }
<a name="l01368"></a>01368 
<a name="l01369"></a>01369     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;KX&quot;</span>)) != param.end()) {
<a name="l01370"></a>01370         sp.prior.<a class="code" href="classsnp__distribution.html#a7325d44177912f9851253b1af5893ee3" title="aa allele cluster">aa</a>.<a class="code" href="classcluster__data.html#a09bcd6068f14afa7d1f52c270e3a2be7" title="strength of mean (pseudo-observations)">k</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01371"></a>01371     }
<a name="l01372"></a>01372     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;KH&quot;</span>)) != param.end()) {
<a name="l01373"></a>01373         sp.prior.<a class="code" href="classsnp__distribution.html#a1cabc31d59fa37b51256698c5cae3329" title="ab genotype cluster">ab</a>.<a class="code" href="classcluster__data.html#a09bcd6068f14afa7d1f52c270e3a2be7" title="strength of mean (pseudo-observations)">k</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01374"></a>01374     }
<a name="l01375"></a>01375     sp.prior.<a class="code" href="classsnp__distribution.html#a65361a16c9c09a1870492f441ab9e299" title="bb genotype cluster">bb</a>.<a class="code" href="classcluster__data.html#a09bcd6068f14afa7d1f52c270e3a2be7" title="strength of mean (pseudo-observations)">k</a> = sp.prior.<a class="code" href="classsnp__distribution.html#a7325d44177912f9851253b1af5893ee3" title="aa allele cluster">aa</a>.<a class="code" href="classcluster__data.html#a09bcd6068f14afa7d1f52c270e3a2be7" title="strength of mean (pseudo-observations)">k</a>; <span class="comment">// bb.k always should = aa.k</span>
<a name="l01376"></a>01376 
<a name="l01377"></a>01377     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;AAM&quot;</span>)) != param.end()) {
<a name="l01378"></a>01378         sp.prior.<a class="code" href="classsnp__distribution.html#a7325d44177912f9851253b1af5893ee3" title="aa allele cluster">aa</a>.<a class="code" href="classcluster__data.html#a6d6d0888d2b43c15e866d2beaaf63643" title="mean of cluster">m</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01379"></a>01379     }
<a name="l01380"></a>01380     <span class="comment">//sp.prior.ab.m = 0;    // set by initializeSnpParameters() already</span>
<a name="l01381"></a>01381     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;BBM&quot;</span>)) != param.end()) {
<a name="l01382"></a>01382         sp.prior.<a class="code" href="classsnp__distribution.html#a65361a16c9c09a1870492f441ab9e299" title="bb genotype cluster">bb</a>.<a class="code" href="classcluster__data.html#a6d6d0888d2b43c15e866d2beaaf63643" title="mean of cluster">m</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01383"></a>01383     }
<a name="l01384"></a>01384 
<a name="l01385"></a>01385     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;AAV&quot;</span>)) != param.end()) {
<a name="l01386"></a>01386         sp.prior.<a class="code" href="classsnp__distribution.html#a7325d44177912f9851253b1af5893ee3" title="aa allele cluster">aa</a>.<a class="code" href="classcluster__data.html#ab5687aae0f32c286b69bd0cf5e0d9d37" title="variance of cluster">ss</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01387"></a>01387     }
<a name="l01388"></a>01388     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;ABV&quot;</span>)) != param.end()) {
<a name="l01389"></a>01389         sp.prior.<a class="code" href="classsnp__distribution.html#a1cabc31d59fa37b51256698c5cae3329" title="ab genotype cluster">ab</a>.<a class="code" href="classcluster__data.html#ab5687aae0f32c286b69bd0cf5e0d9d37" title="variance of cluster">ss</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01390"></a>01390     }
<a name="l01391"></a>01391     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;BBV&quot;</span>)) != param.end()) {
<a name="l01392"></a>01392         sp.prior.<a class="code" href="classsnp__distribution.html#a65361a16c9c09a1870492f441ab9e299" title="bb genotype cluster">bb</a>.<a class="code" href="classcluster__data.html#ab5687aae0f32c286b69bd0cf5e0d9d37" title="variance of cluster">ss</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01393"></a>01393     }
<a name="l01394"></a>01394 
<a name="l01395"></a>01395     <span class="comment">// done by initializeSnpParameters() already</span>
<a name="l01396"></a>01396     <span class="comment">//sp.prior.aa.v = 10.0;</span>
<a name="l01397"></a>01397     <span class="comment">//sp.prior.ab.v = 10.0;</span>
<a name="l01398"></a>01398     <span class="comment">//sp.prior.bb.v = 10.0;</span>
<a name="l01399"></a>01399     <span class="comment">//</span>
<a name="l01400"></a>01400 
<a name="l01401"></a>01401     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;KAH&quot;</span>)) != param.end()) {
<a name="l01402"></a>01402         sp.prior.xah = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01403"></a>01403     }
<a name="l01404"></a>01404     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;KXX&quot;</span>)) != param.end()) {
<a name="l01405"></a>01405         sp.prior.xab = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01406"></a>01406     }
<a name="l01407"></a>01407     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;KHB&quot;</span>)) != param.end()) {
<a name="l01408"></a>01408         sp.prior.<a class="code" href="classsnp__distribution.html#a7daecf444a60233a0de51e4c32fe7091" title="cross-correlation terms between clusters x">xhb</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01409"></a>01409     }
<a name="l01410"></a>01410 
<a name="l01411"></a>01411     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;copyqc&quot;</span>)) != param.end()) {
<a name="l01412"></a>01412         sp.<a class="code" href="classsnp__param.html#a46bef7e8276bb252b9787ebaf8f90f9b" title="check for possible outlier &amp;quot;size&amp;quot; values">copyqc</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01413"></a>01413     }
<a name="l01414"></a>01414     <span class="keywordflow">if</span> ((iter = param.find(<span class="stringliteral">&quot;wobble&quot;</span>)) != param.end()) {
<a name="l01415"></a>01415         sp.<a class="code" href="classsnp__param.html#aabee7993a0cd2545731ff91f5d6cce4e" title="how much do we allow clusters to shift from prior">wobble</a> = <a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(iter-&gt;second);
<a name="l01416"></a>01416     }
<a name="l01417"></a>01417 }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::loadSnpDistributions()
<a name="l01420"></a>01420 {
<a name="l01421"></a>01421     <span class="keywordtype">int</span> m_iGenderCode = getExperiment()-&gt;getRawIntensityRatioGenderAsInt(); 
<a name="l01422"></a>01422     <span class="keywordflow">if</span> (m_iGenderCode != m_iPrevGenderCode)
<a name="l01423"></a>01423     {
<a name="l01424"></a>01424         <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strReferenceFileName = m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;reference-file&quot;</span>);
<a name="l01425"></a>01425         <a class="code" href="classaffx_1_1File5__File.html">affx::File5_File</a> file5;
<a name="l01426"></a>01426         <a class="code" href="classaffx_1_1File5__Group.html">affx::File5_Group</a>* group5 = NULL;
<a name="l01427"></a>01427         <a class="code" href="classaffx_1_1File5__Tsv.html">affx::File5_Tsv</a>* tsv5 = NULL;
<a name="l01428"></a>01428 
<a name="l01429"></a>01429         file5.open(strReferenceFileName, affx::FILE5_OPEN_RO);
<a name="l01430"></a>01430 
<a name="l01431"></a>01431         <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)))
<a name="l01432"></a>01432         {
<a name="l01433"></a>01433             group5 = file5.openGroup(<span class="stringliteral">&quot;Cyto2&quot;</span>, affx::FILE5_OPEN);
<a name="l01434"></a>01434             tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;SNPPosteriors&quot;</span>, affx::FILE5_OPEN);
<a name="l01435"></a>01435         }
<a name="l01436"></a>01436         <span class="keywordflow">else</span>
<a name="l01437"></a>01437         {
<a name="l01438"></a>01438             group5 = file5.openGroup(<span class="stringliteral">&quot;CN5&quot;</span>, affx::FILE5_OPEN);
<a name="l01439"></a>01439             tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;CN5.snp-posteriors&quot;</span>, affx::FILE5_OPEN);
<a name="l01440"></a>01440         }
<a name="l01441"></a>01441         QuantLabelZ__readSnpPriorMap_tsv5_v2(m_iXChromosome, m_iYChromosome, *getExperiment(), *getProbeSets(), tsv5);
<a name="l01442"></a>01442         tsv5-&gt;close();
<a name="l01443"></a>01443         <span class="keyword">delete</span> tsv5;
<a name="l01444"></a>01444         group5-&gt;close();
<a name="l01445"></a>01445         <span class="keyword">delete</span> group5;
<a name="l01446"></a>01446         file5.close();
<a name="l01447"></a>01447         m_iPrevGenderCode = m_iGenderCode;
<a name="l01448"></a>01448     }
<a name="l01449"></a>01449 }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451 <span class="keywordtype">bool</span> CNAnalysisMethodChipstream::loadGenotypeCallsFromFile()
<a name="l01452"></a>01452 {
<a name="l01453"></a>01453     <span class="keywordtype">bool</span> bSuccessful = <span class="keyword">false</span>;
<a name="l01454"></a>01454     <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strFileName = m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;genotype-call-override-file&quot;</span>);
<a name="l01455"></a>01455     <span class="keywordflow">if</span> (strFileName != <span class="stringliteral">&quot;&quot;</span>)
<a name="l01456"></a>01456     {
<a name="l01457"></a>01457         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeSetIndex = 0; (iProbeSetIndex &lt; getProbeSets()-&gt;getCount()); iProbeSetIndex++)
<a name="l01458"></a>01458         {
<a name="l01459"></a>01459             <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* p = getProbeSets()-&gt;getAt(iProbeSetIndex);
<a name="l01460"></a>01460             <span class="keywordflow">if</span> (p-&gt;processAsSNP())
<a name="l01461"></a>01461             {
<a name="l01462"></a>01462                 p-&gt;setGenotypeCall((<span class="keywordtype">char</span>)-1);
<a name="l01463"></a>01463                 p-&gt;setGenotypeConfidence(0);
<a name="l01464"></a>01464             }
<a name="l01465"></a>01465         }
<a name="l01466"></a>01466         <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strSampleId = getSampleId(getExperiment()-&gt;getExperimentName());
<a name="l01467"></a>01467         <span class="keywordflow">if</span> (strSampleId != <span class="stringliteral">&quot;&quot;</span>)
<a name="l01468"></a>01468         {
<a name="l01469"></a>01469           <span class="comment">// DO NOT USE TSV.</span>
<a name="l01470"></a>01470           <span class="comment">// This section was changed from TSV to RowFile for performance reasons.</span>
<a name="l01471"></a>01471           <span class="comment">// Further investigation needs to be done as to the root cause for</span>
<a name="l01472"></a>01472           <span class="comment">// the TSV penalty.</span>
<a name="l01473"></a>01473           <span class="comment">/*</span>
<a name="l01474"></a>01474 <span class="comment">            affx::TsvFile tsv;</span>
<a name="l01475"></a>01475 <span class="comment">            std::string col, colName;</span>
<a name="l01476"></a>01476 <span class="comment">            AffxByteArray baColumn;</span>
<a name="l01477"></a>01477 <span class="comment">            AffxString strProbeSetName;</span>
<a name="l01478"></a>01478 <span class="comment">            CNProbeSet objSearch;</span>
<a name="l01479"></a>01479 <span class="comment">            tsv.m_optAutoTrim = true;</span>
<a name="l01480"></a>01480 <span class="comment">            if (tsv.open(strFileName) == affx::TSV_OK ) {</span>
<a name="l01481"></a>01481 <span class="comment">              for (int iColumnNumber = 1; (iColumnNumber &lt; tsv.getColumnCount(0)); iColumnNumber++) {</span>
<a name="l01482"></a>01482 <span class="comment">                tsv.cidx2cname(0, iColumnNumber, colName);</span>
<a name="l01483"></a>01483 <span class="comment">                if (strSampleId == getSampleId(colName)) {</span>
<a name="l01484"></a>01484 <span class="comment">                  bSuccessful = true;</span>
<a name="l01485"></a>01485 <span class="comment">                  Verbose::progressBegin(1, &quot;Loading override genotype calls for sample\t&quot; + strSampleId + &quot; &quot;, 1, 1, 1);</span>
<a name="l01486"></a>01486 <span class="comment">                  Verbose::progressStep(1);</span>
<a name="l01487"></a>01487 <span class="comment">                  while (tsv.nextLevel(0) == affx::TSV_OK)  {</span>
<a name="l01488"></a>01488 <span class="comment">                    tsv.get(0,0,strProbeSetName);</span>
<a name="l01489"></a>01489 <span class="comment">                    objSearch.setProbeSetName(strProbeSetName);</span>
<a name="l01490"></a>01490 <span class="comment">                    int iSearchIndex = getProbeSets()-&gt;binarySearch(objSearch, 0);</span>
<a name="l01491"></a>01491 <span class="comment">                    if (iSearchIndex != -1) {</span>
<a name="l01492"></a>01492 <span class="comment">                      CNProbeSet* p = getProbeSets()-&gt;getAt(iSearchIndex);</span>
<a name="l01493"></a>01493 <span class="comment">                      tsv.get(0,iColumnNumber, col);</span>
<a name="l01494"></a>01494 <span class="comment">                      p-&gt;setGenotypeCall((char)AffxByteArray(col).parseInt());</span>
<a name="l01495"></a>01495 <span class="comment">                      p-&gt;setGenotypeConfidence(0);</span>
<a name="l01496"></a>01496 <span class="comment">                    }</span>
<a name="l01497"></a>01497 <span class="comment">                  }</span>
<a name="l01498"></a>01498 <span class="comment">                  Verbose::progressEnd(1, &quot;Done&quot;);</span>
<a name="l01499"></a>01499 <span class="comment">                  break;</span>
<a name="l01500"></a>01500 <span class="comment">                }</span>
<a name="l01501"></a>01501 <span class="comment">              }</span>
<a name="l01502"></a>01502 <span class="comment">              tsv.clear();</span>
<a name="l01503"></a>01503 <span class="comment">            }</span>
<a name="l01504"></a>01504 <span class="comment">          */</span>
<a name="l01505"></a>01505             <a class="code" href="classRowFile.html" title="RowFile.">RowFile</a> rowFile;
<a name="l01506"></a>01506             std::vector&lt; std::string &gt; row;
<a name="l01507"></a>01507             <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> col;
<a name="l01508"></a>01508             <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strProbeSetName;
<a name="l01509"></a>01509             <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a> objSearch;
<a name="l01510"></a>01510             <span class="keywordtype">bool</span> okOpen = <span class="keyword">false</span>;
<a name="l01511"></a>01511             <span class="keywordflow">try</span> {
<a name="l01512"></a>01512               rowFile.<a class="code" href="classRowFile.html#aeb33b42846c6329dd023d6041fefc946" title="Open file fileName or die trying.">open</a>(strFileName);
<a name="l01513"></a>01513               okOpen = <span class="keyword">true</span>;
<a name="l01514"></a>01514             }
<a name="l01515"></a>01515             <span class="keywordflow">catch</span> (...) {
<a name="l01516"></a>01516               <span class="comment">// Just return false below, callee will abort. </span>
<a name="l01517"></a>01517             }
<a name="l01518"></a>01518             <span class="keywordflow">if</span> ( okOpen ) {
<a name="l01519"></a>01519               okOpen = rowFile.<a class="code" href="classRowFile.html#a8dbb4eda3b3c0f20fad9eba1fa9a5d40" title="Chop the next row into words and return them in the vector.">nextRow</a>(row);
<a name="l01520"></a>01520               <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> iColumnNumber = 1; !bSuccessful &amp;&amp; okOpen &amp;&amp;
<a name="l01521"></a>01521                       (iColumnNumber &lt; row.size()); iColumnNumber++)  {
<a name="l01522"></a>01522                 col = row[iColumnNumber];
<a name="l01523"></a>01523                 <span class="keywordflow">if</span> (strSampleId == getSampleId(col.trim()))  {
<a name="l01524"></a>01524                   bSuccessful = <span class="keyword">true</span>;
<a name="l01525"></a>01525                   Verbose::progressBegin(1, <span class="stringliteral">&quot;Loading override genotype calls for sample\t&quot;</span> + strSampleId + <span class="stringliteral">&quot; &quot;</span>, 1, 1, 1);
<a name="l01526"></a>01526                   <a class="code" href="classVerbose.html#ab28a28741a3ab2086099e2d66e920eb5" title="Print a dot out to let the user know we are still alive and making progress.">Verbose::progressStep</a>(1);
<a name="l01527"></a>01527                   <span class="keyword">const</span> std::string *line;
<a name="l01528"></a>01528                   <span class="keywordflow">while</span> ( (line = rowFile.<a class="code" href="classRowFile.html#a5bc319284cbc843109047231367e8847" title="Pull the next line from the input buffer or die trying.">nextLine</a>() ) ) {
<a name="l01529"></a>01529                     col = line-&gt;substr(0,line-&gt;find(<span class="charliteral">&#39;\t&#39;</span>));
<a name="l01530"></a>01530                     strProbeSetName = col.trim();
<a name="l01531"></a>01531                     objSearch.setProbeSetName(strProbeSetName);
<a name="l01532"></a>01532                     <span class="keywordtype">int</span> iSearchIndex = getProbeSets()-&gt;binarySearch(objSearch, 0);
<a name="l01533"></a>01533                     <span class="keywordflow">if</span> (iSearchIndex != -1)
<a name="l01534"></a>01534                       {
<a name="l01535"></a>01535                         <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* p = getProbeSets()-&gt;getAt(iSearchIndex);
<a name="l01536"></a>01536                         col = *line;
<a name="l01537"></a>01537                         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> index = 0; index &lt; iColumnNumber; index++ ) {
<a name="l01538"></a>01538                           col = col.substr(col.find(<span class="charliteral">&#39;\t&#39;</span>) + 1);
<a name="l01539"></a>01539                         }
<a name="l01540"></a>01540                         col = col.substr(0,col.find(<span class="charliteral">&#39;\t&#39;</span>));
<a name="l01541"></a>01541                         p-&gt;setGenotypeCall((<span class="keywordtype">char</span>)<a class="code" href="classAffxByteArray.html" title="A class for managing large byte arrays.">AffxByteArray</a>(col.trim()).parseInt());
<a name="l01542"></a>01542                         p-&gt;setGenotypeConfidence(0);
<a name="l01543"></a>01543                       }
<a name="l01544"></a>01544                   }
<a name="l01545"></a>01545                   Verbose::progressEnd(1, <span class="stringliteral">&quot;Done&quot;</span>);
<a name="l01546"></a>01546                 }
<a name="l01547"></a>01547               }
<a name="l01548"></a>01548               rowFile.<a class="code" href="classRowFile.html#adcb4cbb8f44db81cc24dd3a86bce153f" title="Close file streams.">close</a>();
<a name="l01549"></a>01549             }
<a name="l01550"></a>01550         }
<a name="l01551"></a>01551     }
<a name="l01552"></a>01552     <span class="keywordflow">return</span> bSuccessful;
<a name="l01553"></a>01553 }
<a name="l01554"></a>01554 
<a name="l01555"></a>01555 <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> CNAnalysisMethodChipstream::getSampleId(<span class="keyword">const</span> <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a>&amp; strCelFileName)
<a name="l01556"></a>01556 {
<a name="l01557"></a>01557     <span class="comment">// Use the entire file name converted to lower case, minus &quot;.cel&quot; suffix</span>
<a name="l01558"></a>01558     <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strSampleId = <a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(strCelFileName);
<a name="l01559"></a>01559     transform(    strSampleId.begin(),
<a name="l01560"></a>01560                 strSampleId.end(),
<a name="l01561"></a>01561                 strSampleId.begin(),
<a name="l01562"></a>01562                 <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span>(*)(<span class="keywordtype">int</span>)<span class="keyword">&gt;</span>(tolower));
<a name="l01563"></a>01563     AffxString::size_type iFindIndex = strSampleId.rfind(<span class="stringliteral">&quot;.cel&quot;</span>);
<a name="l01564"></a>01564     <span class="keywordflow">if</span> (iFindIndex != AffxString::npos) {
<a name="l01565"></a>01565         strSampleId = strSampleId.substring(0, iFindIndex);
<a name="l01566"></a>01566     }
<a name="l01567"></a>01567     <span class="keywordflow">return</span> strSampleId;
<a name="l01568"></a>01568 }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::calculateXY()
<a name="l01571"></a>01571 {
<a name="l01572"></a>01572     <a class="code" href="classAffxArray.html">AffxArray&lt;AffxString&gt;</a> vYProbeSetsToProcess;
<a name="l01573"></a>01573 
<a name="l01574"></a>01574     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">affx::TsvFile</a> tsv;
<a name="l01575"></a>01575     tsv.<a class="code" href="classaffx_1_1TsvFile.html#a0b08c1eea21d4b6a893f57df16521a46" title="remove whitespace from value?">m_optAutoTrim</a> = <span class="keyword">true</span>;
<a name="l01576"></a>01576     
<a name="l01577"></a>01577     <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;chrY-probes&quot;</span>)) == <a class="code" href="namespaceaffx.html#ad00847b6f358e7269f493808ee6bd395a05b4d7241e83bd24a318f4caa49b284e" title="No Error.">affx::TSV_OK</a>)
<a name="l01578"></a>01578     {
<a name="l01579"></a>01579         <span class="keywordflow">while</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0) == affx::TSV_OK)
<a name="l01580"></a>01580         {
<a name="l01581"></a>01581           <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strProbeSetName;
<a name="l01582"></a>01582           tsv.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,1, strProbeSetName);
<a name="l01583"></a>01583           <span class="keywordflow">if</span> (strProbeSetName != <span class="stringliteral">&quot;&quot;</span>)
<a name="l01584"></a>01584             {
<a name="l01585"></a>01585               vYProbeSetsToProcess.add(<span class="keyword">new</span> <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a>(strProbeSetName));
<a name="l01586"></a>01586             }
<a name="l01587"></a>01587         }
<a name="l01588"></a>01588         tsv.<a class="code" href="classaffx_1_1TsvFile.html#a6a397412f48d477d0e87b00f914d06f7" title="Closes the file and clears bindings and other info.">clear</a>();
<a name="l01589"></a>01589     } <span class="keywordflow">else</span> {<span class="keywordflow">throw</span>(<a class="code" href="classExcept.html" title="General purpose exception error for error handling.">Except</a>(<span class="stringliteral">&quot;Cannot open file: &quot;</span> + m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;chrY-probes&quot;</span>)));}
<a name="l01590"></a>01590     vYProbeSetsToProcess.quickSort(0);
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     <a class="code" href="classCNExperiment.html" title="A class for storing CNExperiment data.">CNExperiment</a>* pobjExperiment = getExperiment();
<a name="l01593"></a>01593     pobjExperiment-&gt;setXX(<span class="keyword">false</span>);
<a name="l01594"></a>01594     pobjExperiment-&gt;setY(<span class="keyword">false</span>);
<a name="l01595"></a>01595     <span class="comment">// Allocate the data vectors.</span>
<a name="l01596"></a>01596     <span class="keywordtype">int</span> iChrRefCount = 0;
<a name="l01597"></a>01597     <span class="keywordtype">int</span> iChrXCount = 0;
<a name="l01598"></a>01598     <span class="keywordtype">int</span> iChrYCount = 0;
<a name="l01599"></a>01599     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> uiRowIndex = 0; (uiRowIndex &lt; getProbeSets()-&gt;getCount()); uiRowIndex++)
<a name="l01600"></a>01600     {
<a name="l01601"></a>01601         <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pobjProbeSet = getProbeSets()-&gt;getAt(uiRowIndex);
<a name="l01602"></a>01602         <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strProbeSetName = pobjProbeSet-&gt;getProbeSetName();
<a name="l01603"></a>01603         <span class="keywordflow">if</span> ((pobjProbeSet-&gt;getChromosome() == m_iYChromosome) &amp;&amp; (vYProbeSetsToProcess.getCount() &gt; 0) &amp;&amp; (vYProbeSetsToProcess.binarySearch(strProbeSetName, 0) == -1)) {<span class="keywordflow">continue</span>;}
<a name="l01604"></a>01604         <span class="keywordflow">if</span> (pobjProbeSet-&gt;getChromosome() == m_pEngine-&gt;<a class="code" href="classOptions.html#afcfab86e21cac5bba43e0858bd428e62" title="Get the integer value of an option.">getOptInt</a>(<span class="stringliteral">&quot;reference-chromosome&quot;</span>)) {iChrRefCount++;}
<a name="l01605"></a>01605         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pobjProbeSet-&gt;getChromosome() == m_iXChromosome) {iChrXCount++;}
<a name="l01606"></a>01606         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pobjProbeSet-&gt;getChromosome() == m_iYChromosome) {iChrYCount++;}
<a name="l01607"></a>01607     }
<a name="l01608"></a>01608     <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a> vChrRefMedian(iChrRefCount);
<a name="l01609"></a>01609     <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a> vChrXSignal(iChrXCount);
<a name="l01610"></a>01610     <a class="code" href="classAffxMultiDimensionalArray.html">AffxMultiDimensionalArray&lt;float&gt;</a> vChrYSignal(iChrYCount);
<a name="l01611"></a>01611 
<a name="l01612"></a>01612     <span class="keywordtype">int</span> iChrRefIndex = 0;
<a name="l01613"></a>01613     <span class="keywordtype">int</span> iChrXIndex = 0;
<a name="l01614"></a>01614     <span class="keywordtype">int</span> iChrYIndex = 0;
<a name="l01615"></a>01615     <span class="comment">// For each probe set load the relevant data into the vectors so we can calculate the median.</span>
<a name="l01616"></a>01616     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iRowIndex = 0; (iRowIndex &lt; getProbeSets()-&gt;getCount()); iRowIndex++)
<a name="l01617"></a>01617     {
<a name="l01618"></a>01618         <a class="code" href="classCNProbeSet.html" title="A class to store probe set data.">CNProbeSet</a>* pobjProbeSet = getProbeSets()-&gt;getAt(iRowIndex);
<a name="l01619"></a>01619         <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strProbeSetName = pobjProbeSet-&gt;getProbeSetName();
<a name="l01620"></a>01620         <span class="keywordflow">if</span> ((pobjProbeSet-&gt;getChromosome() == m_iYChromosome) &amp;&amp; (vYProbeSetsToProcess.getCount() &gt; 0) &amp;&amp; (vYProbeSetsToProcess.binarySearch(strProbeSetName, 0) == -1)) {<span class="keywordflow">continue</span>;}
<a name="l01621"></a>01621         <span class="keywordflow">if</span> (pobjProbeSet-&gt;getChromosome() == m_pEngine-&gt;<a class="code" href="classOptions.html#afcfab86e21cac5bba43e0858bd428e62" title="Get the integer value of an option.">getOptInt</a>(<span class="stringliteral">&quot;reference-chromosome&quot;</span>))
<a name="l01622"></a>01622         {
<a name="l01623"></a>01623             vChrRefMedian.set(iChrRefIndex, pobjProbeSet-&gt;getMedianSignal());
<a name="l01624"></a>01624             iChrRefIndex++;
<a name="l01625"></a>01625         }
<a name="l01626"></a>01626         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pobjProbeSet-&gt;getChromosome() == m_iXChromosome)
<a name="l01627"></a>01627         {
<a name="l01628"></a>01628             vChrXSignal.set(iChrXIndex, pobjProbeSet-&gt;getSignalEstimate());
<a name="l01629"></a>01629             iChrXIndex++;
<a name="l01630"></a>01630         }
<a name="l01631"></a>01631         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pobjProbeSet-&gt;getChromosome() == m_iYChromosome)
<a name="l01632"></a>01632         {
<a name="l01633"></a>01633             vChrYSignal.set(iChrYIndex, pobjProbeSet-&gt;getSignalEstimate());
<a name="l01634"></a>01634             iChrYIndex++;
<a name="l01635"></a>01635         }
<a name="l01636"></a>01636     }
<a name="l01637"></a>01637     vYProbeSetsToProcess.deleteAll();
<a name="l01638"></a>01638     <span class="keywordtype">double</span> dChrRefMedian = vChrRefMedian.median();
<a name="l01639"></a>01639 
<a name="l01640"></a>01640     <span class="comment">// Set the experiment hasXX value.</span>
<a name="l01641"></a>01641     m_dXXRatio = (vChrXSignal.median() / dChrRefMedian);
<a name="l01642"></a>01642     pobjExperiment-&gt;setXXRatio((<span class="keywordtype">float</span>)m_dXXRatio);
<a name="l01643"></a>01643     pobjExperiment-&gt;setXX((m_dXXRatio &gt; m_pEngine-&gt;<a class="code" href="classOptions.html#a8b119de0194389e5e91d09520df211d9" title="Get the integer value of an option.">getOptDouble</a>(<span class="stringliteral">&quot;xx-cutoff&quot;</span>)) &amp;&amp; (m_dXXRatio &lt; m_pEngine-&gt;getOptDouble(<span class="stringliteral">&quot;xx-cutoff-high&quot;</span>)));
<a name="l01644"></a>01644 
<a name="l01645"></a>01645     <span class="comment">// Set the experiment hasY value.</span>
<a name="l01646"></a>01646     m_dYRatio = (vChrYSignal.median() / dChrRefMedian);
<a name="l01647"></a>01647     pobjExperiment-&gt;setYRatio((<span class="keywordtype">float</span>)m_dYRatio);
<a name="l01648"></a>01648     pobjExperiment-&gt;setY(m_dYRatio &gt; m_pEngine-&gt;<a class="code" href="classOptions.html#a8b119de0194389e5e91d09520df211d9" title="Get the integer value of an option.">getOptDouble</a>(<span class="stringliteral">&quot;y-cutoff&quot;</span>));
<a name="l01649"></a>01649     
<a name="l01650"></a>01650     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1, <span class="stringliteral">&quot;CNAnalysisMethodChipstream::calculateXY()\t&quot;</span> + getExperiment()-&gt;getExperimentName() + <span class="stringliteral">&quot;\tXXRatio\t&quot;</span> + ::<a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(m_dXXRatio, 6) + <span class="stringliteral">&quot;\tYRatio\t&quot;</span> + ::<a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(m_dYRatio, 6) + <span class="stringliteral">&quot;\t&quot;</span> + (getExperiment()-&gt;hasXX() ? <span class="stringliteral">&quot;XX&quot;</span> : <span class="stringliteral">&quot;X&quot;</span>) + (getExperiment()-&gt;hasY() ? <span class="stringliteral">&quot;Y&quot;</span> : <span class="stringliteral">&quot;&quot;</span>));
<a name="l01651"></a>01651 
<a name="l01652"></a>01652     <span class="keywordflow">if</span> ((!m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (!m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cytoscan-hd&quot;</span>)))
<a name="l01653"></a>01653     {
<a name="l01654"></a>01654         getExperiment()-&gt;setXX(getExperiment()-&gt;getRawIntensityRatioGenderAsInt() == <a class="code" href="namespaceaffx.html#a1c064510a1a9f30814f840025d73d669ad5afd116ccd5bf71e27bab31a23fac97" title="Has XX chromosomes.">affx::Female</a>);
<a name="l01655"></a>01655         getExperiment()-&gt;setY(getExperiment()-&gt;getRawIntensityRatioGenderAsInt() == <a class="code" href="namespaceaffx.html#a1c064510a1a9f30814f840025d73d669afdfe578a9e9044b7b274b736ed341a81" title="Has XY chromosomes.">affx::Male</a>);
<a name="l01656"></a>01656         <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1, <span class="stringliteral">&quot;CNAnalysisMethodChipstream::calculateXY(), (cyto2 = false) override\t&quot;</span> + getExperiment()-&gt;getExperimentName() + <span class="stringliteral">&quot;\tXXRatio\t&quot;</span> + ::<a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(m_dXXRatio, 6) + <span class="stringliteral">&quot;\tYRatio\t&quot;</span> + ::<a class="code" href="AffxConv_8cpp.html#a4e40c31006c5b45e47ea0240921b98b2" title="Converts a string with commas into a double.">getDouble</a>(m_dYRatio, 6) + <span class="stringliteral">&quot;\t&quot;</span> + (getExperiment()-&gt;hasXX() ? <span class="stringliteral">&quot;XX&quot;</span> : <span class="stringliteral">&quot;X&quot;</span>) + (getExperiment()-&gt;hasY() ? <span class="stringliteral">&quot;Y&quot;</span> : <span class="stringliteral">&quot;&quot;</span>));
<a name="l01657"></a>01657     }
<a name="l01658"></a>01658 }
<a name="l01659"></a>01659 
<a name="l01660"></a>01660 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::adjustIntensitiesPDNN()
<a name="l01661"></a>01661 {
<a name="l01662"></a>01662 
<a name="l01663"></a>01663         <a class="code" href="classAffxString.html" title="A class derived from std::string.">AffxString</a> strReferenceFileName = m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;reference-file&quot;</span>);
<a name="l01664"></a>01664         <a class="code" href="classaffx_1_1File5__File.html">affx::File5_File</a> file5;
<a name="l01665"></a>01665         <a class="code" href="classaffx_1_1File5__Group.html">affx::File5_Group</a>* group5 = NULL;
<a name="l01666"></a>01666         <a class="code" href="classaffx_1_1File5__Tsv.html">affx::File5_Tsv</a>* tsv5 = NULL;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668         <span class="keywordtype">int</span> iCount = 0;
<a name="l01669"></a>01669         <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)))
<a name="l01670"></a>01670         {
<a name="l01671"></a>01671             iCount = <a class="code" href="classaffx_1_1File5__Tsv.html#a70d378884ad8debef8c9e7200263fb67" title="Look inside the file and get the count of rows of a tsv ///.">affx::File5_Tsv::getFileTsvLineCount</a>(strReferenceFileName, <span class="stringliteral">&quot;Cyto2&quot;</span>, <span class="stringliteral">&quot;ProbeEffects&quot;</span>);
<a name="l01672"></a>01672         }
<a name="l01673"></a>01673         <span class="keywordflow">else</span>
<a name="l01674"></a>01674         {
<a name="l01675"></a>01675             iCount = <a class="code" href="classaffx_1_1File5__Tsv.html#a70d378884ad8debef8c9e7200263fb67" title="Look inside the file and get the count of rows of a tsv ///.">affx::File5_Tsv::getFileTsvLineCount</a>(strReferenceFileName, <span class="stringliteral">&quot;CN5&quot;</span>, <span class="stringliteral">&quot;CN5.plier.feature-response&quot;</span>);
<a name="l01676"></a>01676         }
<a name="l01677"></a>01677         <span class="keywordflow">if</span> (iCount &lt;= 0) {<span class="keywordflow">throw</span>(<a class="code" href="classExcept.html" title="General purpose exception error for error handling.">Except</a>(<span class="stringliteral">&quot;Cannot find any probes in the CN reference file to process.&quot;</span>));}
<a name="l01678"></a>01678 
<a name="l01679"></a>01679         file5.open(strReferenceFileName, affx::FILE5_OPEN_RO);
<a name="l01680"></a>01680         <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)))
<a name="l01681"></a>01681         {
<a name="l01682"></a>01682             group5 = file5.openGroup(<span class="stringliteral">&quot;Cyto2&quot;</span>, affx::FILE5_OPEN);
<a name="l01683"></a>01683         }
<a name="l01684"></a>01684         <span class="keywordflow">else</span>
<a name="l01685"></a>01685         {
<a name="l01686"></a>01686             group5 = file5.openGroup(<span class="stringliteral">&quot;CN5&quot;</span>, affx::FILE5_OPEN);
<a name="l01687"></a>01687         }
<a name="l01688"></a>01688 
<a name="l01689"></a>01689         <span class="keywordflow">if</span> ((m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)) &amp;&amp; (m_pEngine-&gt;<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cyto2&quot;</span>)))
<a name="l01690"></a>01690         {
<a name="l01691"></a>01691             tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;ProbeEffects&quot;</span>, affx::FILE5_OPEN);
<a name="l01692"></a>01692             <span class="keywordflow">if</span> (tsv5-&gt;getColumnCount(0) &lt; 6) {<span class="keywordflow">throw</span>(<a class="code" href="classExcept.html" title="General purpose exception error for error handling.">Except</a>(<span class="stringliteral">&quot;The CN Reference file does not contain Predicted Intensities.  PDNN cannot be computed.&quot;</span>));}
<a name="l01693"></a>01693         }
<a name="l01694"></a>01694         <span class="keywordflow">else</span>
<a name="l01695"></a>01695         {
<a name="l01696"></a>01696             tsv5 = group5-&gt;openTsv(<span class="stringliteral">&quot;CN5.plier.feature-response&quot;</span>, affx::FILE5_OPEN);
<a name="l01697"></a>01697             <span class="keywordflow">if</span> (tsv5-&gt;getColumnCount(0) &lt; 6) {<span class="keywordflow">throw</span>(<a class="code" href="classExcept.html" title="General purpose exception error for error handling.">Except</a>(<span class="stringliteral">&quot;The CN Reference file does not contain Predicted Intensities.  PDNN cannot be computed.&quot;</span>));}
<a name="l01698"></a>01698         }
<a name="l01699"></a>01699 
<a name="l01700"></a>01700         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiIndex = 0;
<a name="l01701"></a>01701         <span class="keywordtype">float</span> fTempValue = 0.0;
<a name="l01702"></a>01702         <span class="keywordflow">while</span> (tsv5-&gt;nextLine() == affx::FILE5_OK)
<a name="l01703"></a>01703         {
<a name="l01704"></a>01704             tsv5-&gt;get(0, 5, &amp;fTempValue); 
<a name="l01705"></a>01705             m_pProbes[uiIndex].setPredictedIntensity(fTempValue);
<a name="l01706"></a>01706             uiIndex++;
<a name="l01707"></a>01707         }
<a name="l01708"></a>01708         tsv5-&gt;close();
<a name="l01709"></a>01709         <span class="keyword">delete</span> tsv5;
<a name="l01710"></a>01710 
<a name="l01711"></a>01711         group5-&gt;close();
<a name="l01712"></a>01712         <span class="keyword">delete</span> group5;
<a name="l01713"></a>01713         file5.close();
<a name="l01714"></a>01714 
<a name="l01715"></a>01715 
<a name="l01716"></a>01716         <a class="code" href="classCNAnalysisMethodFactory.html" title="A factory class for making copy number analysis methodss based on a string representation.">CNAnalysisMethodFactory</a> amFactory;
<a name="l01717"></a>01717         <a class="code" href="classCNAnalysisMethod.html" title="A base class for copy number analysis methods.">CNAnalysisMethod</a>* am = NULL;
<a name="l01718"></a>01718         am = amFactory.<a class="code" href="classCNAnalysisMethodFactory.html#adc33a01614b4d68d23f9de3200945bfb" title="Create a pointer to a new CNAnalysisMethod object as described in the string specification.">CNAnalysisMethodForString</a>(m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;local-gc-background-intensity-adjustment-method&quot;</span>));
<a name="l01719"></a>01719         am-&gt;setEngine(m_pEngine);
<a name="l01720"></a>01720         am-&gt;setup(*getExperiment(), *getProbeSets());
<a name="l01721"></a>01721         am-&gt;setProbes(*m_pvProbes);
<a name="l01722"></a>01722         am-&gt;run();
<a name="l01723"></a>01723         <span class="keyword">delete</span> am;
<a name="l01724"></a>01724 }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::adjustIntensitiesHighPassFilter()
<a name="l01727"></a>01727 {
<a name="l01728"></a>01728     <span class="keywordflow">if</span> (!m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;image-correction-intensity-adjustment-method&quot;</span>)) {<span class="keywordflow">return</span>;}
<a name="l01729"></a>01729     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;image-correction-intensity-adjustment-method&quot;</span>) == <span class="stringliteral">&quot;none&quot;</span>) {<span class="keywordflow">return</span>;}
<a name="l01730"></a>01730     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;image-correction-intensity-adjustment-method&quot;</span>) != <span class="stringliteral">&quot;&quot;</span>)
<a name="l01731"></a>01731     {
<a name="l01732"></a>01732         <a class="code" href="classCNAnalysisMethodFactory.html" title="A factory class for making copy number analysis methodss based on a string representation.">CNAnalysisMethodFactory</a> amFactory;
<a name="l01733"></a>01733         <a class="code" href="classCNAnalysisMethod.html" title="A base class for copy number analysis methods.">CNAnalysisMethod</a>* am = NULL;
<a name="l01734"></a>01734         am = amFactory.<a class="code" href="classCNAnalysisMethodFactory.html#adc33a01614b4d68d23f9de3200945bfb" title="Create a pointer to a new CNAnalysisMethod object as described in the string specification.">CNAnalysisMethodForString</a>(m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;image-correction-intensity-adjustment-method&quot;</span>));
<a name="l01735"></a>01735         am-&gt;setEngine(m_pEngine);
<a name="l01736"></a>01736         am-&gt;setup(*getExperiment(), *getProbeSets());
<a name="l01737"></a>01737         am-&gt;setProbes(*m_pvProbes);
<a name="l01738"></a>01738         am-&gt;run();
<a name="l01739"></a>01739         <span class="keyword">delete</span> am;
<a name="l01740"></a>01740     }
<a name="l01741"></a>01741 }
<a name="l01742"></a>01742 
<a name="l01743"></a>01743 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::adjustIntensitiesUsingCovariateSignalAdjustment()
<a name="l01744"></a>01744 {
<a name="l01745"></a>01745     <span class="keywordflow">if</span> (!m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;signal-adjustment-covariates&quot;</span>)) {<span class="keywordflow">return</span>;}
<a name="l01746"></a>01746     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;signal-adjustment-covariates&quot;</span>) == <span class="stringliteral">&quot;none&quot;</span>) {<span class="keywordflow">return</span>;}
<a name="l01747"></a>01747     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;signal-adjustment-covariates&quot;</span>) != <span class="stringliteral">&quot;&quot;</span>)
<a name="l01748"></a>01748     {
<a name="l01749"></a>01749         <a class="code" href="classCNAnalysisMethodFactory.html" title="A factory class for making copy number analysis methodss based on a string representation.">CNAnalysisMethodFactory</a> amFactory;
<a name="l01750"></a>01750         <a class="code" href="classCNAnalysisMethod.html" title="A base class for copy number analysis methods.">CNAnalysisMethod</a>* am = NULL;
<a name="l01751"></a>01751         am = amFactory.<a class="code" href="classCNAnalysisMethodFactory.html#adc33a01614b4d68d23f9de3200945bfb" title="Create a pointer to a new CNAnalysisMethod object as described in the string specification.">CNAnalysisMethodForString</a>(m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;signal-adjustment-covariates&quot;</span>));
<a name="l01752"></a>01752         am-&gt;setEngine(m_pEngine);
<a name="l01753"></a>01753         am-&gt;setup(*getExperiment(), *getProbeSets());
<a name="l01754"></a>01754         am-&gt;setProbes(*m_pvProbes);
<a name="l01755"></a>01755         am-&gt;run();
<a name="l01756"></a>01756         <span class="keyword">delete</span> am;
<a name="l01757"></a>01757     }
<a name="l01758"></a>01758 }
<a name="l01759"></a>01759 
<a name="l01760"></a>01760 <span class="keywordtype">void</span> CNAnalysisMethodChipstream::adjustAlternateIntensitiesUsingCovariateSignalAdjustment(<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html">affymetrix_fusion_io::FusionCELData</a>&amp; cel, 
<a name="l01761"></a>01761                                                                                           std::vector&lt;float&gt;&amp; adjustedIntensities)
<a name="l01762"></a>01762 {
<a name="l01763"></a>01763     <span class="keywordflow">if</span> (!m_pEngine-&gt;<a class="code" href="classOptions.html#a400b67224caf01af079f1709e0e868f4" title="Check to see if an option is defined.">isOptDefined</a>(<span class="stringliteral">&quot;signal-adjustment-covariates&quot;</span>)) {<span class="keywordflow">return</span>;}
<a name="l01764"></a>01764     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;signal-adjustment-covariates&quot;</span>) == <span class="stringliteral">&quot;none&quot;</span>) {<span class="keywordflow">return</span>;}
<a name="l01765"></a>01765     <span class="keywordflow">if</span> (m_pEngine-&gt;<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;signal-adjustment-covariates&quot;</span>) != <span class="stringliteral">&quot;&quot;</span>)
<a name="l01766"></a>01766     {
<a name="l01767"></a>01767         <span class="keywordtype">int</span> numCells = cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a027ef23b1537af387ac91d2e81496e01">GetRows</a>() * cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a9036f2c16066af20c4058b993eb83fbf">GetCols</a>();
<a name="l01768"></a>01768         adjustedIntensities.resize(numCells);
<a name="l01769"></a>01769         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iProbeIndex = 0; iProbeIndex &lt; numCells; iProbeIndex++)
<a name="l01770"></a>01770         {
<a name="l01771"></a>01771             adjustedIntensities[iProbeIndex] = cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a76d2432b4075dbb9f00a1cf306a3a614">GetIntensity</a>(iProbeIndex);
<a name="l01772"></a>01772         }
<a name="l01773"></a>01773 
<a name="l01774"></a>01774         <a class="code" href="classCNAnalysisMethodCovariateSignalAdjuster.html" title="CNAnalysisMethodCovariateSignalAdjuster - Class for doing covariate-based signal adjustment.">CNAnalysisMethodCovariateSignalAdjuster</a>* pMethod = <span class="keyword">new</span> <a class="code" href="classCNAnalysisMethodCovariateSignalAdjuster.html" title="CNAnalysisMethodCovariateSignalAdjuster - Class for doing covariate-based signal adjustment.">CNAnalysisMethodCovariateSignalAdjuster</a>();
<a name="l01775"></a>01775 
<a name="l01776"></a>01776         pMethod-&gt;setEngine(m_pEngine);
<a name="l01777"></a>01777         pMethod-&gt;setup(*getExperiment(), *getProbeSets());
<a name="l01778"></a>01778         pMethod-&gt;setProbes(*m_pvProbes);
<a name="l01779"></a>01779         pMethod-&gt;setAlternateIntensities(adjustedIntensities);
<a name="l01780"></a>01780         pMethod-&gt;run();
<a name="l01781"></a>01781         <span class="keyword">delete</span> pMethod;
<a name="l01782"></a>01782     }
<a name="l01783"></a>01783 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Jul 15 2014 10:37:38 for Affymetrix Power Tools by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
